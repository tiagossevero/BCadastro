[
{
  "model": "desktop.document2",
  "pk": 164273,
  "fields": {
    "owner": [
      "tsevero"
    ],
    "name": "BCADASTRO: 1 Dados Cadastrais",
    "description": "",
    "uuid": "1dc0324f-4b48-ca6d-c622-fe12c91ec369",
    "type": "query-impala",
    "connector": null,
    "data": "{\"id\": 164273, \"uuid\": \"1dc0324f-4b48-ca6d-c622-fe12c91ec369\", \"name\": \"BCADASTRO: 1 Dados Cadastrais\", \"description\": \"\", \"type\": \"query-impala\", \"initialType\": \"impala\", \"coordinatorUuid\": null, \"isHistory\": false, \"isManaged\": false, \"parentSavedQueryUuid\": \"1dc0324f-4b48-ca6d-c622-fe12c91ec369\", \"isSaved\": true, \"onSuccessUrl\": null, \"pubSubUrl\": null, \"isPresentationModeDefault\": false, \"isPresentationMode\": false, \"isPresentationModeInitialized\": true, \"presentationSnippets\": {}, \"isHidingCode\": false, \"snippets\": [{\"id\": \"bf175cc7-60fb-0e3b-5217-a1723c967755\", \"name\": \"\", \"type\": \"impala\", \"connector\": {\"name\": \"Impala\", \"type\": \"impala\", \"id\": \"impala\", \"displayName\": \"Impala\", \"buttonName\": \"Consulta\", \"tooltip\": \"Impala Query\", \"optimizer\": \"off\", \"page\": \"/editor/?type=impala\", \"is_sql\": true, \"is_batchable\": true, \"dialect\": \"impala\", \"dialect_properties\": {}}, \"isSqlDialect\": true, \"dialect\": \"impala\", \"isBatchable\": true, \"autocompleteSettings\": {\"temporaryOnly\": false}, \"aceCursorPosition\": {\"row\": 290, \"column\": 72}, \"errors\": [], \"aceErrorsHolder\": [], \"aceWarningsHolder\": [], \"aceErrors\": [], \"aceWarnings\": [], \"editorMode\": true, \"dbSelectionVisible\": false, \"showExecutionAnalysis\": false, \"namespace\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"status\": \"CREATED\", \"computes\": [{\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"type\": \"direct\", \"credentials\": {}}]}, \"compute\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"namespace\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"interface\": \"impala\", \"type\": \"direct\", \"options\": {}}, \"database\": \"usr_sat_ods\", \"currentQueryTab\": \"savedQueries\", \"pinnedContextTabs\": [], \"loadingQueries\": false, \"queriesHasErrors\": false, \"queriesCurrentPage\": 1, \"queriesTotalPages\": 3, \"queriesFilter\": \"\", \"queriesFilterVisible\": false, \"statementType\": \"text\", \"statementTypes\": [\"text\", \"file\"], \"statementPath\": \"\", \"externalStatementLoaded\": false, \"associatedDocumentLoading\": true, \"associatedDocumentUuid\": null, \"statement_raw\": \"-- ============================================================================\\r\\n-- SCRIPT 01: CONSOLIDA\\u00c7\\u00c3O CADASTRAL - 100% ADERENTE AO ACL ORIGINAL\\r\\n-- Tempo estimado: 5-8 minutos\\r\\n-- Baseado em: B_CADASTRO_SC (2).txt\\r\\n-- ============================================================================\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 1.1. BASE CNPJ COMPLETA (Matriz + Estabelecimento)\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS gessimples.bcadastro_base_cnpj_completo;\\r\\nCREATE TABLE gessimples.bcadastro_base_cnpj_completo STORED AS PARQUET AS\\r\\nSELECT \\r\\n    -- Identifica\\u00e7\\u00e3o\\r\\n    SUBSTR(ce.cnpj, 1, 8) AS cnpj_raiz,\\r\\n    ce.cnpj AS cnpj_completo,\\r\\n    cm.cnpj AS cnpj_matriz,\\r\\n    \\r\\n    -- Dados cadastrais\\r\\n    cm.nomeempresarial AS razao_social,\\r\\n    ce.nomefantasia AS nome_fantasia,\\r\\n    cm.naturezajuridica AS natureza_juridica_cod,\\r\\n    nj.de_natureza_juridica AS natureza_juridica_desc,\\r\\n    cm.porteempresa AS porte_empresa,\\r\\n    \\r\\n    -- Capital social com tratamento de overflow\\r\\n    CASE \\r\\n        WHEN cm.capitalsocial IS NULL OR cm.capitalsocial = '' THEN NULL\\r\\n        WHEN LENGTH(REGEXP_REPLACE(cm.capitalsocial, '[^0-9]', '')) > 15 THEN NULL\\r\\n        ELSE CAST(CAST(cm.capitalsocial AS DOUBLE) AS DECIMAL(18,2))\\r\\n    END AS capital_social,\\r\\n    \\r\\n    -- Situa\\u00e7\\u00e3o cadastral\\r\\n    ce.situacaocadastral AS situacao_cadastral_cod,\\r\\n    CASE ce.situacaocadastral\\r\\n        WHEN '01' THEN 'NULA'\\r\\n        WHEN '02' THEN 'ATIVA'\\r\\n        WHEN '03' THEN 'SUSPENSA'\\r\\n        WHEN '04' THEN 'INAPTA'\\r\\n        WHEN '08' THEN 'BAIXADA'\\r\\n        ELSE 'OUTROS'\\r\\n    END AS situacao_cadastral_desc,\\r\\n    \\r\\n    -- Datas\\r\\n    CAST(FROM_UNIXTIME(UNIX_TIMESTAMP(ce.datasituacaocadastral, 'yyyyMMdd')) AS DATE) AS dt_sit_cadastral,\\r\\n    CAST(FROM_UNIXTIME(UNIX_TIMESTAMP(ce.datainicioatividade, 'yyyyMMdd')) AS DATE) AS dt_ini_ativ,\\r\\n    CAST(FROM_UNIXTIME(UNIX_TIMESTAMP(cm.datainclusaoresponsavel, 'yyyyMMdd')) AS DATE) AS dt_ini_responsavel,\\r\\n    \\r\\n    -- PA Situa\\u00e7\\u00e3o Cadastral (AAAAMM)\\r\\n    CONCAT(\\r\\n        SUBSTR(ce.datasituacaocadastral, 1, 4),\\r\\n        SUBSTR(ce.datasituacaocadastral, 5, 2)\\r\\n    ) AS pa_sit_cad,\\r\\n    \\r\\n    -- Respons\\u00e1vel\\r\\n    cm.cpfresponsavel AS cpf_responsavel,\\r\\n    cm.qualificacaoresponsavel AS qualificacao_responsavel_cod,\\r\\n    CASE cm.qualificacaoresponsavel\\r\\n        WHEN '5' THEN 'ADM'\\r\\n        WHEN '10' THEN 'DIRETOR'\\r\\n        WHEN '16' THEN 'PRESIDENTE'\\r\\n        WHEN '17' THEN 'PROCURADOR'\\r\\n        WHEN '49' THEN 'SOCIO_ADM'\\r\\n        WHEN '50' THEN 'EMPRESARIO'\\r\\n        WHEN '65' THEN 'TITULAR'\\r\\n        ELSE 'OUTROS'\\r\\n    END AS qualificacao_responsavel_desc,\\r\\n    \\r\\n    -- CNAE\\r\\n    ce.cnaefiscal AS cnae_principal,\\r\\n    \\r\\n    -- Localiza\\u00e7\\u00e3o\\r\\n    ce.uf,\\r\\n    ce.codigomunicipio AS codigo_municipio,\\r\\n    ce.logradouro,\\r\\n    ce.numero AS numero_logradouro,\\r\\n    ce.bairro,\\r\\n    ce.cep,\\r\\n    \\r\\n    -- Flags\\r\\n    CASE WHEN ce.indicadormatriz = '1' THEN 1 ELSE 0 END AS flag_matriz,\\r\\n    \\r\\n    NOW() AS dt_carga\\r\\n    \\r\\nFROM bcadastro.cnpj_estabelecimento ce\\r\\nLEFT JOIN bcadastro.cnpj_matriz cm \\r\\n    ON SUBSTR(ce.cnpj, 1, 8) = cm.cnpj\\r\\nLEFT JOIN bcadastro.natureza_juridica nj \\r\\n    ON CAST(cm.naturezajuridica AS STRING) = CAST(nj.cd_natureza_juridica AS STRING)\\r\\nWHERE ce.uf = 'SC'\\r\\n   OR SUBSTR(ce.cnpj, 1, 8) IN (\\r\\n      SELECT DISTINCT SUBSTR(cnpj, 1, 8)\\r\\n      FROM bcadastro.cnpj_estabelecimento\\r\\n      WHERE uf = 'SC'\\r\\n  );\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 1.2. S\\u00d3CIOS - REPLICANDO L\\u00d3GICA ACL EXATA\\r\\n-- Define TIPO_SOCIO, SOCIO_ou_TITULAR, SOCIO_RESPONSAVEL\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS gessimples.bcadastro_base_socios_raw;\\r\\nCREATE TABLE gessimples.bcadastro_base_socios_raw STORED AS PARQUET AS\\r\\nSELECT\\r\\n    SUBSTR(v.nu_cnpj_empresa_rel, 1, 8) AS cnpj_raiz,\\r\\n    v.nu_cpf_secund AS cpf_socio,\\r\\n    v.nu_cpf_princ AS cpf_responsavel,\\r\\n    v.tp_relacao,\\r\\n    v.nm_relacao,\\r\\n    v.cd_relacao,\\r\\n    v.cd_qualificacao AS qualificacao_cod,\\r\\n    v.nm_qualificacao AS qualificacao_desc,\\r\\n    \\r\\n    -- TIPO_SOCIO (ACL: PJ/PF/SOCIO_ESTRANGEIRO)\\r\\n    CASE \\r\\n        WHEN v.nu_cpf_secund IS NOT NULL THEN 'PF'\\r\\n        WHEN v.nu_cnpj_secund IS NOT NULL THEN 'PJ'\\r\\n        ELSE 'PF'\\r\\n    END AS tipo_socio,\\r\\n    \\r\\n    -- QUALIFIC_SOCIO (ACL)\\r\\n    CASE \\r\\n        WHEN v.cd_qualificacao = 5 THEN 'ADM'\\r\\n        WHEN v.cd_qualificacao = 8 THEN 'CONSELHEIRO_DE_ADM'\\r\\n        WHEN v.cd_qualificacao = 10 THEN 'DIRETOR'\\r\\n        WHEN v.cd_qualificacao = 16 THEN 'PRESIDENTE'\\r\\n        WHEN v.cd_qualificacao = 17 THEN 'PRESIDENTE'\\r\\n        WHEN v.cd_qualificacao = 20 THEN 'SOCIED_CONSORCIADA'\\r\\n        WHEN v.cd_qualificacao = 22 THEN 'SOCIO'\\r\\n        WHEN v.cd_qualificacao = 28 THEN 'SOCIO_GERENTE'\\r\\n        WHEN v.cd_qualificacao = 29 THEN 'SOCIO_INCAPAZ'\\r\\n        WHEN v.cd_qualificacao = 30 THEN 'SOCIO_MENOR'\\r\\n        WHEN v.cd_qualificacao = 31 THEN 'SOCIO_OSTENSIVO'\\r\\n        WHEN v.cd_qualificacao = 37 THEN 'SOCIO_PJ_EX'\\r\\n        WHEN v.cd_qualificacao = 38 THEN 'SOCIO_EX'\\r\\n        WHEN v.cd_qualificacao = 49 THEN 'SOCIO_ADM'\\r\\n        WHEN v.cd_qualificacao = 52 THEN 'SOCIO_C_CAPITAL'\\r\\n        WHEN v.cd_qualificacao = 53 THEN 'SOCIO_S_CAPITAL'\\r\\n        WHEN v.cd_qualificacao = 54 THEN 'FUNDADOR'\\r\\n        WHEN v.cd_qualificacao = 63 THEN 'COTAS_TESOURARIA'\\r\\n        WHEN v.cd_qualificacao = 65 THEN 'TITULAR'\\r\\n        ELSE ''\\r\\n    END AS qualific_socio,\\r\\n    \\r\\n    -- QUALIFIC_RESPONSAVEL (ACL)\\r\\n    CASE \\r\\n        WHEN v.cd_relacao = 1 AND v.cd_qualificacao = 43 THEN 'RESPONSAVEL'\\r\\n        WHEN v.cd_relacao = 1 THEN 'ADM'\\r\\n        ELSE ''\\r\\n    END AS qualific_responsavel,\\r\\n    \\r\\n    -- Datas\\r\\n    CAST(v.dt_inicio_relacao AS DATE) AS dt_ini_socio,\\r\\n    CAST(v.dt_fim_relacao AS DATE) AS dt_fim_relacao,\\r\\n    v.sn_relacao_ativa AS flag_relacao_ativa,\\r\\n    v.pe_capital_empresa AS percentual_capital,\\r\\n    \\r\\n    NOW() AS dt_carga\\r\\n\\r\\nFROM usr_sat_ods.vw_cad_vinculo v\\r\\nWHERE v.nu_cpf_secund IS NOT NULL\\r\\n  AND v.tp_relacao IN ('SOCIO', 'REPRESENTANTE', 'CONTABILISTA')\\r\\n  AND SUBSTR(v.nu_cnpj_empresa_rel, 1, 8) IN (\\r\\n      SELECT DISTINCT cnpj_raiz \\r\\n      FROM gessimples.bcadastro_base_cnpj_completo\\r\\n  );\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 1.3. APLICAR REGRAS ACL: SOCIO_RESPONSAVEL e SOCIO_ou_TITULAR\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS gessimples.bcadastro_base_socios_pf;\\r\\nCREATE TABLE gessimples.bcadastro_base_socios_pf STORED AS PARQUET AS\\r\\nSELECT\\r\\n    cnpj_raiz,\\r\\n    cpf_socio,\\r\\n    cpf_responsavel,\\r\\n    tipo_socio,\\r\\n    qualific_socio,\\r\\n    qualific_responsavel,\\r\\n    \\r\\n    -- SOCIO_RESPONSAVEL (ACL exato)\\r\\n    CASE \\r\\n        WHEN (qualific_socio = 'DIRETOR' AND qualific_responsavel = 'SOCIO_ADM')\\r\\n        THEN 'S'\\r\\n        WHEN (qualific_socio = 'ADM' AND qualific_responsavel = 'SOCIO_ADM')\\r\\n        THEN 'S'\\r\\n        WHEN (qualific_socio = 'ADM' AND qualific_responsavel = 'TITULAR_RESID_EXT')\\r\\n        THEN 'S'\\r\\n        WHEN (qualific_socio = '' AND qualific_responsavel = 'SOCIO_ADM')\\r\\n        THEN 'S'\\r\\n        ELSE 'N'\\r\\n    END AS socio_responsavel,\\r\\n    \\r\\n    -- SOCIO_ou_TITULAR (ACL exato)\\r\\n    CASE \\r\\n        WHEN tipo_socio = 'PF' \\r\\n             AND qualific_socio IN ('SOCIO', 'SOCIO_ADM', 'SOCIO_C_CAPITAL', \\r\\n                                     'SOCIO_EX', 'SOCIO_INCAPAZ', 'SOCIO_MENOR',\\r\\n                                     'SOCIO_S_CAPITAL', 'TITULAR')\\r\\n        THEN 'S'\\r\\n        ELSE 'N'\\r\\n    END AS socio_ou_titular,\\r\\n    \\r\\n    -- Datas\\r\\n    dt_ini_socio,\\r\\n    dt_fim_relacao,\\r\\n    flag_relacao_ativa,\\r\\n    percentual_capital,\\r\\n    dt_carga\\r\\n\\r\\nFROM gessimples.bcadastro_base_socios_raw;\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 1.4. EXTRAIR APENAS S\\u00d3CIOS/TITULARES OU RESPONS\\u00c1VEIS (ACL)\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS gessimples.bcadastro_base_socios_filtrado;\\r\\nCREATE TABLE gessimples.bcadastro_base_socios_filtrado STORED AS PARQUET AS\\r\\nSELECT \\r\\n    cnpj_raiz,\\r\\n    \\r\\n    -- CPF (ACL: prioriza CPF_RESPONSAVEL se SOCIO_RESPONSAVEL = S)\\r\\n    CASE \\r\\n        WHEN socio_responsavel = 'S' THEN cpf_responsavel\\r\\n        ELSE cpf_socio\\r\\n    END AS cpf,\\r\\n    \\r\\n    -- QUALIFICACAO (ACL)\\r\\n    CASE \\r\\n        WHEN socio_ou_titular = 'S' THEN qualific_socio\\r\\n        WHEN socio_responsavel = 'S' THEN qualific_responsavel\\r\\n        ELSE ''\\r\\n    END AS qualificacao,\\r\\n    \\r\\n    -- DT_INI_RESP (ACL: DT_INI_SOCIO se n\\u00e3o for 19000101, sen\\u00e3o DT_INI_RESPONSAVEL)\\r\\n    CASE \\r\\n        WHEN dt_ini_socio IS NOT NULL AND dt_ini_socio != CAST('1900-01-01' AS DATE)\\r\\n             AND socio_ou_titular = 'S'\\r\\n        THEN dt_ini_socio\\r\\n        ELSE dt_ini_socio\\r\\n    END AS dt_ini_resp,\\r\\n    \\r\\n    socio_ou_titular,\\r\\n    socio_responsavel,\\r\\n    tipo_socio,\\r\\n    dt_fim_relacao,\\r\\n    flag_relacao_ativa,\\r\\n    dt_carga\\r\\n\\r\\nFROM gessimples.bcadastro_base_socios_pf\\r\\nWHERE (socio_ou_titular = 'S' AND socio_responsavel = 'N')\\r\\n   OR (socio_ou_titular = 'N' AND socio_responsavel = 'S');\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 1.5. PER\\u00cdODOS SIMPLES NACIONAL - SIMPLIFICADO\\r\\n-- (ACL original explode arrays, aqui assumimos optante se est\\u00e1 na tabela)\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS gessimples.bcadastro_base_periodos_sn;\\r\\nCREATE TABLE gessimples.bcadastro_base_periodos_sn STORED AS PARQUET AS\\r\\nSELECT \\r\\n    SUBSTR(cnpj, 1, 8) AS cnpj_raiz,\\r\\n    CAST('2021-01-01' AS DATE) AS dt_ini_regime,\\r\\n    CAST(NULL AS DATE) AS dt_fim_regime,\\r\\n    '202101' AS periodo_inicio_sn,\\r\\n    CAST(NULL AS STRING) AS periodo_fim_sn,\\r\\n    'ATIVO' AS status_periodo,\\r\\n    NOW() AS dt_carga\\r\\nFROM bcadastro.sn\\r\\nWHERE SUBSTR(cnpj, 1, 8) IN (\\r\\n    SELECT DISTINCT cnpj_raiz \\r\\n    FROM gessimples.bcadastro_base_cnpj_completo\\r\\n);\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 1.6. FILTRAR S\\u00d3CIOS CONFORME REGRA ACL\\r\\n-- Remover: BAIXADA antes de 2020, DT_FIM_REGIME antes de 2020\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS gessimples.bcadastro_base_socios_consolidado;\\r\\nCREATE TABLE gessimples.bcadastro_base_socios_consolidado STORED AS PARQUET AS\\r\\nSELECT \\r\\n    s.cnpj_raiz,\\r\\n    s.cpf,\\r\\n    s.qualificacao,\\r\\n    s.dt_ini_resp,\\r\\n    s.socio_ou_titular,\\r\\n    s.tipo_socio,\\r\\n    \\r\\n    -- JOIN com CNPJ para pegar dados cadastrais\\r\\n    bc.situacao_cadastral_desc AS sit_cadastral,\\r\\n    bc.dt_sit_cadastral,\\r\\n    bc.pa_sit_cad,\\r\\n    bc.dt_ini_ativ,\\r\\n    bc.uf,\\r\\n    bc.razao_social,\\r\\n    \\r\\n    -- JOIN com Per\\u00edodos SN\\r\\n    psn.dt_ini_regime,\\r\\n    psn.dt_fim_regime,\\r\\n    psn.periodo_fim_sn AS pa_fin_sn,\\r\\n    \\r\\n    s.dt_carga\\r\\n\\r\\nFROM gessimples.bcadastro_base_socios_filtrado s\\r\\nINNER JOIN gessimples.bcadastro_base_cnpj_completo bc\\r\\n    ON s.cnpj_raiz = bc.cnpj_raiz\\r\\nLEFT JOIN gessimples.bcadastro_base_periodos_sn psn\\r\\n    ON s.cnpj_raiz = psn.cnpj_raiz\\r\\nWHERE s.tipo_socio = 'PF'\\r\\n  -- REGRA ACL: Remover BAIXADA e encerrados antes de 2020\\r\\n  AND NOT (\\r\\n      (bc.situacao_cadastral_desc = 'BAIXADA' \\r\\n       AND psn.dt_fim_regime = bc.dt_sit_cadastral \\r\\n       AND bc.pa_sit_cad >= '202001')\\r\\n      OR (bc.situacao_cadastral_desc = 'BAIXADA' \\r\\n          AND psn.dt_ini_regime < bc.dt_sit_cadastral \\r\\n          AND psn.dt_fim_regime IS NULL)\\r\\n      OR (psn.dt_fim_regime <= CAST('2019-12-31' AS DATE) \\r\\n          AND psn.dt_fim_regime IS NOT NULL)\\r\\n  );\\r\\n\\r\\n-- Limpar tempor\\u00e1rias\\r\\nDROP TABLE IF EXISTS gessimples.bcadastro_base_socios_raw;\\r\\nDROP TABLE IF EXISTS gessimples.bcadastro_base_socios_pf;\\r\\nDROP TABLE IF EXISTS gessimples.bcadastro_base_socios_filtrado;\\r\\n\\r\\n-- ============================================================================\\r\\n-- VALIDA\\u00c7\\u00d5ES\\r\\n-- ============================================================================\\r\\nSELECT 'CNPJ Completo' AS tabela, COUNT(*) AS total \\r\\nFROM gessimples.bcadastro_base_cnpj_completo\\r\\nUNION ALL\\r\\nSELECT 'S\\u00f3cios Consolidado', COUNT(*) \\r\\nFROM gessimples.bcadastro_base_socios_consolidado\\r\\nUNION ALL\\r\\nSELECT 'Per\\u00edodos SN', COUNT(*) \\r\\nFROM gessimples.bcadastro_base_periodos_sn;\", \"statementsList\": [\"\\r\\nCREATE TABLE gessimples.bcadastro_base_cnpj_completo STORED AS PARQUET AS\\r\\nSELECT \\r\\n    -- Identifica\\u00e7\\u00e3o\\r\\n    SUBSTR(ce.cnpj, 1, 8) AS cnpj_raiz,\\r\\n    ce.cnpj AS cnpj_completo,\\r\\n    cm.cnpj AS cnpj_matriz,\\r\\n    \\r\\n    -- Dados cadastrais\\r\\n    cm.nomeempresarial AS razao_social,\\r\\n    ce.nomefantasia AS nome_fantasia,\\r\\n    cm.naturezajuridica AS natureza_juridica_cod,\\r\\n    nj.de_natureza_juridica AS natureza_juridica_desc,\\r\\n    cm.porteempresa AS porte_empresa,\\r\\n    \\r\\n    -- Capital social com tratamento de overflow\\r\\n    CASE \\r\\n        WHEN cm.capitalsocial IS NULL OR cm.capitalsocial = '' THEN NULL\\r\\n        WHEN LENGTH(REGEXP_REPLACE(cm.capitalsocial, '[^0-9]', '')) > 15 THEN NULL\\r\\n        ELSE CAST(CAST(cm.capitalsocial AS DOUBLE) AS DECIMAL(18,2))\\r\\n    END AS capital_social,\\r\\n    \\r\\n    -- Situa\\u00e7\\u00e3o cadastral\\r\\n    ce.situacaocadastral AS situacao_cadastral_cod,\\r\\n    CASE ce.situacaocadastral\\r\\n        WHEN '01' THEN 'NULA'\\r\\n        WHEN '02' THEN 'ATIVA'\\r\\n        WHEN '03' THEN 'SUSPENSA'\\r\\n        WHEN '04' THEN 'INAPTA'\\r\\n        WHEN '08' THEN 'BAIXADA'\\r\\n        ELSE 'OUTROS'\\r\\n    END AS situacao_cadastral_desc,\\r\\n    \\r\\n    -- Datas\\r\\n    CAST(FROM_UNIXTIME(UNIX_TIMESTAMP(ce.datasituacaocadastral, 'yyyyMMdd')) AS DATE) AS dt_sit_cadastral,\\r\\n    CAST(FROM_UNIXTIME(UNIX_TIMESTAMP(ce.datainicioatividade, 'yyyyMMdd')) AS DATE) AS dt_ini_ativ,\\r\\n    CAST(FROM_UNIXTIME(UNIX_TIMESTAMP(cm.datainclusaoresponsavel, 'yyyyMMdd')) AS DATE) AS dt_ini_responsavel,\\r\\n    \\r\\n    -- PA Situa\\u00e7\\u00e3o Cadastral (AAAAMM)\\r\\n    CONCAT(\\r\\n        SUBSTR(ce.datasituacaocadastral, 1, 4),\\r\\n        SUBSTR(ce.datasituacaocadastral, 5, 2)\\r\\n    ) AS pa_sit_cad,\\r\\n    \\r\\n    -- Respons\\u00e1vel\\r\\n    cm.cpfresponsavel AS cpf_responsavel,\\r\\n    cm.qualificacaoresponsavel AS qualificacao_responsavel_cod,\\r\\n    CASE cm.qualificacaoresponsavel\\r\\n        WHEN '5' THEN 'ADM'\\r\\n        WHEN '10' THEN 'DIRETOR'\\r\\n        WHEN '16' THEN 'PRESIDENTE'\\r\\n        WHEN '17' THEN 'PROCURADOR'\\r\\n        WHEN '49' THEN 'SOCIO_ADM'\\r\\n        WHEN '50' THEN 'EMPRESARIO'\\r\\n        WHEN '65' THEN 'TITULAR'\\r\\n        ELSE 'OUTROS'\\r\\n    END AS qualificacao_responsavel_desc,\\r\\n    \\r\\n    -- CNAE\\r\\n    ce.cnaefiscal AS cnae_principal,\\r\\n    \\r\\n    -- Localiza\\u00e7\\u00e3o\\r\\n    ce.uf,\\r\\n    ce.codigomunicipio AS codigo_municipio,\\r\\n    ce.logradouro,\\r\\n    ce.numero AS numero_logradouro,\\r\\n    ce.bairro,\\r\\n    ce.cep,\\r\\n    \\r\\n    -- Flags\\r\\n    CASE WHEN ce.indicadormatriz = '1' THEN 1 ELSE 0 END AS flag_matriz,\\r\\n    \\r\\n    NOW() AS dt_carga\\r\\n    \\r\\nFROM bcadastro.cnpj_estabelecimento ce\\r\\nLEFT JOIN bcadastro.cnpj_matriz cm \\r\\n    ON SUBSTR(ce.cnpj, 1, 8) = cm.cnpj\\r\\nLEFT JOIN bcadastro.natureza_juridica nj \\r\\n    ON CAST(cm.naturezajuridica AS STRING) = CAST(nj.cd_natureza_juridica AS STRING)\\r\\nWHERE ce.uf = 'SC'\\r\\n   OR SUBSTR(ce.cnpj, 1, 8) IN (\\r\\n      SELECT DISTINCT SUBSTR(cnpj, 1, 8)\\r\\n      FROM bcadastro.cnpj_estabelecimento\\r\\n      WHERE uf = 'SC'\\r\\n  );\", \"\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 1.2. S\\u00d3CIOS - REPLICANDO L\\u00d3GICA ACL EXATA\\r\\n-- Define TIPO_SOCIO, SOCIO_ou_TITULAR, SOCIO_RESPONSAVEL\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS gessimples.bcadastro_base_socios_raw;\", \"\\r\\nCREATE TABLE gessimples.bcadastro_base_socios_raw STORED AS PARQUET AS\\r\\nSELECT\\r\\n    SUBSTR(v.nu_cnpj_empresa_rel, 1, 8) AS cnpj_raiz,\\r\\n    v.nu_cpf_secund AS cpf_socio,\\r\\n    v.nu_cpf_princ AS cpf_responsavel,\\r\\n    v.tp_relacao,\\r\\n    v.nm_relacao,\\r\\n    v.cd_relacao,\\r\\n    v.cd_qualificacao AS qualificacao_cod,\\r\\n    v.nm_qualificacao AS qualificacao_desc,\\r\\n    \\r\\n    -- TIPO_SOCIO (ACL: PJ/PF/SOCIO_ESTRANGEIRO)\\r\\n    CASE \\r\\n        WHEN v.nu_cpf_secund IS NOT NULL THEN 'PF'\\r\\n        WHEN v.nu_cnpj_secund IS NOT NULL THEN 'PJ'\\r\\n        ELSE 'PF'\\r\\n    END AS tipo_socio,\\r\\n    \\r\\n    -- QUALIFIC_SOCIO (ACL)\\r\\n    CASE \\r\\n        WHEN v.cd_qualificacao = 5 THEN 'ADM'\\r\\n        WHEN v.cd_qualificacao = 8 THEN 'CONSELHEIRO_DE_ADM'\\r\\n        WHEN v.cd_qualificacao = 10 THEN 'DIRETOR'\\r\\n        WHEN v.cd_qualificacao = 16 THEN 'PRESIDENTE'\\r\\n        WHEN v.cd_qualificacao = 17 THEN 'PRESIDENTE'\\r\\n        WHEN v.cd_qualificacao = 20 THEN 'SOCIED_CONSORCIADA'\\r\\n        WHEN v.cd_qualificacao = 22 THEN 'SOCIO'\\r\\n        WHEN v.cd_qualificacao = 28 THEN 'SOCIO_GERENTE'\\r\\n        WHEN v.cd_qualificacao = 29 THEN 'SOCIO_INCAPAZ'\\r\\n        WHEN v.cd_qualificacao = 30 THEN 'SOCIO_MENOR'\\r\\n        WHEN v.cd_qualificacao = 31 THEN 'SOCIO_OSTENSIVO'\\r\\n        WHEN v.cd_qualificacao = 37 THEN 'SOCIO_PJ_EX'\\r\\n        WHEN v.cd_qualificacao = 38 THEN 'SOCIO_EX'\\r\\n        WHEN v.cd_qualificacao = 49 THEN 'SOCIO_ADM'\\r\\n        WHEN v.cd_qualificacao = 52 THEN 'SOCIO_C_CAPITAL'\\r\\n        WHEN v.cd_qualificacao = 53 THEN 'SOCIO_S_CAPITAL'\\r\\n        WHEN v.cd_qualificacao = 54 THEN 'FUNDADOR'\\r\\n        WHEN v.cd_qualificacao = 63 THEN 'COTAS_TESOURARIA'\\r\\n        WHEN v.cd_qualificacao = 65 THEN 'TITULAR'\\r\\n        ELSE ''\\r\\n    END AS qualific_socio,\\r\\n    \\r\\n    -- QUALIFIC_RESPONSAVEL (ACL)\\r\\n    CASE \\r\\n        WHEN v.cd_relacao = 1 AND v.cd_qualificacao = 43 THEN 'RESPONSAVEL'\\r\\n        WHEN v.cd_relacao = 1 THEN 'ADM'\\r\\n        ELSE ''\\r\\n    END AS qualific_responsavel,\\r\\n    \\r\\n    -- Datas\\r\\n    CAST(v.dt_inicio_relacao AS DATE) AS dt_ini_socio,\\r\\n    CAST(v.dt_fim_relacao AS DATE) AS dt_fim_relacao,\\r\\n    v.sn_relacao_ativa AS flag_relacao_ativa,\\r\\n    v.pe_capital_empresa AS percentual_capital,\\r\\n    \\r\\n    NOW() AS dt_carga\\r\\n\\r\\nFROM usr_sat_ods.vw_cad_vinculo v\\r\\nWHERE v.nu_cpf_secund IS NOT NULL\\r\\n  AND v.tp_relacao IN ('SOCIO', 'REPRESENTANTE', 'CONTABILISTA')\\r\\n  AND SUBSTR(v.nu_cnpj_empresa_rel, 1, 8) IN (\\r\\n      SELECT DISTINCT cnpj_raiz \\r\\n      FROM gessimples.bcadastro_base_cnpj_completo\\r\\n  );\", \"\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 1.3. APLICAR REGRAS ACL: SOCIO_RESPONSAVEL e SOCIO_ou_TITULAR\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS gessimples.bcadastro_base_socios_pf;\", \"\\r\\nCREATE TABLE gessimples.bcadastro_base_socios_pf STORED AS PARQUET AS\\r\\nSELECT\\r\\n    cnpj_raiz,\\r\\n    cpf_socio,\\r\\n    cpf_responsavel,\\r\\n    tipo_socio,\\r\\n    qualific_socio,\\r\\n    qualific_responsavel,\\r\\n    \\r\\n    -- SOCIO_RESPONSAVEL (ACL exato)\\r\\n    CASE \\r\\n        WHEN (qualific_socio = 'DIRETOR' AND qualific_responsavel = 'SOCIO_ADM')\\r\\n        THEN 'S'\\r\\n        WHEN (qualific_socio = 'ADM' AND qualific_responsavel = 'SOCIO_ADM')\\r\\n        THEN 'S'\\r\\n        WHEN (qualific_socio = 'ADM' AND qualific_responsavel = 'TITULAR_RESID_EXT')\\r\\n        THEN 'S'\\r\\n        WHEN (qualific_socio = '' AND qualific_responsavel = 'SOCIO_ADM')\\r\\n        THEN 'S'\\r\\n        ELSE 'N'\\r\\n    END AS socio_responsavel,\\r\\n    \\r\\n    -- SOCIO_ou_TITULAR (ACL exato)\\r\\n    CASE \\r\\n        WHEN tipo_socio = 'PF' \\r\\n             AND qualific_socio IN ('SOCIO', 'SOCIO_ADM', 'SOCIO_C_CAPITAL', \\r\\n                                     'SOCIO_EX', 'SOCIO_INCAPAZ', 'SOCIO_MENOR',\\r\\n                                     'SOCIO_S_CAPITAL', 'TITULAR')\\r\\n        THEN 'S'\\r\\n        ELSE 'N'\\r\\n    END AS socio_ou_titular,\\r\\n    \\r\\n    -- Datas\\r\\n    dt_ini_socio,\\r\\n    dt_fim_relacao,\\r\\n    flag_relacao_ativa,\\r\\n    percentual_capital,\\r\\n    dt_carga\\r\\n\\r\\nFROM gessimples.bcadastro_base_socios_raw;\", \"\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 1.4. EXTRAIR APENAS S\\u00d3CIOS/TITULARES OU RESPONS\\u00c1VEIS (ACL)\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS gessimples.bcadastro_base_socios_filtrado;\", \"\\r\\nCREATE TABLE gessimples.bcadastro_base_socios_filtrado STORED AS PARQUET AS\\r\\nSELECT \\r\\n    cnpj_raiz,\\r\\n    \\r\\n    -- CPF (ACL: prioriza CPF_RESPONSAVEL se SOCIO_RESPONSAVEL = S)\\r\\n    CASE \\r\\n        WHEN socio_responsavel = 'S' THEN cpf_responsavel\\r\\n        ELSE cpf_socio\\r\\n    END AS cpf,\\r\\n    \\r\\n    -- QUALIFICACAO (ACL)\\r\\n    CASE \\r\\n        WHEN socio_ou_titular = 'S' THEN qualific_socio\\r\\n        WHEN socio_responsavel = 'S' THEN qualific_responsavel\\r\\n        ELSE ''\\r\\n    END AS qualificacao,\\r\\n    \\r\\n    -- DT_INI_RESP (ACL: DT_INI_SOCIO se n\\u00e3o for 19000101, sen\\u00e3o DT_INI_RESPONSAVEL)\\r\\n    CASE \\r\\n        WHEN dt_ini_socio IS NOT NULL AND dt_ini_socio != CAST('1900-01-01' AS DATE)\\r\\n             AND socio_ou_titular = 'S'\\r\\n        THEN dt_ini_socio\\r\\n        ELSE dt_ini_socio\\r\\n    END AS dt_ini_resp,\\r\\n    \\r\\n    socio_ou_titular,\\r\\n    socio_responsavel,\\r\\n    tipo_socio,\\r\\n    dt_fim_relacao,\\r\\n    flag_relacao_ativa,\\r\\n    dt_carga\\r\\n\\r\\nFROM gessimples.bcadastro_base_socios_pf\\r\\nWHERE (socio_ou_titular = 'S' AND socio_responsavel = 'N')\\r\\n   OR (socio_ou_titular = 'N' AND socio_responsavel = 'S');\", \"\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 1.5. PER\\u00cdODOS SIMPLES NACIONAL - SIMPLIFICADO\\r\\n-- (ACL original explode arrays, aqui assumimos optante se est\\u00e1 na tabela)\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS gessimples.bcadastro_base_periodos_sn;\", \"\\r\\nCREATE TABLE gessimples.bcadastro_base_periodos_sn STORED AS PARQUET AS\\r\\nSELECT \\r\\n    SUBSTR(cnpj, 1, 8) AS cnpj_raiz,\\r\\n    CAST('2021-01-01' AS DATE) AS dt_ini_regime,\\r\\n    CAST(NULL AS DATE) AS dt_fim_regime,\\r\\n    '202101' AS periodo_inicio_sn,\\r\\n    CAST(NULL AS STRING) AS periodo_fim_sn,\\r\\n    'ATIVO' AS status_periodo,\\r\\n    NOW() AS dt_carga\\r\\nFROM bcadastro.sn\\r\\nWHERE SUBSTR(cnpj, 1, 8) IN (\\r\\n    SELECT DISTINCT cnpj_raiz \\r\\n    FROM gessimples.bcadastro_base_cnpj_completo\\r\\n);\", \"\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 1.6. FILTRAR S\\u00d3CIOS CONFORME REGRA ACL\\r\\n-- Remover: BAIXADA antes de 2020, DT_FIM_REGIME antes de 2020\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS gessimples.bcadastro_base_socios_consolidado;\", \"\\r\\nCREATE TABLE gessimples.bcadastro_base_socios_consolidado STORED AS PARQUET AS\\r\\nSELECT \\r\\n    s.cnpj_raiz,\\r\\n    s.cpf,\\r\\n    s.qualificacao,\\r\\n    s.dt_ini_resp,\\r\\n    s.socio_ou_titular,\\r\\n    s.tipo_socio,\\r\\n    \\r\\n    -- JOIN com CNPJ para pegar dados cadastrais\\r\\n    bc.situacao_cadastral_desc AS sit_cadastral,\\r\\n    bc.dt_sit_cadastral,\\r\\n    bc.pa_sit_cad,\\r\\n    bc.dt_ini_ativ,\\r\\n    bc.uf,\\r\\n    bc.razao_social,\\r\\n    \\r\\n    -- JOIN com Per\\u00edodos SN\\r\\n    psn.dt_ini_regime,\\r\\n    psn.dt_fim_regime,\\r\\n    psn.periodo_fim_sn AS pa_fin_sn,\\r\\n    \\r\\n    s.dt_carga\\r\\n\\r\\nFROM gessimples.bcadastro_base_socios_filtrado s\\r\\nINNER JOIN gessimples.bcadastro_base_cnpj_completo bc\\r\\n    ON s.cnpj_raiz = bc.cnpj_raiz\\r\\nLEFT JOIN gessimples.bcadastro_base_periodos_sn psn\\r\\n    ON s.cnpj_raiz = psn.cnpj_raiz\\r\\nWHERE s.tipo_socio = 'PF'\\r\\n  -- REGRA ACL: Remover BAIXADA e encerrados antes de 2020\\r\\n  AND NOT (\\r\\n      (bc.situacao_cadastral_desc = 'BAIXADA' \\r\\n       AND psn.dt_fim_regime = bc.dt_sit_cadastral \\r\\n       AND bc.pa_sit_cad >= '202001')\\r\\n      OR (bc.situacao_cadastral_desc = 'BAIXADA' \\r\\n          AND psn.dt_ini_regime < bc.dt_sit_cadastral \\r\\n          AND psn.dt_fim_regime IS NULL)\\r\\n      OR (psn.dt_fim_regime <= CAST('2019-12-31' AS DATE) \\r\\n          AND psn.dt_fim_regime IS NOT NULL)\\r\\n  );\", \"\\r\\n\\r\\n-- Limpar tempor\\u00e1rias\\r\\nDROP TABLE IF EXISTS gessimples.bcadastro_base_socios_raw;\", \"\\r\\nDROP TABLE IF EXISTS gessimples.bcadastro_base_socios_pf;\", \"\\r\\nDROP TABLE IF EXISTS gessimples.bcadastro_base_socios_filtrado;\", \"\\r\\n\\r\\n-- ============================================================================\\r\\n-- VALIDA\\u00c7\\u00d5ES\\r\\n-- ============================================================================\\r\\nSELECT 'CNPJ Completo' AS tabela, COUNT(*) AS total \\r\\nFROM gessimples.bcadastro_base_cnpj_completo\\r\\nUNION ALL\\r\\nSELECT 'S\\u00f3cios Consolidado', COUNT(*) \\r\\nFROM gessimples.bcadastro_base_socios_consolidado\\r\\nUNION ALL\\r\\nSELECT 'Per\\u00edodos SN', COUNT(*) \\r\\nFROM gessimples.bcadastro_base_periodos_sn;\"], \"aceSize\": 100, \"status\": \"ready\", \"statusForButtons\": \"executed\", \"properties\": {\"settings\": []}, \"viewSettings\": {\"placeHolder\": \"Exemplo: SELECT * FROM tablename ou pressione CTRL + espa\\u00e7o\", \"sqlDialect\": true}, \"variables\": [], \"hasCurlyBracketParameters\": true, \"variableNames\": [], \"variableValues\": {}, \"statement\": \"\\r\\nCREATE TABLE gessimples.bcadastro_base_socios_consolidado STORED AS PARQUET AS\\r\\nSELECT \\r\\n    s.cnpj_raiz,\\r\\n    s.cpf,\\r\\n    s.qualificacao,\\r\\n    s.dt_ini_resp,\\r\\n    s.socio_ou_titular,\\r\\n    s.tipo_socio,\\r\\n    \\r\\n    -- JOIN com CNPJ para pegar dados cadastrais\\r\\n    bc.situacao_cadastral_desc AS sit_cadastral,\\r\\n    bc.dt_sit_cadastral,\\r\\n    bc.pa_sit_cad,\\r\\n    bc.dt_ini_ativ,\\r\\n    bc.uf,\\r\\n    bc.razao_social,\\r\\n    \\r\\n    -- JOIN com Per\\u00edodos SN\\r\\n    psn.dt_ini_regime,\\r\\n    psn.dt_fim_regime,\\r\\n    psn.periodo_fim_sn AS pa_fin_sn,\\r\\n    \\r\\n    s.dt_carga\\r\\n\\r\\nFROM gessimples.bcadastro_base_socios_filtrado s\\r\\nINNER JOIN gessimples.bcadastro_base_cnpj_completo bc\\r\\n    ON s.cnpj_raiz = bc.cnpj_raiz\\r\\nLEFT JOIN gessimples.bcadastro_base_periodos_sn psn\\r\\n    ON s.cnpj_raiz = psn.cnpj_raiz\\r\\nWHERE s.tipo_socio = 'PF'\\r\\n  -- REGRA ACL: Remover BAIXADA e encerrados antes de 2020\\r\\n  AND NOT (\\r\\n      (bc.situacao_cadastral_desc = 'BAIXADA' \\r\\n       AND psn.dt_fim_regime = bc.dt_sit_cadastral \\r\\n       AND bc.pa_sit_cad >= '202001')\\r\\n      OR (bc.situacao_cadastral_desc = 'BAIXADA' \\r\\n          AND psn.dt_ini_regime < bc.dt_sit_cadastral \\r\\n          AND psn.dt_fim_regime IS NULL)\\r\\n      OR (psn.dt_fim_regime <= CAST('2019-12-31' AS DATE) \\r\\n          AND psn.dt_fim_regime IS NOT NULL)\\r\\n  );\", \"result\": {\"id\": \"79dbdb76-7329-78a8-9525-957584a11be4\", \"type\": \"table\", \"hasResultset\": true, \"handle\": {\"secret\": \"ZkzCSIWcQquLQdrD03RQCA==\", \"guid\": \"i+l8yvbsRV0AAAAABYvJPQ==\", \"operation_type\": 0, \"has_result_set\": true, \"modified_row_count\": null, \"log_context\": null, \"session_guid\": \"ee46ad9b04e4a764:3a1602c450f55a8c\", \"session_id\": 21605, \"session_type\": \"impala\", \"statement_id\": 1, \"has_more_statements\": false, \"statements_count\": 2, \"previous_statement_hash\": \"bbf5e1cc50e92f5bc024cf75ad18dcdfd6347afa70688cf5a62ec6d9\", \"start\": {\"row\": 1, \"column\": 0}, \"end\": {\"row\": 1, \"column\": 56}, \"statement\": \"DROP TABLE IF EXISTS gessimples.feitoza_temp_sn_exploded\"}, \"meta\": [], \"rows\": \"1\", \"hasMore\": false, \"statement_id\": 1, \"statement_range\": {\"start\": {\"row\": 1, \"column\": 0}, \"end\": {\"row\": 1, \"column\": 56}}, \"statements_count\": 1, \"previous_statement_hash\": null, \"metaFilter\": {\"query\": \"\", \"facets\": {}, \"text\": []}, \"isMetaFilterVisible\": false, \"filteredMetaChecked\": true, \"filteredColumnCount\": -1, \"filteredMeta\": [], \"fetchedOnce\": false, \"startTime\": \"2025-10-14T21:22:57.504Z\", \"endTime\": \"2025-10-14T21:22:57.691Z\", \"executionTime\": 187, \"data\": [], \"explanation\": \"\", \"logs\": \"\", \"logLines\": 0, \"hasSomeResults\": false}, \"showGrid\": true, \"showChart\": false, \"showLogs\": true, \"progress\": 0, \"jobs\": [], \"executeNextTimeout\": -1, \"isLoading\": false, \"resultsKlass\": \"results impala\", \"errorsKlass\": \"results impala alert alert-error\", \"is_redacted\": false, \"chartType\": \"bars\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null, \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartLimits\": [5, 10, 25, 50, 100], \"chartLimit\": null, \"chartX\": \"summary\", \"chartXPivot\": null, \"chartYSingle\": null, \"chartYMulti\": [], \"chartData\": [], \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"hideStacked\": true, \"hasDataForChart\": false, \"previousChartOptions\": {\"chartLimit\": null, \"chartX\": \"summary\", \"chartXPivot\": null, \"chartYSingle\": null, \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"chartYMulti\": [], \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null}, \"isResultSettingsVisible\": false, \"settingsVisible\": false, \"checkStatusTimeout\": null, \"getLogsTimeout\": null, \"topRisk\": null, \"suggestion\": \"\", \"hasSuggestion\": null, \"compatibilityCheckRunning\": false, \"compatibilitySourcePlatforms\": [{\"name\": \"Teradata\", \"value\": \"teradata\"}, {\"name\": \"Oracle\", \"value\": \"oracle\"}, {\"name\": \"Netezza\", \"value\": \"netezza\"}, {\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}, {\"name\": \"DB2\", \"value\": \"db2\"}, {\"name\": \"Greenplum\", \"value\": \"greenplum\"}, {\"name\": \"MySQL\", \"value\": \"mysql\"}, {\"name\": \"PostgreSQL\", \"value\": \"postgresql\"}, {\"name\": \"Informix\", \"value\": \"informix\"}, {\"name\": \"SQL Server\", \"value\": \"sqlserver\"}, {\"name\": \"Sybase\", \"value\": \"sybase\"}, {\"name\": \"Access\", \"value\": \"access\"}, {\"name\": \"Firebird\", \"value\": \"firebird\"}, {\"name\": \"ANSISQL\", \"value\": \"ansisql\"}, {\"name\": \"Generic\", \"value\": \"generic\"}], \"compatibilitySourcePlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"compatibilityTargetPlatforms\": [{\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}], \"compatibilityTargetPlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"showSqlAnalyzer\": false, \"wasBatchExecuted\": false, \"isReady\": true, \"lastExecuted\": 1760476977267, \"lastAceSelectionRowOffset\": 276, \"executingBlockingOperation\": null, \"showLongOperationWarning\": false, \"formatEnabled\": true, \"isFetchingData\": false, \"isCanceling\": false, \"aceAutoExpand\": false}], \"selectedSnippet\": \"impala\", \"creatingSessionLocks\": [], \"sessions\": [], \"directoryUuid\": \"\", \"dependentsCoordinator\": [], \"historyFilter\": \"\", \"historyFilterVisible\": false, \"loadingHistory\": false, \"historyInitialHeight\": 78, \"forceHistoryInitialHeight\": false, \"historyCurrentPage\": 1, \"historyTotalPages\": 151, \"schedulerViewModel\": null, \"schedulerViewModelIsLoaded\": false, \"isBatchable\": true, \"isExecutingAll\": false, \"executingAllIndex\": 0, \"retryModalConfirm\": null, \"retryModalCancel\": null, \"canSave\": true, \"unloaded\": false, \"updateHistoryFailed\": false, \"viewSchedulerId\": \"\", \"loadingScheduler\": false, \"is_history\": false}",
    "extra": "",
    "search": "-- ============================================================================\r\n-- SCRIPT 01: CONSOLIDAÇÃO CADASTRAL - 100% ADERENTE AO ACL ORIGINAL\r\n-- Tempo estimado: 5-8 minutos\r\n-- Baseado em: B_CADASTRO_SC (2).txt\r\n-- ============================================================================\r\n\r\n-- ----------------------------------------------------------------------------\r\n-- 1.1. BASE CNPJ COMPLETA (Matriz + Estabelecimento)\r\n-- ----------------------------------------------------------------------------\r\nDROP TABLE IF EXISTS gessimples.bcadastro_base_cnpj_completo;\r\nCREATE TABLE gessimples.bcadastro_base_cnpj_completo STORED AS PARQUET AS\r\nSELECT \r\n    -- Identificação\r\n    SUBSTR(ce.cnpj, 1, 8) AS cnpj_raiz,\r\n    ce.cnpj AS cnpj_completo,\r\n    cm.cnpj AS cnpj_matriz,\r\n    \r\n    -- Dados cadastrais\r\n    cm.nomeempresarial AS razao_social,\r\n    ce.nomefantasia AS nome_fantasia,\r\n    cm.naturezajuridica AS natureza_juridica_cod,\r\n    nj.de_natureza_juridica AS natureza_juridica_desc,\r\n    cm.porteempresa AS porte_empresa,\r\n    \r\n    -- Capital social com tratamento de overflow\r\n    CASE \r\n        WHEN cm.capitalsocial IS NULL OR cm.capitalsocial = '' THEN NULL\r\n        WHEN LENGTH(REGEXP_REPLACE(cm.capitalsocial, '[^0-9]', '')) > 15 THEN NULL\r\n        ELSE CAST(CAST(cm.capitalsocial AS DOUBLE) AS DECIMAL(18,2))\r\n    END AS capital_social,\r\n    \r\n    -- Situação cadastral\r\n    ce.situacaocadastral AS situacao_cadastral_cod,\r\n    CASE ce.situacaocadastral\r\n        WHEN '01' THEN 'NULA'\r\n        WHEN '02' THEN 'ATIVA'\r\n        WHEN '03' THEN 'SUSPENSA'\r\n        WHEN '04' THEN 'INAPTA'\r\n        WHEN '08' THEN 'BAIXADA'\r\n        ELSE 'OUTROS'\r\n    END AS situacao_cadastral_desc,\r\n    \r\n    -- Datas\r\n    CAST(FROM_UNIXTIME(UNIX_TIMESTAMP(ce.datasituacaocadastral, 'yyyyMMdd')) AS DATE) AS dt_sit_cadastral,\r\n    CAST(FROM_UNIXTIME(UNIX_TIMESTAMP(ce.datainicioatividade, 'yyyyMMdd')) AS DATE) AS dt_ini_ativ,\r\n    CAST(FROM_UNIXTIME(UNIX_TIMESTAMP(cm.datainclusaorespo",
    "last_modified": "2025-10-21T09:08:26.563",
    "version": 1,
    "is_history": false,
    "is_managed": false,
    "is_trashed": false,
    "parent_directory": [
      "38597e6c-aa1b-4e22-9133-e97cdfaf3585",
      1,
      false
    ],
    "dependencies": []
  }
},
{
  "model": "desktop.document2",
  "pk": 164276,
  "fields": {
    "owner": [
      "tsevero"
    ],
    "name": "BCADASTRO: 2 RBA",
    "description": "",
    "uuid": "873a4f87-d0b6-fc1d-3715-f6624826cea5",
    "type": "query-impala",
    "connector": null,
    "data": "{\"id\": 164276, \"uuid\": \"84151a7f-c12e-4d01-9dcb-755249dc148a\", \"name\": \"BCADASTRO: 2 RBA\", \"description\": \"\", \"type\": \"query-impala\", \"initialType\": \"impala\", \"coordinatorUuid\": null, \"isHistory\": false, \"isManaged\": false, \"parentSavedQueryUuid\": \"873a4f87-d0b6-fc1d-3715-f6624826cea5\", \"isSaved\": true, \"onSuccessUrl\": null, \"pubSubUrl\": null, \"isPresentationModeDefault\": false, \"isPresentationMode\": false, \"isPresentationModeInitialized\": true, \"presentationSnippets\": {}, \"isHidingCode\": false, \"snippets\": [{\"id\": \"cd11bc5c-a7af-3d8e-7eb4-2cba49413867\", \"name\": \"\", \"type\": \"impala\", \"connector\": {\"name\": \"Impala\", \"type\": \"impala\", \"id\": \"impala\", \"displayName\": \"Impala\", \"buttonName\": \"Consulta\", \"tooltip\": \"Impala Query\", \"optimizer\": \"off\", \"page\": \"/editor/?type=impala\", \"is_sql\": true, \"is_batchable\": true, \"dialect\": \"impala\", \"dialect_properties\": {}}, \"isSqlDialect\": true, \"dialect\": \"impala\", \"isBatchable\": true, \"autocompleteSettings\": {\"temporaryOnly\": false}, \"aceCursorPosition\": {\"row\": 148, \"column\": 45}, \"errors\": [], \"aceErrorsHolder\": [], \"aceWarningsHolder\": [], \"aceErrors\": [], \"aceWarnings\": [], \"editorMode\": true, \"dbSelectionVisible\": false, \"showExecutionAnalysis\": true, \"namespace\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"status\": \"CREATED\", \"computes\": [{\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"type\": \"direct\", \"credentials\": {}}]}, \"compute\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"namespace\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"interface\": \"impala\", \"type\": \"direct\", \"options\": {}}, \"database\": \"usr_sat_ods\", \"currentQueryTab\": \"queryResults\", \"pinnedContextTabs\": [], \"loadingQueries\": false, \"queriesHasErrors\": false, \"queriesCurrentPage\": 1, \"queriesTotalPages\": 3, \"queriesFilter\": \"\", \"queriesFilterVisible\": false, \"statementType\": \"text\", \"statementTypes\": [\"text\", \"file\"], \"statementPath\": \"\", \"externalStatementLoaded\": false, \"associatedDocumentLoading\": true, \"associatedDocumentUuid\": null, \"statement_raw\": \"-- ============================================================================\\r\\n-- SCRIPT 02: RBA E GRUPOS ECON\\u00d4MICOS - 100% ADERENTE AO ACL\\r\\n-- Tempo estimado: 10-15 minutos\\r\\n-- Baseado em: L\\u00f3gica de TAB_RAIZ_CPF_PAI do ACL\\r\\n-- ============================================================================\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 2.1. CONSOLIDA\\u00c7\\u00c3O PGDAS-D\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS gessimples.bcadastro_pgdas_consolidado;\\r\\nCREATE TABLE gessimples.bcadastro_pgdas_consolidado STORED AS PARQUET AS\\r\\nSELECT \\r\\n    SUBSTR(nu_cnpj, 1, 8) AS cnpj_raiz,\\r\\n    nu_cnpj AS cnpj_completo,\\r\\n    nu_per_ref AS periodo_apuracao,\\r\\n    CONCAT(\\r\\n        SUBSTR(CAST(nu_per_ref AS STRING), 1, 4),\\r\\n        SUBSTR(CAST(nu_per_ref AS STRING), 5, 2)\\r\\n    ) AS pa,\\r\\n    \\r\\n    -- Receitas\\r\\n    COALESCE(vl_rec_bruta_estab, 0) AS vl_rpa_int,\\r\\n    COALESCE(vl_icms_sc, 0) AS vl_icms,\\r\\n    \\r\\n    -- Para c\\u00e1lculo VL_CT (ACL usa VL_ATIV)\\r\\n    COALESCE(vl_venda, 0) + \\r\\n    COALESCE(vl_venda_st, 0) + \\r\\n    COALESCE(vl_prest_serv_com, 0) + \\r\\n    COALESCE(vl_prest_serv_transp, 0) + \\r\\n    COALESCE(vl_outros, 0) AS vl_ativ,\\r\\n    \\r\\n    sg_uf AS uf,\\r\\n    cd_munic AS codigo_municipio,\\r\\n    \\r\\n    CURRENT_TIMESTAMP() AS dt_carga\\r\\n\\r\\nFROM usr_sat_ods.sna_pgdasd_estabelecimento_raw\\r\\nWHERE nu_per_ref >= 202101\\r\\n  AND nu_per_ref <= 202512\\r\\n  AND (\\r\\n      sg_uf = 'SC'\\r\\n      OR SUBSTR(nu_cnpj, 1, 8) IN (\\r\\n          SELECT DISTINCT cnpj_raiz\\r\\n          FROM gessimples.bcadastro_base_cnpj_completo\\r\\n      )\\r\\n  );\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 2.2. CRIAR TABELA COM CPF + PA (ACL: TAB_TMP_CPF_PA)\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS gessimples.bcadastro_tab_cpf_raiz_pa;\\r\\nCREATE TABLE gessimples.bcadastro_tab_cpf_raiz_pa STORED AS PARQUET AS\\r\\nSELECT DISTINCT\\r\\n    s.cnpj_raiz,\\r\\n    s.cpf,\\r\\n    s.qualificacao,\\r\\n    s.dt_ini_resp,\\r\\n    s.uf,\\r\\n    s.dt_ini_regime AS periodo_ini_sn,\\r\\n    s.dt_fim_regime AS periodo_fim_sn,\\r\\n    s.pa_fin_sn,\\r\\n    \\r\\n    -- Per\\u00edodo de responsabilidade (AAAAMM)\\r\\n    CONCAT(\\r\\n        CAST(YEAR(s.dt_ini_resp) AS STRING),\\r\\n        LPAD(CAST(MONTH(s.dt_ini_resp) AS STRING), 2, '0')\\r\\n    ) AS pa_resp,\\r\\n    \\r\\n    -- Cross join com per\\u00edodos dispon\\u00edveis\\r\\n    p.periodo_apuracao AS pa,\\r\\n    -- p.pa,  <-- REMOVER ESTA LINHA\\r\\n    p.vl_rpa_int,\\r\\n    p.vl_icms,\\r\\n    p.vl_ativ,\\r\\n    \\r\\n    -- REGIME_APUR (ACL)\\r\\n    CASE \\r\\n        WHEN (CAST(CONCAT(\\r\\n                SUBSTR(CAST(p.periodo_apuracao AS STRING), 1, 4), '-',\\r\\n                SUBSTR(CAST(p.periodo_apuracao AS STRING), 5, 2), '-01'\\r\\n             ) AS DATE) <= s.dt_fim_regime \\r\\n             AND s.dt_fim_regime IS NOT NULL)\\r\\n        THEN 'SN'\\r\\n        WHEN (CAST(CONCAT(\\r\\n                SUBSTR(CAST(p.periodo_apuracao AS STRING), 1, 4), '-',\\r\\n                SUBSTR(CAST(p.periodo_apuracao AS STRING), 5, 2), '-01'\\r\\n             ) AS DATE) >= s.dt_ini_regime \\r\\n             AND s.dt_fim_regime IS NULL)\\r\\n        THEN 'SN'\\r\\n        ELSE 'NL'\\r\\n    END AS regime_apur,\\r\\n    \\r\\n    CURRENT_TIMESTAMP() AS dt_carga\\r\\n\\r\\nFROM gessimples.bcadastro_base_socios_consolidado s\\r\\nINNER JOIN gessimples.bcadastro_pgdas_consolidado p\\r\\n    ON s.cnpj_raiz = p.cnpj_raiz\\r\\nWHERE p.periodo_apuracao >= 202101;\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 2.3. FILTRAR APENAS REGIME SIMPLES NACIONAL (ACL)\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS gessimples.bcadastro_tab_cpf_raiz_pa_sn;\\r\\nCREATE TABLE gessimples.bcadastro_tab_cpf_raiz_pa_sn STORED AS PARQUET AS\\r\\nSELECT *\\r\\nFROM gessimples.bcadastro_tab_cpf_raiz_pa\\r\\nWHERE regime_apur = 'SN';\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 2.4. RBA POR CNPJ_RAIZ+CPF+PA (ACL: VL_RBA_PGDAS)\\r\\n-- Usando Window Function para ACUMULADO NO ANO-CALEND\\u00c1RIO (YTD)\\r\\n-- ADERENTE \\u00c0 LEGISLA\\u00c7\\u00c3O: Art. 3\\u00ba, \\u00a7 4\\u00ba, IV\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS gessimples.bcadastro_rba_por_raiz_cpf_pa;\\r\\nCREATE TABLE gessimples.bcadastro_rba_por_raiz_cpf_pa STORED AS PARQUET AS\\r\\nSELECT \\r\\n    cnpj_raiz,\\r\\n    cpf,\\r\\n    pa,\\r\\n    vl_rpa_int,\\r\\n    pa_resp,\\r\\n    qualificacao,\\r\\n    dt_ini_resp AS dt_ini_qualificacao,\\r\\n    periodo_ini_sn,\\r\\n    periodo_fim_sn,\\r\\n    pa_fin_sn,\\r\\n    uf,\\r\\n    vl_icms,\\r\\n    vl_ativ,\\r\\n    \\r\\n    -- ANO de refer\\u00eancia (para facilitar an\\u00e1lises)\\r\\n    CAST(SUBSTR(CAST(pa AS STRING), 1, 4) AS INT) AS ano_ref,\\r\\n    \\r\\n    -- RBA ACUMULADA NO ANO-CALEND\\u00c1RIO (YTD) - CONFORME LEGISLA\\u00c7\\u00c3O\\r\\n    -- Acumula desde janeiro at\\u00e9 o m\\u00eas atual dentro do mesmo ano\\r\\n    SUM(vl_rpa_int) OVER (\\r\\n        PARTITION BY cnpj_raiz, cpf, SUBSTR(CAST(pa AS STRING), 1, 4)\\r\\n        ORDER BY pa\\r\\n    ) AS vl_rba_pgdas,\\r\\n    \\r\\n    -- ICMS acumulado no ano-calend\\u00e1rio\\r\\n    SUM(vl_icms) OVER (\\r\\n        PARTITION BY cnpj_raiz, cpf, SUBSTR(CAST(pa AS STRING), 1, 4)\\r\\n        ORDER BY pa\\r\\n    ) AS vl_icms_ytd,\\r\\n    \\r\\n    CURRENT_TIMESTAMP() AS dt_carga\\r\\n\\r\\nFROM gessimples.bcadastro_tab_cpf_raiz_pa_sn;\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 2.5. CRIAR GRUPOS: CPF COM 2+ CNPJ_RAIZ (ACL: REL_N_GRUPO)\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS gessimples.bcadastro_rel_n_grupo;\\r\\nCREATE TABLE gessimples.bcadastro_rel_n_grupo STORED AS PARQUET AS\\r\\nWITH contagem_por_cpf AS (\\r\\n    SELECT \\r\\n        cpf,\\r\\n        COUNT(DISTINCT cnpj_raiz) AS qte_cnpj\\r\\n    FROM gessimples.bcadastro_tab_cpf_raiz_pa_sn\\r\\n    GROUP BY cpf\\r\\n    HAVING COUNT(DISTINCT cnpj_raiz) >= 2\\r\\n)\\r\\nSELECT \\r\\n    cpf,\\r\\n    qte_cnpj,\\r\\n    ROW_NUMBER() OVER (ORDER BY cpf) AS num_grupo\\r\\nFROM contagem_por_cpf;\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 2.6. ADICIONAR NUM_GRUPO NOS DADOS (ACL: JOIN com REL_N_GRUPO)\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS gessimples.bcadastro_tab_raiz_cpf_pai;\\r\\nCREATE TABLE gessimples.bcadastro_tab_raiz_cpf_pai STORED AS PARQUET AS\\r\\nSELECT \\r\\n    r.*,\\r\\n    g.num_grupo,\\r\\n    g.qte_cnpj\\r\\nFROM gessimples.bcadastro_rba_por_raiz_cpf_pa r\\r\\nINNER JOIN gessimples.bcadastro_rel_n_grupo g\\r\\n    ON r.cpf = g.cpf;\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 2.7. RBA POR CPF+PA (SOMA DE TODOS OS CNPJ_RAIZ DO GRUPO)\\r\\n-- ACL: TAB_CPF_PA_PGDAS_SN\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS gessimples.bcadastro_rba_grupo_cpf_pa;\\r\\nCREATE TABLE gessimples.bcadastro_rba_grupo_cpf_pa STORED AS PARQUET AS\\r\\nSELECT \\r\\n    cpf,\\r\\n    pa,\\r\\n    num_grupo,\\r\\n    qte_cnpj,\\r\\n    pa_resp,\\r\\n    pa_fin_sn,\\r\\n    \\r\\n    -- SOMA RBA DE TODOS OS CNPJ DO CPF\\r\\n    SUM(vl_rba_pgdas) AS vl_rba_grupo,\\r\\n    \\r\\n    -- Soma ICMS\\r\\n    SUM(vl_icms_12m) AS vl_icms_grupo_12m,\\r\\n    \\r\\n    CURRENT_TIMESTAMP() AS dt_carga\\r\\n\\r\\nFROM gessimples.bcadastro_tab_raiz_cpf_pai\\r\\nGROUP BY \\r\\n    cpf,\\r\\n    pa,\\r\\n    num_grupo,\\r\\n    qte_cnpj,\\r\\n    pa_resp,\\r\\n    pa_fin_sn;\\r\\n\\r\\n-- ============================================================================\\r\\n-- VALIDA\\u00c7\\u00d5ES\\r\\n-- ============================================================================\\r\\nSELECT 'PGDAS Consolidado' AS tabela, COUNT(*) AS total\\r\\nFROM gessimples.bcadastro_pgdas_consolidado\\r\\nUNION ALL\\r\\nSELECT 'Tab CPF+RAIZ+PA', COUNT(*)\\r\\nFROM gessimples.bcadastro_tab_cpf_raiz_pa\\r\\nUNION ALL\\r\\nSELECT 'Grupos Identificados', COUNT(DISTINCT num_grupo)\\r\\nFROM gessimples.bcadastro_rel_n_grupo\\r\\nUNION ALL\\r\\nSELECT 'RBA por Grupo+CPF+PA', COUNT(*)\\r\\nFROM gessimples.bcadastro_rba_grupo_cpf_pa;\", \"statementsList\": [\"-- ============================================================================\\r\\n-- SCRIPT 02: RBA E GRUPOS ECON\\u00d4MICOS - 100% ADERENTE AO ACL\\r\\n-- Tempo estimado: 10-15 minutos\\r\\n-- Baseado em: L\\u00f3gica de TAB_RAIZ_CPF_PAI do ACL\\r\\n-- ============================================================================\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 2.1. CONSOLIDA\\u00c7\\u00c3O PGDAS-D\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS gessimples.bcadastro_pgdas_consolidado;\", \"\\r\\nCREATE TABLE gessimples.bcadastro_pgdas_consolidado STORED AS PARQUET AS\\r\\nSELECT \\r\\n    SUBSTR(nu_cnpj, 1, 8) AS cnpj_raiz,\\r\\n    nu_cnpj AS cnpj_completo,\\r\\n    nu_per_ref AS periodo_apuracao,\\r\\n    CONCAT(\\r\\n        SUBSTR(CAST(nu_per_ref AS STRING), 1, 4),\\r\\n        SUBSTR(CAST(nu_per_ref AS STRING), 5, 2)\\r\\n    ) AS pa,\\r\\n    \\r\\n    -- Receitas\\r\\n    COALESCE(vl_rec_bruta_estab, 0) AS vl_rpa_int,\\r\\n    COALESCE(vl_icms_sc, 0) AS vl_icms,\\r\\n    \\r\\n    -- Para c\\u00e1lculo VL_CT (ACL usa VL_ATIV)\\r\\n    COALESCE(vl_venda, 0) + \\r\\n    COALESCE(vl_venda_st, 0) + \\r\\n    COALESCE(vl_prest_serv_com, 0) + \\r\\n    COALESCE(vl_prest_serv_transp, 0) + \\r\\n    COALESCE(vl_outros, 0) AS vl_ativ,\\r\\n    \\r\\n    sg_uf AS uf,\\r\\n    cd_munic AS codigo_municipio,\\r\\n    \\r\\n    CURRENT_TIMESTAMP() AS dt_carga\\r\\n\\r\\nFROM usr_sat_ods.sna_pgdasd_estabelecimento_raw\\r\\nWHERE nu_per_ref >= 202101\\r\\n  AND nu_per_ref <= 202512\\r\\n  AND (\\r\\n      sg_uf = 'SC'\\r\\n      OR SUBSTR(nu_cnpj, 1, 8) IN (\\r\\n          SELECT DISTINCT cnpj_raiz\\r\\n          FROM gessimples.bcadastro_base_cnpj_completo\\r\\n      )\\r\\n  );\", \"\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 2.2. CRIAR TABELA COM CPF + PA (ACL: TAB_TMP_CPF_PA)\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS gessimples.bcadastro_tab_cpf_raiz_pa;\", \"\\r\\nCREATE TABLE gessimples.bcadastro_tab_cpf_raiz_pa STORED AS PARQUET AS\\r\\nSELECT DISTINCT\\r\\n    s.cnpj_raiz,\\r\\n    s.cpf,\\r\\n    s.qualificacao,\\r\\n    s.dt_ini_resp,\\r\\n    s.uf,\\r\\n    s.dt_ini_regime AS periodo_ini_sn,\\r\\n    s.dt_fim_regime AS periodo_fim_sn,\\r\\n    s.pa_fin_sn,\\r\\n    \\r\\n    -- Per\\u00edodo de responsabilidade (AAAAMM)\\r\\n    CONCAT(\\r\\n        CAST(YEAR(s.dt_ini_resp) AS STRING),\\r\\n        LPAD(CAST(MONTH(s.dt_ini_resp) AS STRING), 2, '0')\\r\\n    ) AS pa_resp,\\r\\n    \\r\\n    -- Cross join com per\\u00edodos dispon\\u00edveis\\r\\n    p.periodo_apuracao AS pa,\\r\\n    -- p.pa,  <-- REMOVER ESTA LINHA\\r\\n    p.vl_rpa_int,\\r\\n    p.vl_icms,\\r\\n    p.vl_ativ,\\r\\n    \\r\\n    -- REGIME_APUR (ACL)\\r\\n    CASE \\r\\n        WHEN (CAST(CONCAT(\\r\\n                SUBSTR(CAST(p.periodo_apuracao AS STRING), 1, 4), '-',\\r\\n                SUBSTR(CAST(p.periodo_apuracao AS STRING), 5, 2), '-01'\\r\\n             ) AS DATE) <= s.dt_fim_regime \\r\\n             AND s.dt_fim_regime IS NOT NULL)\\r\\n        THEN 'SN'\\r\\n        WHEN (CAST(CONCAT(\\r\\n                SUBSTR(CAST(p.periodo_apuracao AS STRING), 1, 4), '-',\\r\\n                SUBSTR(CAST(p.periodo_apuracao AS STRING), 5, 2), '-01'\\r\\n             ) AS DATE) >= s.dt_ini_regime \\r\\n             AND s.dt_fim_regime IS NULL)\\r\\n        THEN 'SN'\\r\\n        ELSE 'NL'\\r\\n    END AS regime_apur,\\r\\n    \\r\\n    CURRENT_TIMESTAMP() AS dt_carga\\r\\n\\r\\nFROM gessimples.bcadastro_base_socios_consolidado s\\r\\nINNER JOIN gessimples.bcadastro_pgdas_consolidado p\\r\\n    ON s.cnpj_raiz = p.cnpj_raiz\\r\\nWHERE p.periodo_apuracao >= 202101;\", \"\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 2.3. FILTRAR APENAS REGIME SIMPLES NACIONAL (ACL)\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS gessimples.bcadastro_tab_cpf_raiz_pa_sn;\", \"\\r\\nCREATE TABLE gessimples.bcadastro_tab_cpf_raiz_pa_sn STORED AS PARQUET AS\\r\\nSELECT *\\r\\nFROM gessimples.bcadastro_tab_cpf_raiz_pa\\r\\nWHERE regime_apur = 'SN';\", \"\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 2.4. RBA POR CNPJ_RAIZ+CPF+PA (ACL: VL_RBA_PGDAS)\\r\\n-- Usando Window Function para ACUMULADO NO ANO-CALEND\\u00c1RIO (YTD)\\r\\n-- ADERENTE \\u00c0 LEGISLA\\u00c7\\u00c3O: Art. 3\\u00ba, \\u00a7 4\\u00ba, IV\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS gessimples.bcadastro_rba_por_raiz_cpf_pa;\", \"\\r\\nCREATE TABLE gessimples.bcadastro_rba_por_raiz_cpf_pa STORED AS PARQUET AS\\r\\nSELECT \\r\\n    cnpj_raiz,\\r\\n    cpf,\\r\\n    pa,\\r\\n    vl_rpa_int,\\r\\n    pa_resp,\\r\\n    qualificacao,\\r\\n    dt_ini_resp AS dt_ini_qualificacao,\\r\\n    periodo_ini_sn,\\r\\n    periodo_fim_sn,\\r\\n    pa_fin_sn,\\r\\n    uf,\\r\\n    vl_icms,\\r\\n    vl_ativ,\\r\\n    \\r\\n    -- ANO de refer\\u00eancia (para facilitar an\\u00e1lises)\\r\\n    CAST(SUBSTR(CAST(pa AS STRING), 1, 4) AS INT) AS ano_ref,\\r\\n    \\r\\n    -- RBA ACUMULADA NO ANO-CALEND\\u00c1RIO (YTD) - CONFORME LEGISLA\\u00c7\\u00c3O\\r\\n    -- Acumula desde janeiro at\\u00e9 o m\\u00eas atual dentro do mesmo ano\\r\\n    SUM(vl_rpa_int) OVER (\\r\\n        PARTITION BY cnpj_raiz, cpf, SUBSTR(CAST(pa AS STRING), 1, 4)\\r\\n        ORDER BY pa\\r\\n    ) AS vl_rba_pgdas,\\r\\n    \\r\\n    -- ICMS acumulado no ano-calend\\u00e1rio\\r\\n    SUM(vl_icms) OVER (\\r\\n        PARTITION BY cnpj_raiz, cpf, SUBSTR(CAST(pa AS STRING), 1, 4)\\r\\n        ORDER BY pa\\r\\n    ) AS vl_icms_ytd,\\r\\n    \\r\\n    CURRENT_TIMESTAMP() AS dt_carga\\r\\n\\r\\nFROM gessimples.bcadastro_tab_cpf_raiz_pa_sn;\", \"\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 2.5. CRIAR GRUPOS: CPF COM 2+ CNPJ_RAIZ (ACL: REL_N_GRUPO)\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS gessimples.bcadastro_rel_n_grupo;\", \"\\r\\nCREATE TABLE gessimples.bcadastro_rel_n_grupo STORED AS PARQUET AS\\r\\nWITH contagem_por_cpf AS (\\r\\n    SELECT \\r\\n        cpf,\\r\\n        COUNT(DISTINCT cnpj_raiz) AS qte_cnpj\\r\\n    FROM gessimples.bcadastro_tab_cpf_raiz_pa_sn\\r\\n    GROUP BY cpf\\r\\n    HAVING COUNT(DISTINCT cnpj_raiz) >= 2\\r\\n)\\r\\nSELECT \\r\\n    cpf,\\r\\n    qte_cnpj,\\r\\n    ROW_NUMBER() OVER (ORDER BY cpf) AS num_grupo\\r\\nFROM contagem_por_cpf;\", \"\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 2.6. ADICIONAR NUM_GRUPO NOS DADOS (ACL: JOIN com REL_N_GRUPO)\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS gessimples.bcadastro_tab_raiz_cpf_pai;\", \"\\r\\nCREATE TABLE gessimples.bcadastro_tab_raiz_cpf_pai STORED AS PARQUET AS\\r\\nSELECT \\r\\n    r.*,\\r\\n    g.num_grupo,\\r\\n    g.qte_cnpj\\r\\nFROM gessimples.bcadastro_rba_por_raiz_cpf_pa r\\r\\nINNER JOIN gessimples.bcadastro_rel_n_grupo g\\r\\n    ON r.cpf = g.cpf;\", \"\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 2.7. RBA POR CPF+PA (SOMA DE TODOS OS CNPJ_RAIZ DO GRUPO)\\r\\n-- ACL: TAB_CPF_PA_PGDAS_SN\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS gessimples.bcadastro_rba_grupo_cpf_pa;\", \"\\r\\nCREATE TABLE gessimples.bcadastro_rba_grupo_cpf_pa STORED AS PARQUET AS\\r\\nSELECT \\r\\n    cpf,\\r\\n    pa,\\r\\n    num_grupo,\\r\\n    qte_cnpj,\\r\\n    pa_resp,\\r\\n    pa_fin_sn,\\r\\n    \\r\\n    -- SOMA RBA DE TODOS OS CNPJ DO CPF\\r\\n    SUM(vl_rba_pgdas) AS vl_rba_grupo,\\r\\n    \\r\\n    -- Soma ICMS\\r\\n    SUM(vl_icms_12m) AS vl_icms_grupo_12m,\\r\\n    \\r\\n    CURRENT_TIMESTAMP() AS dt_carga\\r\\n\\r\\nFROM gessimples.bcadastro_tab_raiz_cpf_pai\\r\\nGROUP BY \\r\\n    cpf,\\r\\n    pa,\\r\\n    num_grupo,\\r\\n    qte_cnpj,\\r\\n    pa_resp,\\r\\n    pa_fin_sn;\"], \"aceSize\": 100, \"status\": \"available\", \"statusForButtons\": \"executed\", \"properties\": {\"settings\": []}, \"viewSettings\": {\"placeHolder\": \"Exemplo: SELECT * FROM tablename ou pressione CTRL + espa\\u00e7o\", \"sqlDialect\": true}, \"variables\": [], \"hasCurlyBracketParameters\": true, \"variableNames\": [], \"variableValues\": {}, \"statement\": \"CREATE TABLE gessimples.bcadastro_rba_por_raiz_cpf_pa STORED AS PARQUET AS\\r\\nSELECT \\r\\n    cnpj_raiz,\\r\\n    cpf,\\r\\n    pa,\\r\\n    vl_rpa_int,\\r\\n    pa_resp,\\r\\n    qualificacao,\\r\\n    dt_ini_resp AS dt_ini_qualificacao,\\r\\n    periodo_ini_sn,\\r\\n    periodo_fim_sn,\\r\\n    pa_fin_sn,\\r\\n    uf,\\r\\n    vl_icms,\\r\\n    vl_ativ,\\r\\n    \\r\\n    -- ANO de refer\\u00eancia (para facilitar an\\u00e1lises)\\r\\n    CAST(SUBSTR(CAST(pa AS STRING), 1, 4) AS INT) AS ano_ref,\\r\\n    \\r\\n    -- RBA ACUMULADA NO ANO-CALEND\\u00c1RIO (YTD) - CONFORME LEGISLA\\u00c7\\u00c3O\\r\\n    -- Acumula desde janeiro at\\u00e9 o m\\u00eas atual dentro do mesmo ano\\r\\n    SUM(vl_rpa_int) OVER (\\r\\n        PARTITION BY cnpj_raiz, cpf, SUBSTR(CAST(pa AS STRING), 1, 4)\\r\\n        ORDER BY pa\\r\\n    ) AS vl_rba_pgdas,\\r\\n    \\r\\n    -- ICMS acumulado no ano-calend\\u00e1rio\\r\\n    SUM(vl_icms) OVER (\\r\\n        PARTITION BY cnpj_raiz, cpf, SUBSTR(CAST(pa AS STRING), 1, 4)\\r\\n        ORDER BY pa\\r\\n    ) AS vl_icms_ytd,\\r\\n    \\r\\n    CURRENT_TIMESTAMP() AS dt_carga\\r\\n\\r\\nFROM gessimples.bcadastro_tab_cpf_raiz_pa_sn;\", \"result\": {\"id\": \"c44b602d-c5ff-6136-2b6e-6bfb462d9001\", \"type\": \"table\", \"hasResultset\": true, \"handle\": {\"secret\": \"qcvXdrnqST+QBEKWpcs62Q==\", \"guid\": \"GXwwag0ESLAAAAAAnglH3A==\", \"operation_type\": 0, \"has_result_set\": true, \"modified_row_count\": null, \"log_context\": null, \"session_guid\": \"fd49043cdcea425f:bdf8f30dca02f4b0\", \"session_id\": 21856, \"session_type\": \"impala\", \"statement_id\": 0, \"has_more_statements\": false, \"statements_count\": 1, \"previous_statement_hash\": \"930b3b84c3960c63301f379c393414613f7857e35cb3767adce6cd2b\", \"start\": {\"row\": 0, \"column\": 0}, \"end\": {\"row\": 0, \"column\": 986}, \"statement\": \"CREATE TABLE gessimples.bcadastro_rba_por_raiz_cpf_pa STORED AS PARQUET AS\\r\\nSELECT \\r\\n    cnpj_raiz,\\r\\n    cpf,\\r\\n    pa,\\r\\n    vl_rpa_int,\\r\\n    pa_resp,\\r\\n    qualificacao,\\r\\n    dt_ini_resp AS dt_ini_qualificacao,\\r\\n    periodo_ini_sn,\\r\\n    periodo_fim_sn,\\r\\n    pa_fin_sn,\\r\\n    uf,\\r\\n    vl_icms,\\r\\n    vl_ativ,\\r\\n    \\r\\n    -- ANO de refer\\u00eancia (para facilitar an\\u00e1lises)\\r\\n    CAST(SUBSTR(CAST(pa AS STRING), 1, 4) AS INT) AS ano_ref,\\r\\n    \\r\\n    -- RBA ACUMULADA NO ANO-CALEND\\u00c1RIO (YTD) - CONFORME LEGISLA\\u00c7\\u00c3O\\r\\n    -- Acumula desde janeiro at\\u00e9 o m\\u00eas atual dentro do mesmo ano\\r\\n    SUM(vl_rpa_int) OVER (\\r\\n        PARTITION BY cnpj_raiz, cpf, SUBSTR(CAST(pa AS STRING), 1, 4)\\r\\n        ORDER BY pa\\r\\n    ) AS vl_rba_pgdas,\\r\\n    \\r\\n    -- ICMS acumulado no ano-calend\\u00e1rio\\r\\n    SUM(vl_icms) OVER (\\r\\n        PARTITION BY cnpj_raiz, cpf, SUBSTR(CAST(pa AS STRING), 1, 4)\\r\\n        ORDER BY pa\\r\\n    ) AS vl_icms_ytd,\\r\\n    \\r\\n    CURRENT_TIMESTAMP() AS dt_carga\\r\\n\\r\\nFROM gessimples.bcadastro_tab_cpf_raiz_pa_sn\"}, \"meta\": [], \"rows\": \"1\", \"hasMore\": false, \"statement_id\": 0, \"statement_range\": {\"start\": {\"row\": 0, \"column\": 0}, \"end\": {\"row\": 0, \"column\": 0}}, \"statements_count\": 1, \"metaFilter\": {\"query\": \"\", \"facets\": {}, \"text\": []}, \"isMetaFilterVisible\": false, \"filteredMetaChecked\": true, \"filteredColumnCount\": 1, \"filteredMeta\": [{\"type\": \"int\", \"name\": \"\", \"comment\": null, \"cssClass\": \"sort-numeric\", \"checked\": true, \"originalIndex\": 0}, {\"name\": \"summary\", \"type\": \"string\", \"comment\": null, \"cssClass\": \"sort-string\", \"checked\": true, \"originalIndex\": 1}], \"fetchedOnce\": false, \"startTime\": \"2025-10-21T12:54:11.158Z\", \"endTime\": \"2025-10-21T12:54:24.186Z\", \"executionTime\": 13028, \"data\": [], \"explanation\": \"\", \"logs\": \"\", \"logLines\": 13, \"hasSomeResults\": true}, \"showGrid\": true, \"showChart\": false, \"showLogs\": true, \"progress\": 0, \"jobs\": [], \"executeNextTimeout\": -1, \"isLoading\": false, \"resultsKlass\": \"results impala\", \"errorsKlass\": \"results impala alert alert-error\", \"is_redacted\": false, \"chartType\": \"bars\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null, \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartLimits\": [5, 10, 25, 50, 100], \"chartLimit\": null, \"chartX\": \"summary\", \"chartXPivot\": null, \"chartYSingle\": null, \"chartYMulti\": [], \"chartData\": [], \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"hideStacked\": true, \"hasDataForChart\": false, \"previousChartOptions\": {\"chartLimit\": null, \"chartX\": \"summary\", \"chartXPivot\": null, \"chartYSingle\": null, \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"chartYMulti\": [], \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null}, \"isResultSettingsVisible\": false, \"settingsVisible\": false, \"checkStatusTimeout\": 20862, \"getLogsTimeout\": 20875, \"topRisk\": null, \"suggestion\": \"\", \"hasSuggestion\": null, \"compatibilityCheckRunning\": false, \"compatibilitySourcePlatforms\": [{\"name\": \"Teradata\", \"value\": \"teradata\"}, {\"name\": \"Oracle\", \"value\": \"oracle\"}, {\"name\": \"Netezza\", \"value\": \"netezza\"}, {\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}, {\"name\": \"DB2\", \"value\": \"db2\"}, {\"name\": \"Greenplum\", \"value\": \"greenplum\"}, {\"name\": \"MySQL\", \"value\": \"mysql\"}, {\"name\": \"PostgreSQL\", \"value\": \"postgresql\"}, {\"name\": \"Informix\", \"value\": \"informix\"}, {\"name\": \"SQL Server\", \"value\": \"sqlserver\"}, {\"name\": \"Sybase\", \"value\": \"sybase\"}, {\"name\": \"Access\", \"value\": \"access\"}, {\"name\": \"Firebird\", \"value\": \"firebird\"}, {\"name\": \"ANSISQL\", \"value\": \"ansisql\"}, {\"name\": \"Generic\", \"value\": \"generic\"}], \"compatibilitySourcePlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"compatibilityTargetPlatforms\": [{\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}], \"compatibilityTargetPlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"showSqlAnalyzer\": false, \"wasBatchExecuted\": false, \"isReady\": true, \"lastExecuted\": 1761051250826, \"lastAceSelectionRowOffset\": 114, \"executingBlockingOperation\": null, \"showLongOperationWarning\": false, \"lastExecutedStatements\": \"CREATE TABLE gessimples.bcadastro_rba_por_raiz_cpf_pa STORED AS PARQUET AS\\r\\nSELECT \\r\\n    cnpj_raiz,\\r\\n    cpf,\\r\\n    pa,\\r\\n    vl_rpa_int,\\r\\n    pa_resp,\\r\\n    qualificacao,\\r\\n    dt_ini_resp AS dt_ini_qualificacao,\\r\\n    periodo_ini_sn,\\r\\n    periodo_fim_sn,\\r\\n    pa_fin_sn,\\r\\n    uf,\\r\\n    vl_icms,\\r\\n    vl_ativ,\\r\\n    \\r\\n    -- ANO de refer\\u00eancia (para facilitar an\\u00e1lises)\\r\\n    CAST(SUBSTR(CAST(pa AS STRING), 1, 4) AS INT) AS ano_ref,\\r\\n    \\r\\n    -- RBA ACUMULADA NO ANO-CALEND\\u00c1RIO (YTD) - CONFORME LEGISLA\\u00c7\\u00c3O\\r\\n    -- Acumula desde janeiro at\\u00e9 o m\\u00eas atual dentro do mesmo ano\\r\\n    SUM(vl_rpa_int) OVER (\\r\\n        PARTITION BY cnpj_raiz, cpf, SUBSTR(CAST(pa AS STRING), 1, 4)\\r\\n        ORDER BY pa\\r\\n    ) AS vl_rba_pgdas,\\r\\n    \\r\\n    -- ICMS acumulado no ano-calend\\u00e1rio\\r\\n    SUM(vl_icms) OVER (\\r\\n        PARTITION BY cnpj_raiz, cpf, SUBSTR(CAST(pa AS STRING), 1, 4)\\r\\n        ORDER BY pa\\r\\n    ) AS vl_icms_ytd,\\r\\n    \\r\\n    CURRENT_TIMESTAMP() AS dt_carga\\r\\n\\r\\nFROM gessimples.bcadastro_tab_cpf_raiz_pa_sn;\", \"lastExecutedSelectionRange\": {\"start\": {\"row\": 114, \"column\": 0}, \"end\": {\"row\": 148, \"column\": 45}}, \"formatEnabled\": true, \"isFetchingData\": false, \"isCanceling\": false, \"aceAutoExpand\": false, \"lastCheckStatusRequest\": {\"readyState\": 4, \"responseText\": \"{\\\"status\\\": 0, \\\"query_status\\\": {\\\"status\\\": \\\"available\\\"}}\", \"responseJSON\": {\"status\": 0, \"query_status\": {\"status\": \"available\"}}, \"status\": 200, \"statusText\": \"OK\"}, \"lastGetLogsRequest\": {\"readyState\": 4, \"responseText\": \"{\\\"status\\\": 0, \\\"logs\\\": \\\"Query b048040d6a307c19:dc47099e00000000 100% Complete (5 out of 5)\\\", \\\"progress\\\": 100, \\\"jobs\\\": [{\\\"name\\\": \\\"b048040d6a307c19:dc47099e00000000\\\", \\\"url\\\": \\\"/hue/jobbrowser#!id=b048040d6a307c19:dc47099e00000000\\\", \\\"started\\\": true, \\\"finished\\\": false, \\\"percentJob\\\": 100}], \\\"isFullLogs\\\": false}\", \"responseJSON\": {\"status\": 0, \"logs\": \"Query b048040d6a307c19:dc47099e00000000 100% Complete (5 out of 5)\", \"progress\": 100, \"jobs\": [{\"name\": \"b048040d6a307c19:dc47099e00000000\", \"url\": \"/hue/jobbrowser#!id=b048040d6a307c19:dc47099e00000000\", \"started\": true, \"finished\": false, \"percentJob\": 100}], \"isFullLogs\": false}, \"status\": 200, \"statusText\": \"OK\"}}], \"selectedSnippet\": \"impala\", \"creatingSessionLocks\": [], \"sessions\": [], \"directoryUuid\": \"\", \"dependentsCoordinator\": [], \"historyFilter\": \"\", \"historyFilterVisible\": false, \"loadingHistory\": false, \"historyInitialHeight\": 14671, \"forceHistoryInitialHeight\": false, \"historyCurrentPage\": 1, \"historyTotalPages\": 153, \"schedulerViewModel\": null, \"schedulerViewModelIsLoaded\": false, \"isBatchable\": true, \"isExecutingAll\": false, \"executingAllIndex\": 0, \"retryModalConfirm\": null, \"retryModalCancel\": null, \"canSave\": true, \"unloaded\": false, \"updateHistoryFailed\": false, \"viewSchedulerId\": \"\", \"loadingScheduler\": false}",
    "extra": "",
    "search": "-- ============================================================================\r\n-- SCRIPT 02: RBA E GRUPOS ECONÔMICOS - 100% ADERENTE AO ACL\r\n-- Tempo estimado: 10-15 minutos\r\n-- Baseado em: Lógica de TAB_RAIZ_CPF_PAI do ACL\r\n-- ============================================================================\r\n\r\n-- ----------------------------------------------------------------------------\r\n-- 2.1. CONSOLIDAÇÃO PGDAS-D\r\n-- ----------------------------------------------------------------------------\r\nDROP TABLE IF EXISTS gessimples.bcadastro_pgdas_consolidado;\r\nCREATE TABLE gessimples.bcadastro_pgdas_consolidado STORED AS PARQUET AS\r\nSELECT \r\n    SUBSTR(nu_cnpj, 1, 8) AS cnpj_raiz,\r\n    nu_cnpj AS cnpj_completo,\r\n    nu_per_ref AS periodo_apuracao,\r\n    CONCAT(\r\n        SUBSTR(CAST(nu_per_ref AS STRING), 1, 4),\r\n        SUBSTR(CAST(nu_per_ref AS STRING), 5, 2)\r\n    ) AS pa,\r\n    \r\n    -- Receitas\r\n    COALESCE(vl_rec_bruta_estab, 0) AS vl_rpa_int,\r\n    COALESCE(vl_icms_sc, 0) AS vl_icms,\r\n    \r\n    -- Para cálculo VL_CT (ACL usa VL_ATIV)\r\n    COALESCE(vl_venda, 0) + \r\n    COALESCE(vl_venda_st, 0) + \r\n    COALESCE(vl_prest_serv_com, 0) + \r\n    COALESCE(vl_prest_serv_transp, 0) + \r\n    COALESCE(vl_outros, 0) AS vl_ativ,\r\n    \r\n    sg_uf AS uf,\r\n    cd_munic AS codigo_municipio,\r\n    \r\n    CURRENT_TIMESTAMP() AS dt_carga\r\n\r\nFROM usr_sat_ods.sna_pgdasd_estabelecimento_raw\r\nWHERE nu_per_ref >= 202101\r\n  AND nu_per_ref <= 202512\r\n  AND (\r\n      sg_uf = 'SC'\r\n      OR SUBSTR(nu_cnpj, 1, 8) IN (\r\n          SELECT DISTINCT cnpj_raiz\r\n          FROM gessimples.bcadastro_base_cnpj_completo\r\n      )\r\n  );\r\n\r\n-- ----------------------------------------------------------------------------\r\n-- 2.2. CRIAR TABELA COM CPF + PA (ACL: TAB_TMP_CPF_PA)\r\n-- ----------------------------------------------------------------------------\r\nDROP TABLE IF EXISTS gessimples.bcadastro_tab_cpf_raiz_pa;\r\nCREATE TABLE gessimples.bcadastro_tab_cpf_raiz_pa STORED AS PARQUET AS\r\nSELECT DISTINCT\r\n    s.cnpj_r",
    "last_modified": "2025-10-21T09:54:56.758",
    "version": 1,
    "is_history": false,
    "is_managed": false,
    "is_trashed": false,
    "parent_directory": [
      "38597e6c-aa1b-4e22-9133-e97cdfaf3585",
      1,
      false
    ],
    "dependencies": []
  }
},
{
  "model": "desktop.document2",
  "pk": 164277,
  "fields": {
    "owner": [
      "tsevero"
    ],
    "name": "BCADASTRO: 3 FG ACIMA LIMITE",
    "description": "",
    "uuid": "08a3ab9a-048f-e384-11b5-9c7d3bc39aee",
    "type": "query-impala",
    "connector": null,
    "data": "{\"id\": 164277, \"uuid\": \"d8a2087e-f4bd-496a-b42d-54977a4b3854\", \"name\": \"BCADASTRO: 3 FG ACIMA LIMITE\", \"description\": \"\", \"type\": \"query-impala\", \"initialType\": \"impala\", \"coordinatorUuid\": null, \"isHistory\": false, \"isManaged\": false, \"parentSavedQueryUuid\": \"08a3ab9a-048f-e384-11b5-9c7d3bc39aee\", \"isSaved\": true, \"onSuccessUrl\": null, \"pubSubUrl\": null, \"isPresentationModeDefault\": false, \"isPresentationMode\": false, \"isPresentationModeInitialized\": true, \"presentationSnippets\": {}, \"isHidingCode\": false, \"snippets\": [{\"id\": \"392f8354-cb74-61fd-9051-d603d4801630\", \"name\": \"\", \"type\": \"impala\", \"connector\": {\"name\": \"Impala\", \"type\": \"impala\", \"id\": \"impala\", \"displayName\": \"Impala\", \"buttonName\": \"Consulta\", \"tooltip\": \"Impala Query\", \"optimizer\": \"off\", \"page\": \"/editor/?type=impala\", \"is_sql\": true, \"is_batchable\": true, \"dialect\": \"impala\", \"dialect_properties\": {}}, \"isSqlDialect\": true, \"dialect\": \"impala\", \"isBatchable\": true, \"autocompleteSettings\": {\"temporaryOnly\": false}, \"aceCursorPosition\": {\"row\": 235, \"column\": 39}, \"errors\": [], \"aceErrorsHolder\": [], \"aceWarningsHolder\": [], \"aceErrors\": [], \"aceWarnings\": [], \"editorMode\": true, \"dbSelectionVisible\": false, \"showExecutionAnalysis\": true, \"namespace\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"status\": \"CREATED\", \"computes\": [{\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"type\": \"direct\", \"credentials\": {}}]}, \"compute\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"namespace\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"interface\": \"impala\", \"type\": \"direct\", \"options\": {}}, \"database\": \"usr_sat_ods\", \"currentQueryTab\": \"queryResults\", \"pinnedContextTabs\": [], \"loadingQueries\": false, \"queriesHasErrors\": false, \"queriesCurrentPage\": 1, \"queriesTotalPages\": 3, \"queriesFilter\": \"\", \"queriesFilterVisible\": false, \"statementType\": \"text\", \"statementTypes\": [\"text\", \"file\"], \"statementPath\": \"\", \"externalStatementLoaded\": false, \"associatedDocumentLoading\": true, \"associatedDocumentUuid\": null, \"statement_raw\": \"-- ============================================================================\\r\\n-- SCRIPT 03: DETEC\\u00c7\\u00c3O DE FATO GERADOR - 100% ADERENTE AO ACL\\r\\n-- Tempo estimado: 15-20 minutos\\r\\n-- Baseado em: L\\u00f3gica PA_FATO_2021/XXXX-XXXX-XXXX-XXXX do ACL\\r\\n-- ============================================================================\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 3.1. TABELA DE LIMITES SIMPLES NACIONAL\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS gessimples.bcadastro_ref_limite_sn;\\r\\nCREATE TABLE gessimples.bcadastro_ref_limite_sn (\\r\\n    periodo_apuracao INT,\\r\\n    limite_mensal DECIMAL(15,2),\\r\\n    limite_anual DECIMAL(15,2)\\r\\n)\\r\\nSTORED AS PARQUET;\\r\\n\\r\\n-- Inserir limites conforme ACL (sintaxe compat\\u00edvel com Impala)\\r\\nINSERT INTO gessimples.bcadastro_ref_limite_sn VALUES\\r\\n(202101, 5760000.00, 4800000.00),\\r\\n(202102, 5760000.00, 4800000.00),\\r\\n(202103, 5760000.00, 4800000.00),\\r\\n(202104, 5760000.00, 4800000.00),\\r\\n(202105, 5760000.00, 4800000.00),\\r\\n(202106, 5760000.00, 4800000.00),\\r\\n(202107, 5760000.00, 4800000.00),\\r\\n(202108, 5760000.00, 4800000.00),\\r\\n(202109, 5760000.00, 4800000.00),\\r\\n(202110, 5760000.00, 4800000.00),\\r\\n(202111, 5760000.00, 4800000.00),\\r\\n(202112, 4800000.00, 4800000.00),\\r\\n(202201, 5760000.00, 4800000.00),\\r\\n(202202, 5760000.00, 4800000.00),\\r\\n(202203, 5760000.00, 4800000.00),\\r\\n(202204, 5760000.00, 4800000.00),\\r\\n(202205, 5760000.00, 4800000.00),\\r\\n(202206, 5760000.00, 4800000.00),\\r\\n(202207, 5760000.00, 4800000.00),\\r\\n(202208, 5760000.00, 4800000.00),\\r\\n(202209, 5760000.00, 4800000.00),\\r\\n(202210, 5760000.00, 4800000.00),\\r\\n(202211, 5760000.00, 4800000.00),\\r\\n(202212, 4800000.00, 4800000.00),\\r\\n(202301, 5760000.00, 4800000.00),\\r\\n(202302, 5760000.00, 4800000.00),\\r\\n(202303, 5760000.00, 4800000.00),\\r\\n(202304, 5760000.00, 4800000.00),\\r\\n(202305, 5760000.00, 4800000.00),\\r\\n(202306, 5760000.00, 4800000.00),\\r\\n(202307, 5760000.00, 4800000.00),\\r\\n(202308, 5760000.00, 4800000.00),\\r\\n(202309, 5760000.00, 4800000.00),\\r\\n(202310, 5760000.00, 4800000.00),\\r\\n(202311, 5760000.00, 4800000.00),\\r\\n(202312, 4800000.00, 4800000.00),\\r\\n(202401, 5760000.00, 4800000.00),\\r\\n(202402, 5760000.00, 4800000.00),\\r\\n(202403, 5760000.00, 4800000.00),\\r\\n(202404, 5760000.00, 4800000.00),\\r\\n(202405, 5760000.00, 4800000.00),\\r\\n(202406, 5760000.00, 4800000.00),\\r\\n(202407, 5760000.00, 4800000.00),\\r\\n(202408, 5760000.00, 4800000.00),\\r\\n(202409, 5760000.00, 4800000.00),\\r\\n(202410, 5760000.00, 4800000.00),\\r\\n(202411, 5760000.00, 4800000.00),\\r\\n(202412, 4800000.00, 4800000.00),\\r\\n(202501, 5760000.00, 4800000.00),\\r\\n(202502, 5760000.00, 4800000.00),\\r\\n(202503, 5760000.00, 4800000.00),\\r\\n(202504, 5760000.00, 4800000.00),\\r\\n(202505, 5760000.00, 4800000.00),\\r\\n(202506, 5760000.00, 4800000.00),\\r\\n(202507, 5760000.00, 4800000.00),\\r\\n(202508, 5760000.00, 4800000.00),\\r\\n(202509, 5760000.00, 4800000.00),\\r\\n(202510, 5760000.00, 4800000.00),\\r\\n(202511, 5760000.00, 4800000.00),\\r\\n(202512, 4800000.00, 4800000.00);\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 3.2. DETECTAR PER\\u00cdODOS COM ULTRAPASSAGEM POR ANO (ACL)\\r\\n-- PA_FATO_2021, PA_FATO_2022, PA_FATO_2023, PA_FATO_2024, PA_FATO_2025\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS gessimples.bcadastro_fato_gerador_por_ano;\\r\\nCREATE TABLE gessimples.bcadastro_fato_gerador_por_ano STORED AS PARQUET AS\\r\\nSELECT \\r\\n    r.cpf,\\r\\n    r.num_grupo,\\r\\n    r.qte_cnpj,\\r\\n    r.pa_resp,\\r\\n    \\r\\n    -- PA_FATO_2021 (ACL exato)\\r\\n    MIN(CASE \\r\\n        WHEN r.vl_rba_grupo > lim.limite_mensal\\r\\n             AND r.qte_cnpj > 1\\r\\n             AND r.pa_resp <= CAST(r.pa AS STRING)\\r\\n             AND r.pa BETWEEN 202101 AND 202112\\r\\n        THEN CAST(r.pa AS STRING)\\r\\n        ELSE 'SN'\\r\\n    END) AS pa_fato_2021,\\r\\n    \\r\\n    -- PA_FATO_2022\\r\\n    MIN(CASE \\r\\n        WHEN r.vl_rba_grupo > lim.limite_mensal\\r\\n             AND r.qte_cnpj > 1\\r\\n             AND r.pa_resp <= CAST(r.pa AS STRING)\\r\\n             AND r.pa BETWEEN 202201 AND 202212\\r\\n        THEN CAST(r.pa AS STRING)\\r\\n        ELSE 'SN'\\r\\n    END) AS pa_fato_2022,\\r\\n    \\r\\n    -- PA_FATO_2023\\r\\n    MIN(CASE \\r\\n        WHEN r.vl_rba_grupo > lim.limite_mensal\\r\\n             AND r.qte_cnpj > 1\\r\\n             AND r.pa_resp <= CAST(r.pa AS STRING)\\r\\n             AND r.pa BETWEEN 202301 AND 202312\\r\\n        THEN CAST(r.pa AS STRING)\\r\\n        ELSE 'SN'\\r\\n    END) AS pa_fato_2023,\\r\\n    \\r\\n    -- PA_FATO_2024\\r\\n    MIN(CASE \\r\\n        WHEN r.vl_rba_grupo > lim.limite_mensal\\r\\n             AND r.qte_cnpj > 1\\r\\n             AND r.pa_resp <= CAST(r.pa AS STRING)\\r\\n             AND r.pa BETWEEN 202401 AND 202412\\r\\n        THEN CAST(r.pa AS STRING)\\r\\n        ELSE 'SN'\\r\\n    END) AS pa_fato_2024,\\r\\n    \\r\\n    -- PA_FATO_2025\\r\\n    MIN(CASE \\r\\n        WHEN r.vl_rba_grupo > lim.limite_mensal\\r\\n             AND r.qte_cnpj > 1\\r\\n             AND r.pa_resp <= CAST(r.pa AS STRING)\\r\\n             AND r.pa >= 202501\\r\\n        THEN CAST(r.pa AS STRING)\\r\\n        ELSE 'SN'\\r\\n    END) AS pa_fato_2025,\\r\\n    \\r\\n    CURRENT_TIMESTAMP() AS dt_carga\\r\\n\\r\\nFROM gessimples.bcadastro_rba_grupo_cpf_pa r\\r\\nINNER JOIN gessimples.bcadastro_ref_limite_sn lim\\r\\n    ON r.pa = lim.periodo_apuracao\\r\\nGROUP BY \\r\\n    r.cpf,\\r\\n    r.num_grupo,\\r\\n    r.qte_cnpj,\\r\\n    r.pa_resp;\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 3.3. DETERMINAR PA_FATO (PRIMEIRO PER\\u00cdODO COM ULTRAPASSAGEM)\\r\\n-- ACL: L\\u00f3gica complexa com m\\u00faltiplas condi\\u00e7\\u00f5es\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS gessimples.bcadastro_pa_fato_determinado;\\r\\nCREATE TABLE gessimples.bcadastro_pa_fato_determinado STORED AS PARQUET AS\\r\\nSELECT \\r\\n    *,\\r\\n    \\r\\n    -- PA_FATO (ACL exato - primeira ultrapassagem considerando hierarquia)\\r\\n    CASE \\r\\n        -- Se 2021 ultrapassou\\r\\n        WHEN pa_fato_2021 != 'SN' THEN pa_fato_2021\\r\\n        -- Se 2022 ultrapassou\\r\\n        WHEN pa_fato_2022 != 'SN' THEN pa_fato_2022\\r\\n        -- Se 2023 ultrapassou\\r\\n        WHEN pa_fato_2023 != 'SN' THEN pa_fato_2023\\r\\n        -- Se 2024 ultrapassou\\r\\n        WHEN pa_fato_2024 != 'SN' THEN pa_fato_2024\\r\\n        -- Se 2025 ultrapassou\\r\\n        WHEN pa_fato_2025 != 'SN' THEN pa_fato_2025\\r\\n        ELSE ''\\r\\n    END AS pa_fato\\r\\n\\r\\nFROM gessimples.bcadastro_fato_gerador_por_ano\\r\\nWHERE NOT (pa_fato_2021 = 'SN' \\r\\n           AND pa_fato_2022 = 'SN' \\r\\n           AND pa_fato_2023 = 'SN' \\r\\n           AND pa_fato_2024 = 'SN' \\r\\n           AND pa_fato_2025 = 'SN');\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 3.4. JUNTAR COM DADOS INDIVIDUAIS DE CNPJ_RAIZ+CPF+PA\\r\\n-- Para cada grupo, pegar os dados de cada empresa no PA do fato\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS gessimples.bcadastro_tab_periodo_rba;\\r\\nCREATE TABLE gessimples.bcadastro_tab_periodo_rba STORED AS PARQUET AS\\r\\nSELECT \\r\\n    r.cnpj_raiz,\\r\\n    r.cpf,\\r\\n    r.pa,\\r\\n    r.vl_rba_pgdas,\\r\\n    r.vl_icms,\\r\\n    r.vl_icms_12m,\\r\\n    r.vl_ativ,\\r\\n    r.vl_rpa_int,\\r\\n    r.pa_resp,\\r\\n    r.qualificacao,\\r\\n    r.dt_ini_qualificacao,\\r\\n    r.periodo_ini_sn,\\r\\n    r.periodo_fim_sn,\\r\\n    r.pa_fin_sn,\\r\\n    r.uf,\\r\\n    r.num_grupo,\\r\\n    r.qte_cnpj,\\r\\n    \\r\\n    -- Dados do fato gerador\\r\\n    fg.pa_fato,\\r\\n    fg.pa_fato_2021,\\r\\n    fg.pa_fato_2022,\\r\\n    fg.pa_fato_2023,\\r\\n    fg.pa_fato_2024,\\r\\n    fg.pa_fato_2025,\\r\\n    \\r\\n    -- RBA do grupo no PA do fato\\r\\n    rg.vl_rba_grupo AS receita_pa_fato,\\r\\n    \\r\\n    CURRENT_TIMESTAMP() AS dt_carga\\r\\n\\r\\nFROM gessimples.bcadastro_tab_raiz_cpf_pai r\\r\\nINNER JOIN gessimples.bcadastro_pa_fato_determinado fg\\r\\n    ON r.cpf = fg.cpf\\r\\n    AND r.num_grupo = fg.num_grupo\\r\\nINNER JOIN gessimples.bcadastro_rba_grupo_cpf_pa rg\\r\\n    ON r.cpf = rg.cpf\\r\\n    AND r.pa = rg.pa\\r\\nWHERE CAST(r.pa AS STRING) = fg.pa_fato;\\r\\n\\r\\n-- ============================================================================\\r\\n-- VALIDA\\u00c7\\u00d5ES\\r\\n-- ============================================================================\\r\\nSELECT 'Limites SN' AS tabela, COUNT(*) AS total\\r\\nFROM gessimples.bcadastro_ref_limite_sn\\r\\nUNION ALL\\r\\nSELECT 'Fato Gerador por Ano', COUNT(*)\\r\\nFROM gessimples.bcadastro_fato_gerador_por_ano\\r\\nUNION ALL\\r\\nSELECT 'PA Fato Determinado', COUNT(*)\\r\\nFROM gessimples.bcadastro_pa_fato_determinado\\r\\nUNION ALL\\r\\nSELECT 'Per\\u00edodos com Fato', COUNT(*)\\r\\nFROM gessimples.bcadastro_tab_periodo_rba;\", \"statementsList\": [\"-- ============================================================================\\r\\n-- SCRIPT 03: DETEC\\u00c7\\u00c3O DE FATO GERADOR - 100% ADERENTE AO ACL\\r\\n-- Tempo estimado: 15-20 minutos\\r\\n-- Baseado em: L\\u00f3gica PA_FATO_2021/2022/2023/2024/2025 do ACL\\r\\n-- ============================================================================\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 3.1. TABELA DE LIMITES SIMPLES NACIONAL\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS gessimples.bcadastro_ref_limite_sn;\", \"\\r\\nCREATE TABLE gessimples.bcadastro_ref_limite_sn (\\r\\n    periodo_apuracao INT,\\r\\n    limite_mensal DECIMAL(15,2),\\r\\n    limite_anual DECIMAL(15,2)\\r\\n)\\r\\nSTORED AS PARQUET;\", \"\\r\\n\\r\\n-- Inserir limites conforme ACL (sintaxe compat\\u00edvel com Impala)\\r\\nINSERT INTO gessimples.bcadastro_ref_limite_sn VALUES\\r\\n(202101, 5760000.00, 4800000.00),\\r\\n(202102, 5760000.00, 4800000.00),\\r\\n(202103, 5760000.00, 4800000.00),\\r\\n(202104, 5760000.00, 4800000.00),\\r\\n(202105, 5760000.00, 4800000.00),\\r\\n(202106, 5760000.00, 4800000.00),\\r\\n(202107, 5760000.00, 4800000.00),\\r\\n(202108, 5760000.00, 4800000.00),\\r\\n(202109, 5760000.00, 4800000.00),\\r\\n(202110, 5760000.00, 4800000.00),\\r\\n(202111, 5760000.00, 4800000.00),\\r\\n(202112, 4800000.00, 4800000.00),\\r\\n(202201, 5760000.00, 4800000.00),\\r\\n(202202, 5760000.00, 4800000.00),\\r\\n(202203, 5760000.00, 4800000.00),\\r\\n(202204, 5760000.00, 4800000.00),\\r\\n(202205, 5760000.00, 4800000.00),\\r\\n(202206, 5760000.00, 4800000.00),\\r\\n(202207, 5760000.00, 4800000.00),\\r\\n(202208, 5760000.00, 4800000.00),\\r\\n(202209, 5760000.00, 4800000.00),\\r\\n(202210, 5760000.00, 4800000.00),\\r\\n(202211, 5760000.00, 4800000.00),\\r\\n(202212, 4800000.00, 4800000.00),\\r\\n(202301, 5760000.00, 4800000.00),\\r\\n(202302, 5760000.00, 4800000.00),\\r\\n(202303, 5760000.00, 4800000.00),\\r\\n(202304, 5760000.00, 4800000.00),\\r\\n(202305, 5760000.00, 4800000.00),\\r\\n(202306, 5760000.00, 4800000.00),\\r\\n(202307, 5760000.00, 4800000.00),\\r\\n(202308, 5760000.00, 4800000.00),\\r\\n(202309, 5760000.00, 4800000.00),\\r\\n(202310, 5760000.00, 4800000.00),\\r\\n(202311, 5760000.00, 4800000.00),\\r\\n(202312, 4800000.00, 4800000.00),\\r\\n(202401, 5760000.00, 4800000.00),\\r\\n(202402, 5760000.00, 4800000.00),\\r\\n(202403, 5760000.00, 4800000.00),\\r\\n(202404, 5760000.00, 4800000.00),\\r\\n(202405, 5760000.00, 4800000.00),\\r\\n(202406, 5760000.00, 4800000.00),\\r\\n(202407, 5760000.00, 4800000.00),\\r\\n(202408, 5760000.00, 4800000.00),\\r\\n(202409, 5760000.00, 4800000.00),\\r\\n(202410, 5760000.00, 4800000.00),\\r\\n(202411, 5760000.00, 4800000.00),\\r\\n(202412, 4800000.00, 4800000.00),\\r\\n(202501, 5760000.00, 4800000.00),\\r\\n(202502, 5760000.00, 4800000.00),\\r\\n(202503, 5760000.00, 4800000.00),\\r\\n(202504, 5760000.00, 4800000.00),\\r\\n(202505, 5760000.00, 4800000.00),\\r\\n(202506, 5760000.00, 4800000.00),\\r\\n(202507, 5760000.00, 4800000.00),\\r\\n(202508, 5760000.00, 4800000.00),\\r\\n(202509, 5760000.00, 4800000.00),\\r\\n(202510, 5760000.00, 4800000.00),\\r\\n(202511, 5760000.00, 4800000.00),\\r\\n(202512, 4800000.00, 4800000.00);\", \"\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 3.2. DETECTAR PER\\u00cdODOS COM ULTRAPASSAGEM POR ANO (ACL)\\r\\n-- PA_FATO_2021, PA_FATO_2022, PA_FATO_2023, PA_FATO_2024, PA_FATO_2025\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS gessimples.bcadastro_fato_gerador_por_ano;\", \"\\r\\nCREATE TABLE gessimples.bcadastro_fato_gerador_por_ano STORED AS PARQUET AS\\r\\nSELECT \\r\\n    r.cpf,\\r\\n    r.num_grupo,\\r\\n    r.qte_cnpj,\\r\\n    r.pa_resp,\\r\\n    \\r\\n    -- PA_FATO_2021 (ACL exato)\\r\\n    MIN(CASE \\r\\n        WHEN r.vl_rba_grupo > lim.limite_mensal\\r\\n             AND r.qte_cnpj > 1\\r\\n             AND r.pa_resp <= CAST(r.pa AS STRING)\\r\\n             AND r.pa BETWEEN 202101 AND 202112\\r\\n        THEN CAST(r.pa AS STRING)\\r\\n        ELSE 'SN'\\r\\n    END) AS pa_fato_2021,\\r\\n    \\r\\n    -- PA_FATO_2022\\r\\n    MIN(CASE \\r\\n        WHEN r.vl_rba_grupo > lim.limite_mensal\\r\\n             AND r.qte_cnpj > 1\\r\\n             AND r.pa_resp <= CAST(r.pa AS STRING)\\r\\n             AND r.pa BETWEEN 202201 AND 202212\\r\\n        THEN CAST(r.pa AS STRING)\\r\\n        ELSE 'SN'\\r\\n    END) AS pa_fato_2022,\\r\\n    \\r\\n    -- PA_FATO_2023\\r\\n    MIN(CASE \\r\\n        WHEN r.vl_rba_grupo > lim.limite_mensal\\r\\n             AND r.qte_cnpj > 1\\r\\n             AND r.pa_resp <= CAST(r.pa AS STRING)\\r\\n             AND r.pa BETWEEN 202301 AND 202312\\r\\n        THEN CAST(r.pa AS STRING)\\r\\n        ELSE 'SN'\\r\\n    END) AS pa_fato_2023,\\r\\n    \\r\\n    -- PA_FATO_2024\\r\\n    MIN(CASE \\r\\n        WHEN r.vl_rba_grupo > lim.limite_mensal\\r\\n             AND r.qte_cnpj > 1\\r\\n             AND r.pa_resp <= CAST(r.pa AS STRING)\\r\\n             AND r.pa BETWEEN 202401 AND 202412\\r\\n        THEN CAST(r.pa AS STRING)\\r\\n        ELSE 'SN'\\r\\n    END) AS pa_fato_2024,\\r\\n    \\r\\n    -- PA_FATO_2025\\r\\n    MIN(CASE \\r\\n        WHEN r.vl_rba_grupo > lim.limite_mensal\\r\\n             AND r.qte_cnpj > 1\\r\\n             AND r.pa_resp <= CAST(r.pa AS STRING)\\r\\n             AND r.pa >= 202501\\r\\n        THEN CAST(r.pa AS STRING)\\r\\n        ELSE 'SN'\\r\\n    END) AS pa_fato_2025,\\r\\n    \\r\\n    CURRENT_TIMESTAMP() AS dt_carga\\r\\n\\r\\nFROM gessimples.bcadastro_rba_grupo_cpf_pa r\\r\\nINNER JOIN gessimples.bcadastro_ref_limite_sn lim\\r\\n    ON r.pa = lim.periodo_apuracao\\r\\nGROUP BY \\r\\n    r.cpf,\\r\\n    r.num_grupo,\\r\\n    r.qte_cnpj,\\r\\n    r.pa_resp;\", \"\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 3.3. DETERMINAR PA_FATO (PRIMEIRO PER\\u00cdODO COM ULTRAPASSAGEM)\\r\\n-- ACL: L\\u00f3gica complexa com m\\u00faltiplas condi\\u00e7\\u00f5es\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS gessimples.bcadastro_pa_fato_determinado;\", \"\\r\\nCREATE TABLE gessimples.bcadastro_pa_fato_determinado STORED AS PARQUET AS\\r\\nSELECT \\r\\n    *,\\r\\n    \\r\\n    -- PA_FATO (ACL exato - primeira ultrapassagem considerando hierarquia)\\r\\n    CASE \\r\\n        -- Se 2021 ultrapassou\\r\\n        WHEN pa_fato_2021 != 'SN' THEN pa_fato_2021\\r\\n        -- Se 2022 ultrapassou\\r\\n        WHEN pa_fato_2022 != 'SN' THEN pa_fato_2022\\r\\n        -- Se 2023 ultrapassou\\r\\n        WHEN pa_fato_2023 != 'SN' THEN pa_fato_2023\\r\\n        -- Se 2024 ultrapassou\\r\\n        WHEN pa_fato_2024 != 'SN' THEN pa_fato_2024\\r\\n        -- Se 2025 ultrapassou\\r\\n        WHEN pa_fato_2025 != 'SN' THEN pa_fato_2025\\r\\n        ELSE ''\\r\\n    END AS pa_fato\\r\\n\\r\\nFROM gessimples.bcadastro_fato_gerador_por_ano\\r\\nWHERE NOT (pa_fato_2021 = 'SN' \\r\\n           AND pa_fato_2022 = 'SN' \\r\\n           AND pa_fato_2023 = 'SN' \\r\\n           AND pa_fato_2024 = 'SN' \\r\\n           AND pa_fato_2025 = 'SN');\", \"\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 3.4. JUNTAR COM DADOS INDIVIDUAIS DE CNPJ_RAIZ+CPF+PA\\r\\n-- Para cada grupo, pegar os dados de cada empresa no PA do fato\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS gessimples.bcadastro_tab_periodo_rba;\", \"\\r\\nCREATE TABLE gessimples.bcadastro_tab_periodo_rba STORED AS PARQUET AS\\r\\nSELECT \\r\\n    r.cnpj_raiz,\\r\\n    r.cpf,\\r\\n    r.pa,\\r\\n    r.vl_rba_pgdas,\\r\\n    r.vl_icms,\\r\\n    r.vl_icms_12m,\\r\\n    r.vl_ativ,\\r\\n    r.vl_rpa_int,\\r\\n    r.pa_resp,\\r\\n    r.qualificacao,\\r\\n    r.dt_ini_qualificacao,\\r\\n    r.periodo_ini_sn,\\r\\n    r.periodo_fim_sn,\\r\\n    r.pa_fin_sn,\\r\\n    r.uf,\\r\\n    r.num_grupo,\\r\\n    r.qte_cnpj,\\r\\n    \\r\\n    -- Dados do fato gerador\\r\\n    fg.pa_fato,\\r\\n    fg.pa_fato_2021,\\r\\n    fg.pa_fato_2022,\\r\\n    fg.pa_fato_2023,\\r\\n    fg.pa_fato_2024,\\r\\n    fg.pa_fato_2025,\\r\\n    \\r\\n    -- RBA do grupo no PA do fato\\r\\n    rg.vl_rba_grupo AS receita_pa_fato,\\r\\n    \\r\\n    CURRENT_TIMESTAMP() AS dt_carga\\r\\n\\r\\nFROM gessimples.bcadastro_tab_raiz_cpf_pai r\\r\\nINNER JOIN gessimples.bcadastro_pa_fato_determinado fg\\r\\n    ON r.cpf = fg.cpf\\r\\n    AND r.num_grupo = fg.num_grupo\\r\\nINNER JOIN gessimples.bcadastro_rba_grupo_cpf_pa rg\\r\\n    ON r.cpf = rg.cpf\\r\\n    AND r.pa = rg.pa\\r\\nWHERE CAST(r.pa AS STRING) = fg.pa_fato;\", \"\\r\\n\\r\\n-- ============================================================================\\r\\n-- VALIDA\\u00c7\\u00d5ES\\r\\n-- ============================================================================\\r\\nSELECT 'Limites SN' AS tabela, COUNT(*) AS total\\r\\nFROM gessimples.bcadastro_ref_limite_sn\\r\\nUNION ALL\\r\\nSELECT 'Fato Gerador por Ano', COUNT(*)\\r\\nFROM gessimples.bcadastro_fato_gerador_por_ano\\r\\nUNION ALL\\r\\nSELECT 'PA Fato Determinado', COUNT(*)\\r\\nFROM gessimples.bcadastro_pa_fato_determinado\\r\\nUNION ALL\\r\\nSELECT 'Per\\u00edodos com Fato', COUNT(*)\\r\\nFROM gessimples.bcadastro_tab_periodo_rba;\"], \"aceSize\": 100, \"status\": \"available\", \"statusForButtons\": \"executed\", \"properties\": {\"settings\": []}, \"viewSettings\": {\"placeHolder\": \"Exemplo: SELECT * FROM tablename ou pressione CTRL + espa\\u00e7o\", \"sqlDialect\": true}, \"variables\": [], \"hasCurlyBracketParameters\": true, \"variableNames\": [], \"variableValues\": {}, \"statement\": \"\\r\\nCREATE TABLE gessimples.bcadastro_tab_periodo_rba STORED AS PARQUET AS\\r\\nSELECT \\r\\n    r.cnpj_raiz,\\r\\n    r.cpf,\\r\\n    r.pa,\\r\\n    r.vl_rba_pgdas,\\r\\n    r.vl_icms,\\r\\n    r.vl_icms_12m,\\r\\n    r.vl_ativ,\\r\\n    r.vl_rpa_int,\\r\\n    r.pa_resp,\\r\\n    r.qualificacao,\\r\\n    r.dt_ini_qualificacao,\\r\\n    r.periodo_ini_sn,\\r\\n    r.periodo_fim_sn,\\r\\n    r.pa_fin_sn,\\r\\n    r.uf,\\r\\n    r.num_grupo,\\r\\n    r.qte_cnpj,\\r\\n    \\r\\n    -- Dados do fato gerador\\r\\n    fg.pa_fato,\\r\\n    fg.pa_fato_2021,\\r\\n    fg.pa_fato_2022,\\r\\n    fg.pa_fato_2023,\\r\\n    fg.pa_fato_2024,\\r\\n    fg.pa_fato_2025,\\r\\n    \\r\\n    -- RBA do grupo no PA do fato\\r\\n    rg.vl_rba_grupo AS receita_pa_fato,\\r\\n    \\r\\n    CURRENT_TIMESTAMP() AS dt_carga\\r\\n\\r\\nFROM gessimples.bcadastro_tab_raiz_cpf_pai r\\r\\nINNER JOIN gessimples.bcadastro_pa_fato_determinado fg\\r\\n    ON r.cpf = fg.cpf\\r\\n    AND r.num_grupo = fg.num_grupo\\r\\nINNER JOIN gessimples.bcadastro_rba_grupo_cpf_pa rg\\r\\n    ON r.cpf = rg.cpf\\r\\n    AND r.pa = rg.pa\\r\\nWHERE CAST(r.pa AS STRING) = fg.pa_fato;\", \"result\": {\"id\": \"7101eb81-29c9-baeb-ce90-0ca59a2e92c3\", \"type\": \"table\", \"hasResultset\": true, \"handle\": {\"secret\": \"sRPP64McSHW1Qq/tgvbVkA==\", \"guid\": \"VJzex9cqSoQAAAAAoS3Vfg==\", \"operation_type\": 0, \"has_result_set\": true, \"modified_row_count\": null, \"log_context\": null, \"session_guid\": \"c4418419d7ed1cbd:1bb36ce8990349a8\", \"session_id\": 21854, \"session_type\": \"impala\", \"statement_id\": 2, \"has_more_statements\": false, \"statements_count\": 3, \"previous_statement_hash\": \"471aeccbdfa2582ae024124d76c5464f81090363fc40b35ba8247800\", \"start\": {\"row\": 47, \"column\": 0}, \"end\": {\"row\": 60, \"column\": 41}, \"statement\": \"-- ============================================================================\\n-- VALIDA\\u00c7\\u00d5ES\\n-- ============================================================================\\nSELECT 'Limites SN' AS tabela, COUNT(*) AS total\\nFROM gessimples.bcadastro_ref_limite_sn\\nUNION ALL\\nSELECT 'Fato Gerador por Ano', COUNT(*)\\nFROM gessimples.bcadastro_fato_gerador_por_ano\\nUNION ALL\\nSELECT 'PA Fato Determinado', COUNT(*)\\nFROM gessimples.bcadastro_pa_fato_determinado\\nUNION ALL\\nSELECT 'Per\\u00edodos com Fato', COUNT(*)\\nFROM gessimples.bcadastro_tab_periodo_rba\"}, \"meta\": [], \"rows\": 4, \"hasMore\": false, \"statement_id\": 2, \"statement_range\": {\"start\": {\"row\": 47, \"column\": 0}, \"end\": {\"row\": 60, \"column\": 41}}, \"statements_count\": 3, \"metaFilter\": {\"query\": \"\", \"facets\": {}, \"text\": []}, \"isMetaFilterVisible\": false, \"filteredMetaChecked\": true, \"filteredColumnCount\": 2, \"filteredMeta\": [{\"type\": \"int\", \"name\": \"\", \"comment\": null, \"cssClass\": \"sort-numeric\", \"checked\": true, \"originalIndex\": 0}, {\"name\": \"tabela\", \"type\": \"string\", \"comment\": null, \"cssClass\": \"sort-string\", \"checked\": true, \"originalIndex\": 1}, {\"name\": \"total\", \"type\": \"bigint\", \"comment\": null, \"cssClass\": \"sort-numeric\", \"checked\": true, \"originalIndex\": 2}], \"fetchedOnce\": false, \"startTime\": \"2025-10-21T12:23:58.354Z\", \"endTime\": \"2025-10-21T12:23:58.529Z\", \"executionTime\": 175, \"data\": [], \"explanation\": \"\", \"logs\": \"\", \"logLines\": 2, \"hasSomeResults\": true}, \"showGrid\": true, \"showChart\": false, \"showLogs\": true, \"progress\": 0, \"jobs\": [], \"executeNextTimeout\": 22236, \"isLoading\": false, \"resultsKlass\": \"results impala\", \"errorsKlass\": \"results impala alert alert-error\", \"is_redacted\": true, \"chartType\": \"bars\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null, \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartLimits\": [5, 10, 25, 50, 100], \"chartLimit\": null, \"chartX\": \"tabela\", \"chartXPivot\": null, \"chartYSingle\": null, \"chartYMulti\": [\"total\"], \"chartData\": [], \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"hideStacked\": true, \"hasDataForChart\": true, \"previousChartOptions\": {\"chartLimit\": null, \"chartX\": \"summary\", \"chartXPivot\": null, \"chartYSingle\": null, \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"chartYMulti\": [], \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null}, \"isResultSettingsVisible\": false, \"settingsVisible\": false, \"checkStatusTimeout\": null, \"getLogsTimeout\": 22501, \"topRisk\": null, \"suggestion\": \"\", \"hasSuggestion\": null, \"compatibilityCheckRunning\": false, \"compatibilitySourcePlatforms\": [{\"name\": \"Teradata\", \"value\": \"teradata\"}, {\"name\": \"Oracle\", \"value\": \"oracle\"}, {\"name\": \"Netezza\", \"value\": \"netezza\"}, {\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}, {\"name\": \"DB2\", \"value\": \"db2\"}, {\"name\": \"Greenplum\", \"value\": \"greenplum\"}, {\"name\": \"MySQL\", \"value\": \"mysql\"}, {\"name\": \"PostgreSQL\", \"value\": \"postgresql\"}, {\"name\": \"Informix\", \"value\": \"informix\"}, {\"name\": \"SQL Server\", \"value\": \"sqlserver\"}, {\"name\": \"Sybase\", \"value\": \"sybase\"}, {\"name\": \"Access\", \"value\": \"access\"}, {\"name\": \"Firebird\", \"value\": \"firebird\"}, {\"name\": \"ANSISQL\", \"value\": \"ansisql\"}, {\"name\": \"Generic\", \"value\": \"generic\"}], \"compatibilitySourcePlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"compatibilityTargetPlatforms\": [{\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}], \"compatibilityTargetPlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"showSqlAnalyzer\": false, \"wasBatchExecuted\": false, \"isReady\": true, \"lastExecuted\": 1761049437991, \"lastAceSelectionRowOffset\": 184, \"executingBlockingOperation\": null, \"showLongOperationWarning\": false, \"lastExecutedStatements\": \"-- ----------------------------------------------------------------------------\\r\\n-- 3.4. JUNTAR COM DADOS INDIVIDUAIS DE CNPJ_RAIZ+CPF+PA\\r\\n-- Para cada grupo, pegar os dados de cada empresa no PA do fato\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS gessimples.bcadastro_tab_periodo_rba;\\r\\nCREATE TABLE gessimples.bcadastro_tab_periodo_rba STORED AS PARQUET AS\\r\\nSELECT \\r\\n    r.cnpj_raiz,\\r\\n    r.cpf,\\r\\n    r.pa,\\r\\n    r.vl_rba_pgdas,\\r\\n    r.vl_icms,\\r\\n    r.vl_icms_12m,\\r\\n    r.vl_ativ,\\r\\n    r.vl_rpa_int,\\r\\n    r.pa_resp,\\r\\n    r.qualificacao,\\r\\n    r.dt_ini_qualificacao,\\r\\n    r.periodo_ini_sn,\\r\\n    r.periodo_fim_sn,\\r\\n    r.pa_fin_sn,\\r\\n    r.uf,\\r\\n    r.num_grupo,\\r\\n    r.qte_cnpj,\\r\\n    \\r\\n    -- Dados do fato gerador\\r\\n    fg.pa_fato,\\r\\n    fg.pa_fato_2021,\\r\\n    fg.pa_fato_2022,\\r\\n    fg.pa_fato_2023,\\r\\n    fg.pa_fato_2024,\\r\\n    fg.pa_fato_2025,\\r\\n    \\r\\n    -- RBA do grupo no PA do fato\\r\\n    rg.vl_rba_grupo AS receita_pa_fato,\\r\\n    \\r\\n    CURRENT_TIMESTAMP() AS dt_carga\\r\\n\\r\\nFROM gessimples.bcadastro_tab_raiz_cpf_pai r\\r\\nINNER JOIN gessimples.bcadastro_pa_fato_determinado fg\\r\\n    ON r.cpf = fg.cpf\\r\\n    AND r.num_grupo = fg.num_grupo\\r\\nINNER JOIN gessimples.bcadastro_rba_grupo_cpf_pa rg\\r\\n    ON r.cpf = rg.cpf\\r\\n    AND r.pa = rg.pa\\r\\nWHERE CAST(r.pa AS STRING) = fg.pa_fato;\\r\\n\\r\\n-- ============================================================================\\r\\n-- VALIDA\\u00c7\\u00d5ES\\r\\n-- ============================================================================\\r\\nSELECT 'Limites SN' AS tabela, COUNT(*) AS total\\r\\nFROM gessimples.bcadastro_ref_limite_sn\\r\\nUNION ALL\\r\\nSELECT 'Fato Gerador por Ano', COUNT(*)\\r\\nFROM gessimples.bcadastro_fato_gerador_por_ano\\r\\nUNION ALL\\r\\nSELECT 'PA Fato Determinado', COUNT(*)\\r\\nFROM gessimples.bcadastro_pa_fato_determinado\\r\\nUNION ALL\\r\\nSELECT 'Per\\u00edodos com Fato', COUNT(*)\\r\\nFROM gessimples.bcadastro_tab_periodo_rba;\", \"lastExecutedSelectionRange\": {\"start\": {\"row\": 184, \"column\": 0}, \"end\": {\"row\": 244, \"column\": 42}}, \"formatEnabled\": true, \"isFetchingData\": false, \"isCanceling\": false, \"aceAutoExpand\": false, \"lastCheckStatusRequest\": {\"readyState\": 4, \"responseText\": \"{\\\"status\\\": 0, \\\"query_status\\\": {\\\"status\\\": \\\"available\\\"}}\", \"responseJSON\": {\"status\": 0, \"query_status\": {\"status\": \"available\"}}, \"status\": 200, \"statusText\": \"OK\"}, \"lastGetLogsRequest\": {\"readyState\": 4, \"responseText\": \"{\\\"status\\\": 0, \\\"logs\\\": \\\"Query 844a2ad7c7de9c54:7ed52da100000000 100% Complete (16 out of 16)\\\", \\\"progress\\\": 100, \\\"jobs\\\": [{\\\"name\\\": \\\"844a2ad7c7de9c54:7ed52da100000000\\\", \\\"url\\\": \\\"/hue/jobbrowser#!id=844a2ad7c7de9c54:7ed52da100000000\\\", \\\"started\\\": true, \\\"finished\\\": false, \\\"percentJob\\\": 100}], \\\"isFullLogs\\\": false}\", \"responseJSON\": {\"status\": 0, \"logs\": \"Query 844a2ad7c7de9c54:7ed52da100000000 100% Complete (16 out of 16)\", \"progress\": 100, \"jobs\": [{\"name\": \"844a2ad7c7de9c54:7ed52da100000000\", \"url\": \"/hue/jobbrowser#!id=844a2ad7c7de9c54:7ed52da100000000\", \"started\": true, \"finished\": false, \"percentJob\": 100}], \"isFullLogs\": false}, \"status\": 200, \"statusText\": \"OK\"}}], \"selectedSnippet\": \"impala\", \"creatingSessionLocks\": [], \"sessions\": [], \"directoryUuid\": \"\", \"dependentsCoordinator\": [], \"historyFilter\": \"\", \"historyFilterVisible\": false, \"loadingHistory\": false, \"historyInitialHeight\": 15951, \"forceHistoryInitialHeight\": false, \"historyCurrentPage\": 1, \"historyTotalPages\": 152, \"schedulerViewModel\": null, \"schedulerViewModelIsLoaded\": false, \"isBatchable\": true, \"isExecutingAll\": false, \"executingAllIndex\": 0, \"retryModalConfirm\": null, \"retryModalCancel\": null, \"canSave\": true, \"unloaded\": false, \"updateHistoryFailed\": false, \"viewSchedulerId\": \"\", \"loadingScheduler\": false}",
    "extra": "",
    "search": "-- ============================================================================\r\n-- SCRIPT 03: DETECÇÃO DE FATO GERADOR - 100% ADERENTE AO ACL\r\n-- Tempo estimado: 15-20 minutos\r\n-- Baseado em: Lógica PA_FATO_2021/XXXX-XXXX-XXXX-XXXX do ACL\r\n-- ============================================================================\r\n\r\n-- ----------------------------------------------------------------------------\r\n-- 3.1. TABELA DE LIMITES SIMPLES NACIONAL\r\n-- ----------------------------------------------------------------------------\r\nDROP TABLE IF EXISTS gessimples.bcadastro_ref_limite_sn;\r\nCREATE TABLE gessimples.bcadastro_ref_limite_sn (\r\n    periodo_apuracao INT,\r\n    limite_mensal DECIMAL(15,2),\r\n    limite_anual DECIMAL(15,2)\r\n)\r\nSTORED AS PARQUET;\r\n\r\n-- Inserir limites conforme ACL (sintaxe compatível com Impala)\r\nINSERT INTO gessimples.bcadastro_ref_limite_sn VALUES\r\n(202101, 5760000.00, 4800000.00),\r\n(202102, 5760000.00, 4800000.00),\r\n(202103, 5760000.00, 4800000.00),\r\n(202104, 5760000.00, 4800000.00),\r\n(202105, 5760000.00, 4800000.00),\r\n(202106, 5760000.00, 4800000.00),\r\n(202107, 5760000.00, 4800000.00),\r\n(202108, 5760000.00, 4800000.00),\r\n(202109, 5760000.00, 4800000.00),\r\n(202110, 5760000.00, 4800000.00),\r\n(202111, 5760000.00, 4800000.00),\r\n(202112, 4800000.00, 4800000.00),\r\n(202201, 5760000.00, 4800000.00),\r\n(202202, 5760000.00, 4800000.00),\r\n(202203, 5760000.00, 4800000.00),\r\n(202204, 5760000.00, 4800000.00),\r\n(202205, 5760000.00, 4800000.00),\r\n(202206, 5760000.00, 4800000.00),\r\n(202207, 5760000.00, 4800000.00),\r\n(202208, 5760000.00, 4800000.00),\r\n(202209, 5760000.00, 4800000.00),\r\n(202210, 5760000.00, 4800000.00),\r\n(202211, 5760000.00, 4800000.00),\r\n(202212, 4800000.00, 4800000.00),\r\n(202301, 5760000.00, 4800000.00),\r\n(202302, 5760000.00, 4800000.00),\r\n(202303, 5760000.00, 4800000.00),\r\n(202304, 5760000.00, 4800000.00),\r\n(202305, 5760000.00, 4800000.00),\r\n(202306, 5760000.00, 4800000.00),\r\n(202307, 5760000.00, 4800000.00),\r\n(202308, 5760000.00, 4800000.00),\r\n(20",
    "last_modified": "2025-10-21T09:24:20.693",
    "version": 1,
    "is_history": false,
    "is_managed": false,
    "is_trashed": false,
    "parent_directory": [
      "38597e6c-aa1b-4e22-9133-e97cdfaf3585",
      1,
      false
    ],
    "dependencies": []
  }
},
{
  "model": "desktop.document2",
  "pk": 164437,
  "fields": {
    "owner": [
      "tsevero"
    ],
    "name": "BCADASTRO",
    "description": "",
    "uuid": "38597e6c-aa1b-4e22-9133-e97cdfaf3585",
    "type": "directory",
    "connector": null,
    "data": "{}",
    "extra": "",
    "search": null,
    "last_modified": "2025-10-14T18:31:48.307",
    "version": 1,
    "is_history": false,
    "is_managed": false,
    "is_trashed": false,
    "parent_directory": [
      "a8280168-7cf2-40b1-bc5d-733014ae6ba9",
      1,
      false
    ],
    "dependencies": []
  }
},
{
  "model": "desktop.document2",
  "pk": 166678,
  "fields": {
    "owner": [
      "tsevero"
    ],
    "name": "BCADASTRO: 4 OUTPUT FINAL",
    "description": "",
    "uuid": "11a539f4-4602-226c-7fad-dc16abe5cb15",
    "type": "query-impala",
    "connector": null,
    "data": "{\"id\": 166678, \"uuid\": \"11a539f4-4602-226c-7fad-dc16abe5cb15\", \"name\": \"BCADASTRO: 4 OUTPUT FINAL\", \"description\": \"\", \"type\": \"query-impala\", \"initialType\": \"impala\", \"coordinatorUuid\": null, \"isHistory\": false, \"isManaged\": false, \"parentSavedQueryUuid\": null, \"isSaved\": true, \"onSuccessUrl\": null, \"pubSubUrl\": null, \"isPresentationModeDefault\": false, \"isPresentationMode\": false, \"isPresentationModeInitialized\": true, \"presentationSnippets\": {}, \"isHidingCode\": false, \"snippets\": [{\"id\": \"a5bcae27-2e02-a35b-3d91-161f83dbcfca\", \"name\": \"\", \"type\": \"impala\", \"connector\": {\"name\": \"Impala\", \"type\": \"impala\", \"id\": \"impala\", \"displayName\": \"Impala\", \"buttonName\": \"Consulta\", \"tooltip\": \"Impala Query\", \"optimizer\": \"off\", \"page\": \"/editor/?type=impala\", \"is_sql\": true, \"is_batchable\": true, \"dialect\": \"impala\", \"dialect_properties\": {}}, \"isSqlDialect\": true, \"dialect\": \"impala\", \"isBatchable\": true, \"autocompleteSettings\": {\"temporaryOnly\": false}, \"aceCursorPosition\": {\"row\": 411, \"column\": 22}, \"errors\": [], \"aceErrorsHolder\": [], \"aceWarningsHolder\": [], \"aceErrors\": [], \"aceWarnings\": [], \"editorMode\": true, \"dbSelectionVisible\": false, \"showExecutionAnalysis\": false, \"namespace\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"status\": \"CREATED\", \"computes\": [{\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"type\": \"direct\", \"credentials\": {}}]}, \"compute\": {\"id\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"name\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"namespace\": \"8271bb54-0cd9-47e1-89f2-a8a5de91d943\", \"interface\": \"impala\", \"type\": \"direct\", \"options\": {}}, \"database\": \"gessimples\", \"currentQueryTab\": \"savedQueries\", \"pinnedContextTabs\": [], \"loadingQueries\": false, \"queriesHasErrors\": false, \"queriesCurrentPage\": 1, \"queriesTotalPages\": 3, \"queriesFilter\": \"\", \"queriesFilterVisible\": false, \"statementType\": \"text\", \"statementTypes\": [\"text\", \"file\"], \"statementPath\": \"\", \"externalStatementLoaded\": false, \"associatedDocumentLoading\": true, \"associatedDocumentUuid\": null, \"statement_raw\": \"-- ============================================================================\\r\\n-- SCRIPT 04: OUTPUT FINAL - 100% FORMATO ACL\\r\\n-- Tempo estimado: 15-20 minutos\\r\\n-- Baseado em: TAB_RESULTADO_FINAL_INC_TERC_SC do ACL\\r\\n-- Inclui c\\u00e1lculo de VL_CT (Cr\\u00e9dito Tribut\\u00e1rio) com SELIC\\r\\n-- ============================================================================\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 4.1. IMPORTAR TABELA SELIC\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS gessimples.bcadastro_selic;\\r\\nCREATE TABLE gessimples.bcadastro_selic STORED AS PARQUET AS\\r\\nSELECT \\r\\n    tis_referencia AS pa,\\r\\n    tis_vl_indice AS taxa_selic\\r\\nFROM usr_sat_ctacte.tab_indice\\r\\nWHERE tid_nom_indice = 'SELIC'\\r\\n  AND tis_referencia >= 202101\\r\\n  AND tis_referencia <= 202512;\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 4.2. CALCULAR ICMS ESTIMADO E VL_CT POR CNPJ+PA\\r\\n-- ACL: tVL_ICMS_ESTIMADO, VL_JUROS, VL_MULTA, VL_CT\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS gessimples.bcadastro_icms_estimado_por_pa;\\r\\nCREATE TABLE gessimples.bcadastro_icms_estimado_por_pa STORED AS PARQUET AS\\r\\nSELECT \\r\\n    r.cnpj_raiz,\\r\\n    r.cpf,\\r\\n    r.pa,\\r\\n    r.num_grupo,\\r\\n    r.pa_resp,\\r\\n    r.pa_fato,\\r\\n    r.uf,\\r\\n    r.vl_ativ,\\r\\n    r.vl_icms,\\r\\n    r.pa_fin_sn,\\r\\n    \\r\\n    -- Qtde meses retroativos (placeholder - calcular depois)\\r\\n    0 AS qte_mes_retroativo,\\r\\n    \\r\\n    -- tVL_ICMS_ESTIMADO (ACL)\\r\\n    CASE \\r\\n        WHEN r.vl_icms > 0.00\\r\\n             AND r.pa_resp <= CAST(r.pa AS STRING)\\r\\n             AND r.pa_resp <= r.pa_fato\\r\\n             AND r.uf = 'SC'\\r\\n        THEN ((r.vl_ativ * 0.07) - r.vl_icms)\\r\\n        ELSE 0.00\\r\\n    END AS tvl_icms_estimado,\\r\\n    \\r\\n    s.taxa_selic,\\r\\n    \\r\\n    CURRENT_TIMESTAMP() AS dt_carga\\r\\n\\r\\nFROM gessimples.bcadastro_tab_periodo_rba r  -- <-- MUDAN\\u00c7A AQUI\\r\\nLEFT JOIN gessimples.bcadastro_selic s\\r\\n    ON r.pa = s.pa\\r\\nWHERE r.num_grupo IS NOT NULL;\\r\\n\\r\\n-- Aplicar filtro ACL: s\\u00f3 estimar se est\\u00e1 no per\\u00edodo correto\\r\\nDROP TABLE IF EXISTS gessimples.bcadastro_icms_estimado_filtrado;\\r\\nCREATE TABLE gessimples.bcadastro_icms_estimado_filtrado STORED AS PARQUET AS\\r\\nSELECT \\r\\n    *,\\r\\n    \\r\\n    -- VL_ICMS_ESTIMADO (ACL: s\\u00f3 se PA est\\u00e1 entre PA_FATO_INI e PA_FATO_FIN)\\r\\n    CASE \\r\\n        WHEN tvl_icms_estimado > 0\\r\\n             AND (\\r\\n                 -- Se PA_FIN_SN = \\\"-\\\" (ainda ativo)\\r\\n                 (pa_fin_sn IS NULL AND CAST(pa AS STRING) >= pa_fato)\\r\\n                 OR \\r\\n                 -- Se tem PA_FIN_SN definido\\r\\n                 (pa_fin_sn IS NOT NULL AND CAST(pa AS STRING) > pa_fato AND CAST(pa AS STRING) <= pa_fin_sn)\\r\\n             )\\r\\n        THEN tvl_icms_estimado\\r\\n        ELSE 0.00\\r\\n    END AS vl_icms_estimado,\\r\\n    \\r\\n    -- VL_JUROS (ACL)\\r\\n    CASE \\r\\n        WHEN tvl_icms_estimado > 0 AND taxa_selic IS NOT NULL\\r\\n        THEN (tvl_icms_estimado * taxa_selic) / 100.00\\r\\n        ELSE 0.00\\r\\n    END AS vl_juros,\\r\\n    \\r\\n    -- VL_MULTA (ACL: 20%)\\r\\n    CASE \\r\\n        WHEN tvl_icms_estimado > 0\\r\\n        THEN tvl_icms_estimado * 0.2\\r\\n        ELSE 0.00\\r\\n    END AS vl_multa\\r\\n\\r\\nFROM gessimples.bcadastro_icms_estimado_por_pa;\\r\\n\\r\\n-- Calcular VL_CT\\r\\nDROP TABLE IF EXISTS gessimples.bcadastro_icms_com_ct;\\r\\nCREATE TABLE gessimples.bcadastro_icms_com_ct STORED AS PARQUET AS\\r\\nSELECT \\r\\n    *,\\r\\n    \\r\\n    -- VL_CT (ACL)\\r\\n    CASE \\r\\n        WHEN vl_icms_estimado > 0.00\\r\\n        THEN vl_icms_estimado + vl_juros + vl_multa\\r\\n        ELSE 0.00\\r\\n    END AS vl_ct\\r\\n\\r\\nFROM gessimples.bcadastro_icms_estimado_filtrado;\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 4.3. CONSOLIDAR VL_CT POR CNPJ_RAIZ (SOMA DE TODOS OS PAs)\\r\\n-- ACL: TAB_ICMS_COBRAR\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS gessimples.bcadastro_icms_cobrar;\\r\\nCREATE TABLE gessimples.bcadastro_icms_cobrar STORED AS PARQUET AS\\r\\nSELECT \\r\\n    cnpj_raiz,\\r\\n    cpf,\\r\\n    num_grupo,\\r\\n    uf,\\r\\n    \\r\\n    SUM(vl_icms_estimado) AS vl_icms_estimado_total,\\r\\n    SUM(vl_juros) AS vl_juros_total,\\r\\n    SUM(vl_multa) AS vl_multa_total,\\r\\n    SUM(vl_ct) AS vl_ct_total,\\r\\n    \\r\\n    CURRENT_TIMESTAMP() AS dt_carga\\r\\n\\r\\nFROM gessimples.bcadastro_icms_com_ct\\r\\nGROUP BY \\r\\n    cnpj_raiz,\\r\\n    cpf,\\r\\n    num_grupo,\\r\\n    uf;\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 4.4. TABELA FINAL - FORMATO ACL COMPLETO\\r\\n-- TAB_RESULTADO_FINAL_INC_TERC_SC\\r\\n-- ----------------------------------------------------------------------------\\r\\n\\r\\n-- Primeiro, criar uma tabela auxiliar com QTE_SOCIO por grupo\\r\\nDROP TABLE IF EXISTS gessimples.bcadastro_qte_socio_grupo;\\r\\nCREATE TABLE gessimples.bcadastro_qte_socio_grupo STORED AS PARQUET AS\\r\\nSELECT \\r\\n    num_grupo,\\r\\n    COUNT(DISTINCT cpf) AS qte_socio\\r\\nFROM gessimples.bcadastro_tab_raiz_cpf_pai\\r\\nWHERE num_grupo IS NOT NULL\\r\\nGROUP BY num_grupo;\\r\\n\\r\\n-- PASSO 1: Deduplica bcadastro_tab_periodo_rba (origem do problema)\\r\\nDROP TABLE IF EXISTS gessimples.bcadastro_tab_periodo_rba_clean;\\r\\nCREATE TABLE gessimples.bcadastro_tab_periodo_rba_clean STORED AS PARQUET AS\\r\\nSELECT \\r\\n    cnpj_raiz,\\r\\n    cpf,\\r\\n    pa,\\r\\n    num_grupo,\\r\\n    qte_cnpj,\\r\\n    pa_fato,\\r\\n    pa_fato_2021,\\r\\n    pa_fato_2022,\\r\\n    pa_fato_2023,\\r\\n    pa_fato_2024,\\r\\n    pa_fato_2025,\\r\\n    vl_rba_pgdas,\\r\\n    receita_pa_fato,\\r\\n    vl_icms,\\r\\n    vl_icms_12m,\\r\\n    vl_ativ,\\r\\n    vl_rpa_int,\\r\\n    pa_resp,\\r\\n    qualificacao,\\r\\n    dt_ini_qualificacao,\\r\\n    periodo_ini_sn,\\r\\n    periodo_fim_sn,\\r\\n    pa_fin_sn,\\r\\n    uf,\\r\\n    dt_carga\\r\\nFROM (\\r\\n    SELECT \\r\\n        *,\\r\\n        ROW_NUMBER() OVER (\\r\\n            PARTITION BY num_grupo, cnpj_raiz, cpf, pa_fato\\r\\n            ORDER BY vl_rba_pgdas DESC, receita_pa_fato DESC, pa DESC\\r\\n        ) AS rn\\r\\n    FROM gessimples.bcadastro_tab_periodo_rba\\r\\n) sub\\r\\nWHERE rn = 1;\\r\\n\\r\\n-- PASSO 2: Criar output final COM deduplica\\u00e7\\u00e3o adicional\\r\\nDROP TABLE IF EXISTS gessimples.bcadastro_output_final_acl;\\r\\nCREATE TABLE gessimples.bcadastro_output_final_acl STORED AS PARQUET AS\\r\\nWITH dados_base AS (\\r\\n    SELECT \\r\\n        -- Dados do Grupo\\r\\n        t.num_grupo AS NUM_GRUPO,\\r\\n        t.qte_cnpj AS QTE_CNPJ,\\r\\n        \\r\\n        -- QTE_SOCIO\\r\\n        COALESCE(qs.qte_socio, 0) AS QTE_SOCIO,\\r\\n        \\r\\n        -- Valores\\r\\n        COALESCE(ic.vl_ct_total, 0.00) AS VL_CT,\\r\\n        t.vl_rba_pgdas AS VL_RBA_PGDAS,\\r\\n        t.receita_pa_fato AS RECEITA_PA_FATO,\\r\\n        \\r\\n        -- Dados da Empresa\\r\\n        bc.cnpj_completo AS CNPJ,\\r\\n        t.cnpj_raiz AS CNPJ_RAIZ,\\r\\n        t.cpf AS CPF,\\r\\n        t.uf AS UF,\\r\\n        \\r\\n        -- Datas e Qualifica\\u00e7\\u00e3o\\r\\n        CAST(t.dt_ini_qualificacao AS STRING) AS DT_INI_QUALIFICACAO,\\r\\n        t.qualificacao AS QUALIFICACAO,\\r\\n        \\r\\n        -- Regime\\r\\n        CASE \\r\\n            WHEN t.pa_fin_sn IS NULL OR t.pa_fato <= t.pa_fin_sn\\r\\n            THEN 'SN'\\r\\n            ELSE 'NL'\\r\\n        END AS REGIME_NO_EFEITO,\\r\\n        \\r\\n        -- FLAG_PERIODO\\r\\n        CASE \\r\\n            WHEN t.pa_fato_2021 != 'SN' AND t.pa_fato_2022 = 'SN' THEN '21'\\r\\n            WHEN t.pa_fato_2021 != 'SN' AND t.pa_fato_2022 != 'SN' AND t.pa_fato_2023 = 'SN' THEN '21-22'\\r\\n            WHEN t.pa_fato_2021 != 'SN' AND t.pa_fato_2022 != 'SN' AND t.pa_fato_2023 != 'SN' AND t.pa_fato_2024 = 'SN' THEN '21-22-23'\\r\\n            WHEN t.pa_fato_2021 != 'SN' AND t.pa_fato_2022 != 'SN' AND t.pa_fato_2023 != 'SN' AND t.pa_fato_2024 != 'SN' AND t.pa_fato_2025 = 'SN' THEN '21-22-23-24'\\r\\n            WHEN t.pa_fato_2021 != 'SN' AND t.pa_fato_2022 != 'SN' AND t.pa_fato_2023 != 'SN' AND t.pa_fato_2024 != 'SN' AND t.pa_fato_2025 != 'SN' THEN '21-22-23-24-25'\\r\\n            WHEN t.pa_fato_2022 != 'SN' AND t.pa_fato_2023 = 'SN' THEN '22'\\r\\n            WHEN t.pa_fato_2022 != 'SN' AND t.pa_fato_2023 != 'SN' AND t.pa_fato_2024 = 'SN' THEN '22-23'\\r\\n            WHEN t.pa_fato_2022 != 'SN' AND t.pa_fato_2023 != 'SN' AND t.pa_fato_2024 != 'SN' AND t.pa_fato_2025 = 'SN' THEN '22-23-24'\\r\\n            WHEN t.pa_fato_2022 != 'SN' AND t.pa_fato_2023 != 'SN' AND t.pa_fato_2024 != 'SN' AND t.pa_fato_2025 != 'SN' THEN '22-23-24-25'\\r\\n            WHEN t.pa_fato_2023 != 'SN' AND t.pa_fato_2024 = 'SN' THEN '23'\\r\\n            WHEN t.pa_fato_2023 != 'SN' AND t.pa_fato_2024 != 'SN' AND t.pa_fato_2025 = 'SN' THEN '23-24'\\r\\n            WHEN t.pa_fato_2023 != 'SN' AND t.pa_fato_2024 != 'SN' AND t.pa_fato_2025 != 'SN' THEN '23-24-25'\\r\\n            WHEN t.pa_fato_2024 != 'SN' AND t.pa_fato_2025 = 'SN' THEN '24'\\r\\n            WHEN t.pa_fato_2024 != 'SN' AND t.pa_fato_2025 != 'SN' THEN '24-25'\\r\\n            WHEN t.pa_fato_2025 != 'SN' THEN '25'\\r\\n            ELSE 'TODOS'\\r\\n        END AS FLAG_PERIODO,\\r\\n        \\r\\n        -- Per\\u00edodos do Fato\\r\\n        t.pa_fato AS DT_FATO,\\r\\n        \\r\\n        -- DT_EFEITO\\r\\n        CASE \\r\\n            WHEN CAST(t.pa AS INT) % 100 = 12 \\r\\n            THEN CAST((CAST(t.pa AS INT) / 100 + 1) * 100 + 1 AS STRING)\\r\\n            ELSE CAST(CAST(t.pa AS INT) + 1 AS STRING)\\r\\n        END AS DT_EFEITO,\\r\\n        \\r\\n        t.pa_fato AS PA_FATO_INI,\\r\\n        CASE \\r\\n            WHEN t.pa_fin_sn IS NULL THEN '-'\\r\\n            ELSE t.pa_fin_sn\\r\\n        END AS PA_FATO_FIN,\\r\\n        \\r\\n        CASE \\r\\n            WHEN t.pa_fin_sn IS NULL THEN ''\\r\\n            ELSE t.pa_fin_sn\\r\\n        END AS PA_FIN_RESP,\\r\\n        \\r\\n        t.pa_resp AS PA_RESP,\\r\\n        \\r\\n        -- Chave \\u00fanica\\r\\n        CONCAT(\\r\\n            LPAD(t.cpf, 11, '0'),\\r\\n            LPAD(t.cnpj_raiz, 8, '0'),\\r\\n            t.pa_fato\\r\\n        ) AS CHAVE_CPF_RAIZ_PA,\\r\\n        \\r\\n        -- EMITE_TE_SC\\r\\n        CASE \\r\\n            WHEN t.uf = 'SC' \\r\\n                 AND (t.pa_fin_sn IS NULL OR t.pa_fato <= t.pa_fin_sn)\\r\\n                 AND COALESCE(ic.vl_ct_total, 0) > 0\\r\\n            THEN 'S'\\r\\n            ELSE 'N'\\r\\n        END AS EMITE_TE_SC,\\r\\n        \\r\\n        -- EMITE_TE\\r\\n        CASE \\r\\n            WHEN (t.pa_fin_sn IS NULL OR t.pa_fato <= t.pa_fin_sn)\\r\\n                 AND COALESCE(ic.vl_ct_total, 0) > 0\\r\\n            THEN 'S'\\r\\n            ELSE 'N'\\r\\n        END AS EMITE_TE,\\r\\n        \\r\\n        -- ACAO\\r\\n        CASE \\r\\n            WHEN COALESCE(ic.vl_ct_total, 0) > 0 \\r\\n                 AND t.uf = 'SC'\\r\\n                 AND (t.pa_fin_sn IS NULL OR t.pa_fato <= t.pa_fin_sn)\\r\\n            THEN 'EXCLUSAO_COM_DEBITO'\\r\\n            WHEN COALESCE(ic.vl_ct_total, 0) = 0 \\r\\n                 AND t.uf = 'SC'\\r\\n                 AND (t.pa_fin_sn IS NULL OR t.pa_fato <= t.pa_fin_sn)\\r\\n            THEN 'EXCLUSAO_SEM_DEBITO'\\r\\n            ELSE 'SEM_INTERESSE'\\r\\n        END AS ACAO,\\r\\n        \\r\\n        -- Campos adicionais\\r\\n        bc.razao_social AS RAZAO_SOCIAL,\\r\\n        bc.situacao_cadastral_desc AS SITUACAO_CADASTRAL,\\r\\n        \\r\\n        CURRENT_TIMESTAMP() AS DT_PROCESSAMENTO,\\r\\n        \\r\\n        -- Campo auxiliar para deduplica\\u00e7\\u00e3o final\\r\\n        ROW_NUMBER() OVER (\\r\\n            PARTITION BY t.num_grupo, t.cnpj_raiz\\r\\n            ORDER BY \\r\\n                COALESCE(ic.vl_ct_total, 0) DESC,\\r\\n                t.receita_pa_fato DESC,\\r\\n                t.pa_fato DESC\\r\\n        ) AS row_num\\r\\n        \\r\\n    FROM gessimples.bcadastro_tab_periodo_rba_clean t\\r\\n    INNER JOIN gessimples.bcadastro_base_cnpj_completo bc\\r\\n        ON t.cnpj_raiz = bc.cnpj_raiz\\r\\n    LEFT JOIN gessimples.bcadastro_icms_cobrar ic\\r\\n        ON t.cnpj_raiz = ic.cnpj_raiz\\r\\n        AND t.cpf = ic.cpf\\r\\n        AND t.num_grupo = ic.num_grupo\\r\\n    LEFT JOIN gessimples.bcadastro_qte_socio_grupo qs\\r\\n        ON t.num_grupo = qs.num_grupo\\r\\n)\\r\\nSELECT \\r\\n    NUM_GRUPO,\\r\\n    QTE_CNPJ,\\r\\n    QTE_SOCIO,\\r\\n    VL_CT,\\r\\n    VL_RBA_PGDAS,\\r\\n    RECEITA_PA_FATO,\\r\\n    CNPJ,\\r\\n    CNPJ_RAIZ,\\r\\n    CPF,\\r\\n    UF,\\r\\n    DT_INI_QUALIFICACAO,\\r\\n    QUALIFICACAO,\\r\\n    REGIME_NO_EFEITO,\\r\\n    FLAG_PERIODO,\\r\\n    DT_FATO,\\r\\n    DT_EFEITO,\\r\\n    PA_FATO_INI,\\r\\n    PA_FATO_FIN,\\r\\n    PA_FIN_RESP,\\r\\n    PA_RESP,\\r\\n    CHAVE_CPF_RAIZ_PA,\\r\\n    EMITE_TE_SC,\\r\\n    EMITE_TE,\\r\\n    ACAO,\\r\\n    RAZAO_SOCIAL,\\r\\n    SITUACAO_CADASTRAL,\\r\\n    DT_PROCESSAMENTO\\r\\nFROM dados_base\\r\\nWHERE row_num = 1;  -- <<< DEDUPLICA\\u00c7\\u00c3O FINAL AQUI\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 4.5. ESTAT\\u00cdSTICAS FINAIS\\r\\n-- ----------------------------------------------------------------------------\\r\\nSELECT \\r\\n    'ESTAT\\u00cdSTICAS GERAIS' AS categoria,\\r\\n    COUNT(*) AS total_registros,\\r\\n    COUNT(DISTINCT NUM_GRUPO) AS total_grupos,\\r\\n    COUNT(DISTINCT CNPJ_RAIZ) AS total_empresas,\\r\\n    COUNT(DISTINCT CPF) AS total_socios\\r\\nFROM gessimples.bcadastro_output_final_acl\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    'POR A\\u00c7\\u00c3O' AS categoria,\\r\\n    CAST(NULL AS BIGINT) AS total_registros,\\r\\n    CAST(NULL AS BIGINT) AS total_grupos,\\r\\n    CAST(NULL AS BIGINT) AS total_empresas,\\r\\n    CAST(NULL AS BIGINT) AS total_socios\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    CONCAT('  ', ACAO) AS categoria,\\r\\n    COUNT(*) AS total_registros,\\r\\n    COUNT(DISTINCT NUM_GRUPO) AS total_grupos,\\r\\n    COUNT(DISTINCT CNPJ_RAIZ) AS total_empresas,\\r\\n    COUNT(DISTINCT CPF) AS total_socios\\r\\nFROM gessimples.bcadastro_output_final_acl\\r\\nGROUP BY ACAO\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    'POR FLAG_PERIODO' AS categoria,\\r\\n    CAST(NULL AS BIGINT) AS total_registros,\\r\\n    CAST(NULL AS BIGINT) AS total_grupos,\\r\\n    CAST(NULL AS BIGINT) AS total_empresas,\\r\\n    CAST(NULL AS BIGINT) AS total_socios\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    CONCAT('  ', FLAG_PERIODO) AS categoria,\\r\\n    COUNT(*) AS total_registros,\\r\\n    COUNT(DISTINCT NUM_GRUPO) AS total_grupos,\\r\\n    COUNT(DISTINCT CNPJ_RAIZ) AS total_empresas,\\r\\n    COUNT(DISTINCT CPF) AS total_socios\\r\\nFROM gessimples.bcadastro_output_final_acl\\r\\nGROUP BY FLAG_PERIODO;\", \"statementsList\": [\"-- ============================================================================\\r\\n-- SCRIPT 04: OUTPUT FINAL - 100% FORMATO ACL\\r\\n-- Tempo estimado: 15-20 minutos\\r\\n-- Baseado em: TAB_RESULTADO_FINAL_INC_TERC_SC do ACL\\r\\n-- Inclui c\\u00e1lculo de VL_CT (Cr\\u00e9dito Tribut\\u00e1rio) com SELIC\\r\\n-- ============================================================================\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 4.1. IMPORTAR TABELA SELIC\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS gessimples.bcadastro_selic;\", \"\\r\\nCREATE TABLE gessimples.bcadastro_selic STORED AS PARQUET AS\\r\\nSELECT \\r\\n    tis_referencia AS pa,\\r\\n    tis_vl_indice AS taxa_selic\\r\\nFROM usr_sat_ctacte.tab_indice\\r\\nWHERE tid_nom_indice = 'SELIC'\\r\\n  AND tis_referencia >= 202101\\r\\n  AND tis_referencia <= 202512;\", \"\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 4.2. CALCULAR ICMS ESTIMADO E VL_CT POR CNPJ+PA\\r\\n-- ACL: tVL_ICMS_ESTIMADO, VL_JUROS, VL_MULTA, VL_CT\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS gessimples.bcadastro_icms_estimado_por_pa;\", \"\\r\\nCREATE TABLE gessimples.bcadastro_icms_estimado_por_pa STORED AS PARQUET AS\\r\\nSELECT \\r\\n    r.cnpj_raiz,\\r\\n    r.cpf,\\r\\n    r.pa,\\r\\n    r.num_grupo,\\r\\n    r.pa_resp,\\r\\n    r.pa_fato,\\r\\n    r.uf,\\r\\n    r.vl_ativ,\\r\\n    r.vl_icms,\\r\\n    r.pa_fin_sn,\\r\\n    \\r\\n    -- Qtde meses retroativos (placeholder - calcular depois)\\r\\n    0 AS qte_mes_retroativo,\\r\\n    \\r\\n    -- tVL_ICMS_ESTIMADO (ACL)\\r\\n    CASE \\r\\n        WHEN r.vl_icms > 0.00\\r\\n             AND r.pa_resp <= CAST(r.pa AS STRING)\\r\\n             AND r.pa_resp <= r.pa_fato\\r\\n             AND r.uf = 'SC'\\r\\n        THEN ((r.vl_ativ * 0.07) - r.vl_icms)\\r\\n        ELSE 0.00\\r\\n    END AS tvl_icms_estimado,\\r\\n    \\r\\n    s.taxa_selic,\\r\\n    \\r\\n    CURRENT_TIMESTAMP() AS dt_carga\\r\\n\\r\\nFROM gessimples.bcadastro_tab_periodo_rba r  -- <-- MUDAN\\u00c7A AQUI\\r\\nLEFT JOIN gessimples.bcadastro_selic s\\r\\n    ON r.pa = s.pa\\r\\nWHERE r.num_grupo IS NOT NULL;\", \"\\r\\n\\r\\n-- Aplicar filtro ACL: s\\u00f3 estimar se est\\u00e1 no per\\u00edodo correto\\r\\nDROP TABLE IF EXISTS gessimples.bcadastro_icms_estimado_filtrado;\", \"\\r\\nCREATE TABLE gessimples.bcadastro_icms_estimado_filtrado STORED AS PARQUET AS\\r\\nSELECT \\r\\n    *,\\r\\n    \\r\\n    -- VL_ICMS_ESTIMADO (ACL: s\\u00f3 se PA est\\u00e1 entre PA_FATO_INI e PA_FATO_FIN)\\r\\n    CASE \\r\\n        WHEN tvl_icms_estimado > 0\\r\\n             AND (\\r\\n                 -- Se PA_FIN_SN = \\\"-\\\" (ainda ativo)\\r\\n                 (pa_fin_sn IS NULL AND CAST(pa AS STRING) >= pa_fato)\\r\\n                 OR \\r\\n                 -- Se tem PA_FIN_SN definido\\r\\n                 (pa_fin_sn IS NOT NULL AND CAST(pa AS STRING) > pa_fato AND CAST(pa AS STRING) <= pa_fin_sn)\\r\\n             )\\r\\n        THEN tvl_icms_estimado\\r\\n        ELSE 0.00\\r\\n    END AS vl_icms_estimado,\\r\\n    \\r\\n    -- VL_JUROS (ACL)\\r\\n    CASE \\r\\n        WHEN tvl_icms_estimado > 0 AND taxa_selic IS NOT NULL\\r\\n        THEN (tvl_icms_estimado * taxa_selic) / 100.00\\r\\n        ELSE 0.00\\r\\n    END AS vl_juros,\\r\\n    \\r\\n    -- VL_MULTA (ACL: 20%)\\r\\n    CASE \\r\\n        WHEN tvl_icms_estimado > 0\\r\\n        THEN tvl_icms_estimado * 0.2\\r\\n        ELSE 0.00\\r\\n    END AS vl_multa\\r\\n\\r\\nFROM gessimples.bcadastro_icms_estimado_por_pa;\", \"\\r\\n\\r\\n-- Calcular VL_CT\\r\\nDROP TABLE IF EXISTS gessimples.bcadastro_icms_com_ct;\", \"\\r\\nCREATE TABLE gessimples.bcadastro_icms_com_ct STORED AS PARQUET AS\\r\\nSELECT \\r\\n    *,\\r\\n    \\r\\n    -- VL_CT (ACL)\\r\\n    CASE \\r\\n        WHEN vl_icms_estimado > 0.00\\r\\n        THEN vl_icms_estimado + vl_juros + vl_multa\\r\\n        ELSE 0.00\\r\\n    END AS vl_ct\\r\\n\\r\\nFROM gessimples.bcadastro_icms_estimado_filtrado;\", \"\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 4.3. CONSOLIDAR VL_CT POR CNPJ_RAIZ (SOMA DE TODOS OS PAs)\\r\\n-- ACL: TAB_ICMS_COBRAR\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS gessimples.bcadastro_icms_cobrar;\", \"\\r\\nCREATE TABLE gessimples.bcadastro_icms_cobrar STORED AS PARQUET AS\\r\\nSELECT \\r\\n    cnpj_raiz,\\r\\n    cpf,\\r\\n    num_grupo,\\r\\n    uf,\\r\\n    \\r\\n    SUM(vl_icms_estimado) AS vl_icms_estimado_total,\\r\\n    SUM(vl_juros) AS vl_juros_total,\\r\\n    SUM(vl_multa) AS vl_multa_total,\\r\\n    SUM(vl_ct) AS vl_ct_total,\\r\\n    \\r\\n    CURRENT_TIMESTAMP() AS dt_carga\\r\\n\\r\\nFROM gessimples.bcadastro_icms_com_ct\\r\\nGROUP BY \\r\\n    cnpj_raiz,\\r\\n    cpf,\\r\\n    num_grupo,\\r\\n    uf;\", \"\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 4.4. TABELA FINAL - FORMATO ACL COMPLETO\\r\\n-- TAB_RESULTADO_FINAL_INC_TERC_SC\\r\\n-- ----------------------------------------------------------------------------\\r\\n\\r\\n-- Primeiro, criar uma tabela auxiliar com QTE_SOCIO por grupo\\r\\nDROP TABLE IF EXISTS gessimples.bcadastro_qte_socio_grupo;\"], \"aceSize\": 100, \"status\": \"ready\", \"statusForButtons\": \"executed\", \"properties\": {\"settings\": []}, \"viewSettings\": {\"placeHolder\": \"Exemplo: SELECT * FROM tablename ou pressione CTRL + espa\\u00e7o\", \"sqlDialect\": true}, \"variables\": [], \"hasCurlyBracketParameters\": true, \"variableNames\": [], \"variableValues\": {}, \"statement\": \"-- ============================================================================\\r\\n-- SCRIPT 04: OUTPUT FINAL - 100% FORMATO ACL\\r\\n-- Tempo estimado: 15-20 minutos\\r\\n-- Baseado em: TAB_RESULTADO_FINAL_INC_TERC_SC do ACL\\r\\n-- Inclui c\\u00e1lculo de VL_CT (Cr\\u00e9dito Tribut\\u00e1rio) com SELIC\\r\\n-- ============================================================================\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 4.1. IMPORTAR TABELA SELIC\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS gessimples.bcadastro_selic;\\r\\nCREATE TABLE gessimples.bcadastro_selic STORED AS PARQUET AS\\r\\nSELECT \\r\\n    tis_referencia AS pa,\\r\\n    tis_vl_indice AS taxa_selic\\r\\nFROM usr_sat_ctacte.tab_indice\\r\\nWHERE tid_nom_indice = 'SELIC'\\r\\n  AND tis_referencia >= 202101\\r\\n  AND tis_referencia <= 202512;\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 4.2. CALCULAR ICMS ESTIMADO E VL_CT POR CNPJ+PA\\r\\n-- ACL: tVL_ICMS_ESTIMADO, VL_JUROS, VL_MULTA, VL_CT\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS gessimples.bcadastro_icms_estimado_por_pa;\\r\\nCREATE TABLE gessimples.bcadastro_icms_estimado_por_pa STORED AS PARQUET AS\\r\\nSELECT \\r\\n    r.cnpj_raiz,\\r\\n    r.cpf,\\r\\n    r.pa,\\r\\n    r.num_grupo,\\r\\n    r.pa_resp,\\r\\n    r.pa_fato,\\r\\n    r.uf,\\r\\n    r.vl_ativ,\\r\\n    r.vl_icms,\\r\\n    r.pa_fin_sn,\\r\\n    \\r\\n    -- Qtde meses retroativos (placeholder - calcular depois)\\r\\n    0 AS qte_mes_retroativo,\\r\\n    \\r\\n    -- tVL_ICMS_ESTIMADO (ACL)\\r\\n    CASE \\r\\n        WHEN r.vl_icms > 0.00\\r\\n             AND r.pa_resp <= CAST(r.pa AS STRING)\\r\\n             AND r.pa_resp <= r.pa_fato\\r\\n             AND r.uf = 'SC'\\r\\n        THEN ((r.vl_ativ * 0.07) - r.vl_icms)\\r\\n        ELSE 0.00\\r\\n    END AS tvl_icms_estimado,\\r\\n    \\r\\n    s.taxa_selic,\\r\\n    \\r\\n    CURRENT_TIMESTAMP() AS dt_carga\\r\\n\\r\\nFROM gessimples.bcadastro_tab_periodo_rba r  -- <-- MUDAN\\u00c7A AQUI\\r\\nLEFT JOIN gessimples.bcadastro_selic s\\r\\n    ON r.pa = s.pa\\r\\nWHERE r.num_grupo IS NOT NULL;\\r\\n\\r\\n-- Aplicar filtro ACL: s\\u00f3 estimar se est\\u00e1 no per\\u00edodo correto\\r\\nDROP TABLE IF EXISTS gessimples.bcadastro_icms_estimado_filtrado;\\r\\nCREATE TABLE gessimples.bcadastro_icms_estimado_filtrado STORED AS PARQUET AS\\r\\nSELECT \\r\\n    *,\\r\\n    \\r\\n    -- VL_ICMS_ESTIMADO (ACL: s\\u00f3 se PA est\\u00e1 entre PA_FATO_INI e PA_FATO_FIN)\\r\\n    CASE \\r\\n        WHEN tvl_icms_estimado > 0\\r\\n             AND (\\r\\n                 -- Se PA_FIN_SN = \\\"-\\\" (ainda ativo)\\r\\n                 (pa_fin_sn IS NULL AND CAST(pa AS STRING) >= pa_fato)\\r\\n                 OR \\r\\n                 -- Se tem PA_FIN_SN definido\\r\\n                 (pa_fin_sn IS NOT NULL AND CAST(pa AS STRING) > pa_fato AND CAST(pa AS STRING) <= pa_fin_sn)\\r\\n             )\\r\\n        THEN tvl_icms_estimado\\r\\n        ELSE 0.00\\r\\n    END AS vl_icms_estimado,\\r\\n    \\r\\n    -- VL_JUROS (ACL)\\r\\n    CASE \\r\\n        WHEN tvl_icms_estimado > 0 AND taxa_selic IS NOT NULL\\r\\n        THEN (tvl_icms_estimado * taxa_selic) / 100.00\\r\\n        ELSE 0.00\\r\\n    END AS vl_juros,\\r\\n    \\r\\n    -- VL_MULTA (ACL: 20%)\\r\\n    CASE \\r\\n        WHEN tvl_icms_estimado > 0\\r\\n        THEN tvl_icms_estimado * 0.2\\r\\n        ELSE 0.00\\r\\n    END AS vl_multa\\r\\n\\r\\nFROM gessimples.bcadastro_icms_estimado_por_pa;\\r\\n\\r\\n-- Calcular VL_CT\\r\\nDROP TABLE IF EXISTS gessimples.bcadastro_icms_com_ct;\\r\\nCREATE TABLE gessimples.bcadastro_icms_com_ct STORED AS PARQUET AS\\r\\nSELECT \\r\\n    *,\\r\\n    \\r\\n    -- VL_CT (ACL)\\r\\n    CASE \\r\\n        WHEN vl_icms_estimado > 0.00\\r\\n        THEN vl_icms_estimado + vl_juros + vl_multa\\r\\n        ELSE 0.00\\r\\n    END AS vl_ct\\r\\n\\r\\nFROM gessimples.bcadastro_icms_estimado_filtrado;\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 4.3. CONSOLIDAR VL_CT POR CNPJ_RAIZ (SOMA DE TODOS OS PAs)\\r\\n-- ACL: TAB_ICMS_COBRAR\\r\\n-- ----------------------------------------------------------------------------\\r\\nDROP TABLE IF EXISTS gessimples.bcadastro_icms_cobrar;\\r\\nCREATE TABLE gessimples.bcadastro_icms_cobrar STORED AS PARQUET AS\\r\\nSELECT \\r\\n    cnpj_raiz,\\r\\n    cpf,\\r\\n    num_grupo,\\r\\n    uf,\\r\\n    \\r\\n    SUM(vl_icms_estimado) AS vl_icms_estimado_total,\\r\\n    SUM(vl_juros) AS vl_juros_total,\\r\\n    SUM(vl_multa) AS vl_multa_total,\\r\\n    SUM(vl_ct) AS vl_ct_total,\\r\\n    \\r\\n    CURRENT_TIMESTAMP() AS dt_carga\\r\\n\\r\\nFROM gessimples.bcadastro_icms_com_ct\\r\\nGROUP BY \\r\\n    cnpj_raiz,\\r\\n    cpf,\\r\\n    num_grupo,\\r\\n    uf;\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 4.4. TABELA FINAL - FORMATO ACL COMPLETO\\r\\n-- TAB_RESULTADO_FINAL_INC_TERC_SC\\r\\n-- ----------------------------------------------------------------------------\\r\\n\\r\\n-- Primeiro, criar uma tabela auxiliar com QTE_SOCIO por grupo\\r\\nDROP TABLE IF EXISTS gessimples.bcadastro_qte_socio_grupo;\\r\\nCREATE TABLE gessimples.bcadastro_qte_socio_grupo STORED AS PARQUET AS\\r\\nSELECT \\r\\n    num_grupo,\\r\\n    COUNT(DISTINCT cpf) AS qte_socio\\r\\nFROM gessimples.bcadastro_tab_raiz_cpf_pai\\r\\nWHERE num_grupo IS NOT NULL\\r\\nGROUP BY num_grupo;\\r\\n\\r\\n-- PASSO 1: Deduplica bcadastro_tab_periodo_rba (origem do problema)\\r\\nDROP TABLE IF EXISTS gessimples.bcadastro_tab_periodo_rba_clean;\\r\\nCREATE TABLE gessimples.bcadastro_tab_periodo_rba_clean STORED AS PARQUET AS\\r\\nSELECT \\r\\n    cnpj_raiz,\\r\\n    cpf,\\r\\n    pa,\\r\\n    num_grupo,\\r\\n    qte_cnpj,\\r\\n    pa_fato,\\r\\n    pa_fato_2021,\\r\\n    pa_fato_2022,\\r\\n    pa_fato_2023,\\r\\n    pa_fato_2024,\\r\\n    pa_fato_2025,\\r\\n    vl_rba_pgdas,\\r\\n    receita_pa_fato,\\r\\n    vl_icms,\\r\\n    vl_icms_12m,\\r\\n    vl_ativ,\\r\\n    vl_rpa_int,\\r\\n    pa_resp,\\r\\n    qualificacao,\\r\\n    dt_ini_qualificacao,\\r\\n    periodo_ini_sn,\\r\\n    periodo_fim_sn,\\r\\n    pa_fin_sn,\\r\\n    uf,\\r\\n    dt_carga\\r\\nFROM (\\r\\n    SELECT \\r\\n        *,\\r\\n        ROW_NUMBER() OVER (\\r\\n            PARTITION BY num_grupo, cnpj_raiz, cpf, pa_fato\\r\\n            ORDER BY vl_rba_pgdas DESC, receita_pa_fato DESC, pa DESC\\r\\n        ) AS rn\\r\\n    FROM gessimples.bcadastro_tab_periodo_rba\\r\\n) sub\\r\\nWHERE rn = 1;\\r\\n\\r\\n-- PASSO 2: Criar output final COM deduplica\\u00e7\\u00e3o adicional\\r\\nDROP TABLE IF EXISTS gessimples.bcadastro_output_final_acl;\\r\\nCREATE TABLE gessimples.bcadastro_output_final_acl STORED AS PARQUET AS\\r\\nWITH dados_base AS (\\r\\n    SELECT \\r\\n        -- Dados do Grupo\\r\\n        t.num_grupo AS NUM_GRUPO,\\r\\n        t.qte_cnpj AS QTE_CNPJ,\\r\\n        \\r\\n        -- QTE_SOCIO\\r\\n        COALESCE(qs.qte_socio, 0) AS QTE_SOCIO,\\r\\n        \\r\\n        -- Valores\\r\\n        COALESCE(ic.vl_ct_total, 0.00) AS VL_CT,\\r\\n        t.vl_rba_pgdas AS VL_RBA_PGDAS,\\r\\n        t.receita_pa_fato AS RECEITA_PA_FATO,\\r\\n        \\r\\n        -- Dados da Empresa\\r\\n        bc.cnpj_completo AS CNPJ,\\r\\n        t.cnpj_raiz AS CNPJ_RAIZ,\\r\\n        t.cpf AS CPF,\\r\\n        t.uf AS UF,\\r\\n        \\r\\n        -- Datas e Qualifica\\u00e7\\u00e3o\\r\\n        CAST(t.dt_ini_qualificacao AS STRING) AS DT_INI_QUALIFICACAO,\\r\\n        t.qualificacao AS QUALIFICACAO,\\r\\n        \\r\\n        -- Regime\\r\\n        CASE \\r\\n            WHEN t.pa_fin_sn IS NULL OR t.pa_fato <= t.pa_fin_sn\\r\\n            THEN 'SN'\\r\\n            ELSE 'NL'\\r\\n        END AS REGIME_NO_EFEITO,\\r\\n        \\r\\n        -- FLAG_PERIODO\\r\\n        CASE \\r\\n            WHEN t.pa_fato_2021 != 'SN' AND t.pa_fato_2022 = 'SN' THEN '21'\\r\\n            WHEN t.pa_fato_2021 != 'SN' AND t.pa_fato_2022 != 'SN' AND t.pa_fato_2023 = 'SN' THEN '21-22'\\r\\n            WHEN t.pa_fato_2021 != 'SN' AND t.pa_fato_2022 != 'SN' AND t.pa_fato_2023 != 'SN' AND t.pa_fato_2024 = 'SN' THEN '21-22-23'\\r\\n            WHEN t.pa_fato_2021 != 'SN' AND t.pa_fato_2022 != 'SN' AND t.pa_fato_2023 != 'SN' AND t.pa_fato_2024 != 'SN' AND t.pa_fato_2025 = 'SN' THEN '21-22-23-24'\\r\\n            WHEN t.pa_fato_2021 != 'SN' AND t.pa_fato_2022 != 'SN' AND t.pa_fato_2023 != 'SN' AND t.pa_fato_2024 != 'SN' AND t.pa_fato_2025 != 'SN' THEN '21-22-23-24-25'\\r\\n            WHEN t.pa_fato_2022 != 'SN' AND t.pa_fato_2023 = 'SN' THEN '22'\\r\\n            WHEN t.pa_fato_2022 != 'SN' AND t.pa_fato_2023 != 'SN' AND t.pa_fato_2024 = 'SN' THEN '22-23'\\r\\n            WHEN t.pa_fato_2022 != 'SN' AND t.pa_fato_2023 != 'SN' AND t.pa_fato_2024 != 'SN' AND t.pa_fato_2025 = 'SN' THEN '22-23-24'\\r\\n            WHEN t.pa_fato_2022 != 'SN' AND t.pa_fato_2023 != 'SN' AND t.pa_fato_2024 != 'SN' AND t.pa_fato_2025 != 'SN' THEN '22-23-24-25'\\r\\n            WHEN t.pa_fato_2023 != 'SN' AND t.pa_fato_2024 = 'SN' THEN '23'\\r\\n            WHEN t.pa_fato_2023 != 'SN' AND t.pa_fato_2024 != 'SN' AND t.pa_fato_2025 = 'SN' THEN '23-24'\\r\\n            WHEN t.pa_fato_2023 != 'SN' AND t.pa_fato_2024 != 'SN' AND t.pa_fato_2025 != 'SN' THEN '23-24-25'\\r\\n            WHEN t.pa_fato_2024 != 'SN' AND t.pa_fato_2025 = 'SN' THEN '24'\\r\\n            WHEN t.pa_fato_2024 != 'SN' AND t.pa_fato_2025 != 'SN' THEN '24-25'\\r\\n            WHEN t.pa_fato_2025 != 'SN' THEN '25'\\r\\n            ELSE 'TODOS'\\r\\n        END AS FLAG_PERIODO,\\r\\n        \\r\\n        -- Per\\u00edodos do Fato\\r\\n        t.pa_fato AS DT_FATO,\\r\\n        \\r\\n        -- DT_EFEITO\\r\\n        CASE \\r\\n            WHEN CAST(t.pa AS INT) % 100 = 12 \\r\\n            THEN CAST((CAST(t.pa AS INT) / 100 + 1) * 100 + 1 AS STRING)\\r\\n            ELSE CAST(CAST(t.pa AS INT) + 1 AS STRING)\\r\\n        END AS DT_EFEITO,\\r\\n        \\r\\n        t.pa_fato AS PA_FATO_INI,\\r\\n        CASE \\r\\n            WHEN t.pa_fin_sn IS NULL THEN '-'\\r\\n            ELSE t.pa_fin_sn\\r\\n        END AS PA_FATO_FIN,\\r\\n        \\r\\n        CASE \\r\\n            WHEN t.pa_fin_sn IS NULL THEN ''\\r\\n            ELSE t.pa_fin_sn\\r\\n        END AS PA_FIN_RESP,\\r\\n        \\r\\n        t.pa_resp AS PA_RESP,\\r\\n        \\r\\n        -- Chave \\u00fanica\\r\\n        CONCAT(\\r\\n            LPAD(t.cpf, 11, '0'),\\r\\n            LPAD(t.cnpj_raiz, 8, '0'),\\r\\n            t.pa_fato\\r\\n        ) AS CHAVE_CPF_RAIZ_PA,\\r\\n        \\r\\n        -- EMITE_TE_SC\\r\\n        CASE \\r\\n            WHEN t.uf = 'SC' \\r\\n                 AND (t.pa_fin_sn IS NULL OR t.pa_fato <= t.pa_fin_sn)\\r\\n                 AND COALESCE(ic.vl_ct_total, 0) > 0\\r\\n            THEN 'S'\\r\\n            ELSE 'N'\\r\\n        END AS EMITE_TE_SC,\\r\\n        \\r\\n        -- EMITE_TE\\r\\n        CASE \\r\\n            WHEN (t.pa_fin_sn IS NULL OR t.pa_fato <= t.pa_fin_sn)\\r\\n                 AND COALESCE(ic.vl_ct_total, 0) > 0\\r\\n            THEN 'S'\\r\\n            ELSE 'N'\\r\\n        END AS EMITE_TE,\\r\\n        \\r\\n        -- ACAO\\r\\n        CASE \\r\\n            WHEN COALESCE(ic.vl_ct_total, 0) > 0 \\r\\n                 AND t.uf = 'SC'\\r\\n                 AND (t.pa_fin_sn IS NULL OR t.pa_fato <= t.pa_fin_sn)\\r\\n            THEN 'EXCLUSAO_COM_DEBITO'\\r\\n            WHEN COALESCE(ic.vl_ct_total, 0) = 0 \\r\\n                 AND t.uf = 'SC'\\r\\n                 AND (t.pa_fin_sn IS NULL OR t.pa_fato <= t.pa_fin_sn)\\r\\n            THEN 'EXCLUSAO_SEM_DEBITO'\\r\\n            ELSE 'SEM_INTERESSE'\\r\\n        END AS ACAO,\\r\\n        \\r\\n        -- Campos adicionais\\r\\n        bc.razao_social AS RAZAO_SOCIAL,\\r\\n        bc.situacao_cadastral_desc AS SITUACAO_CADASTRAL,\\r\\n        \\r\\n        CURRENT_TIMESTAMP() AS DT_PROCESSAMENTO,\\r\\n        \\r\\n        -- Campo auxiliar para deduplica\\u00e7\\u00e3o final\\r\\n        ROW_NUMBER() OVER (\\r\\n            PARTITION BY t.num_grupo, t.cnpj_raiz\\r\\n            ORDER BY \\r\\n                COALESCE(ic.vl_ct_total, 0) DESC,\\r\\n                t.receita_pa_fato DESC,\\r\\n                t.pa_fato DESC\\r\\n        ) AS row_num\\r\\n        \\r\\n    FROM gessimples.bcadastro_tab_periodo_rba_clean t\\r\\n    INNER JOIN gessimples.bcadastro_base_cnpj_completo bc\\r\\n        ON t.cnpj_raiz = bc.cnpj_raiz\\r\\n    LEFT JOIN gessimples.bcadastro_icms_cobrar ic\\r\\n        ON t.cnpj_raiz = ic.cnpj_raiz\\r\\n        AND t.cpf = ic.cpf\\r\\n        AND t.num_grupo = ic.num_grupo\\r\\n    LEFT JOIN gessimples.bcadastro_qte_socio_grupo qs\\r\\n        ON t.num_grupo = qs.num_grupo\\r\\n)\\r\\nSELECT \\r\\n    NUM_GRUPO,\\r\\n    QTE_CNPJ,\\r\\n    QTE_SOCIO,\\r\\n    VL_CT,\\r\\n    VL_RBA_PGDAS,\\r\\n    RECEITA_PA_FATO,\\r\\n    CNPJ,\\r\\n    CNPJ_RAIZ,\\r\\n    CPF,\\r\\n    UF,\\r\\n    DT_INI_QUALIFICACAO,\\r\\n    QUALIFICACAO,\\r\\n    REGIME_NO_EFEITO,\\r\\n    FLAG_PERIODO,\\r\\n    DT_FATO,\\r\\n    DT_EFEITO,\\r\\n    PA_FATO_INI,\\r\\n    PA_FATO_FIN,\\r\\n    PA_FIN_RESP,\\r\\n    PA_RESP,\\r\\n    CHAVE_CPF_RAIZ_PA,\\r\\n    EMITE_TE_SC,\\r\\n    EMITE_TE,\\r\\n    ACAO,\\r\\n    RAZAO_SOCIAL,\\r\\n    SITUACAO_CADASTRAL,\\r\\n    DT_PROCESSAMENTO\\r\\nFROM dados_base\\r\\nWHERE row_num = 1;  -- <<< DEDUPLICA\\u00c7\\u00c3O FINAL AQUI\\r\\n\\r\\n-- ----------------------------------------------------------------------------\\r\\n-- 4.5. ESTAT\\u00cdSTICAS FINAIS\\r\\n-- ----------------------------------------------------------------------------\\r\\nSELECT \\r\\n    'ESTAT\\u00cdSTICAS GERAIS' AS categoria,\\r\\n    COUNT(*) AS total_registros,\\r\\n    COUNT(DISTINCT NUM_GRUPO) AS total_grupos,\\r\\n    COUNT(DISTINCT CNPJ_RAIZ) AS total_empresas,\\r\\n    COUNT(DISTINCT CPF) AS total_socios\\r\\nFROM gessimples.bcadastro_output_final_acl\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    'POR A\\u00c7\\u00c3O' AS categoria,\\r\\n    CAST(NULL AS BIGINT) AS total_registros,\\r\\n    CAST(NULL AS BIGINT) AS total_grupos,\\r\\n    CAST(NULL AS BIGINT) AS total_empresas,\\r\\n    CAST(NULL AS BIGINT) AS total_socios\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    CONCAT('  ', ACAO) AS categoria,\\r\\n    COUNT(*) AS total_registros,\\r\\n    COUNT(DISTINCT NUM_GRUPO) AS total_grupos,\\r\\n    COUNT(DISTINCT CNPJ_RAIZ) AS total_empresas,\\r\\n    COUNT(DISTINCT CPF) AS total_socios\\r\\nFROM gessimples.bcadastro_output_final_acl\\r\\nGROUP BY ACAO\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    'POR FLAG_PERIODO' AS categoria,\\r\\n    CAST(NULL AS BIGINT) AS total_registros,\\r\\n    CAST(NULL AS BIGINT) AS total_grupos,\\r\\n    CAST(NULL AS BIGINT) AS total_empresas,\\r\\n    CAST(NULL AS BIGINT) AS total_socios\\r\\n\\r\\nUNION ALL\\r\\n\\r\\nSELECT \\r\\n    CONCAT('  ', FLAG_PERIODO) AS categoria,\\r\\n    COUNT(*) AS total_registros,\\r\\n    COUNT(DISTINCT NUM_GRUPO) AS total_grupos,\\r\\n    COUNT(DISTINCT CNPJ_RAIZ) AS total_empresas,\\r\\n    COUNT(DISTINCT CPF) AS total_socios\\r\\nFROM gessimples.bcadastro_output_final_acl\\r\\nGROUP BY FLAG_PERIODO;\", \"result\": {\"id\": \"b688bb09-bbc8-b40a-617a-810981718220\", \"type\": \"table\", \"hasResultset\": true, \"handle\": {\"secret\": \"sRPP64McSHW1Qq/tgvbVkA==\", \"guid\": \"7xro8s+FSocAAAAAf2USUw==\", \"operation_type\": 0, \"has_result_set\": true, \"modified_row_count\": null, \"log_context\": null, \"session_guid\": \"c4418419d7ed1cbd:1bb36ce8990349a8\", \"session_id\": 21854, \"session_type\": \"impala\", \"statement_id\": 0, \"has_more_statements\": false, \"statements_count\": 1, \"previous_statement_hash\": \"efb30ec24765285ce3f7253fb91434999007b1d058cffaccb456f877\", \"start\": {\"row\": 0, \"column\": 0}, \"end\": {\"row\": 0, \"column\": 1359}, \"statement\": \"-- Op\\u00e7\\u00e3o alternativa com ordena\\u00e7\\u00e3o (usando subquery)\\r\\nSELECT * FROM (\\r\\n    SELECT \\r\\n        'ESTAT\\u00cdSTICAS GERAIS' AS categoria,\\r\\n        COUNT(*) AS total_registros,\\r\\n        COUNT(DISTINCT NUM_GRUPO) AS total_grupos,\\r\\n        COUNT(DISTINCT CNPJ_RAIZ) AS total_empresas,\\r\\n        COUNT(DISTINCT CPF) AS total_socios,\\r\\n        1 AS ordem\\r\\n    FROM gessimples.bcadastro_output_final_acl\\r\\n\\r\\n    UNION ALL\\r\\n\\r\\n    SELECT \\r\\n        'POR A\\u00c7\\u00c3O',\\r\\n        CAST(NULL AS BIGINT),\\r\\n        CAST(NULL AS BIGINT),\\r\\n        CAST(NULL AS BIGINT),\\r\\n        CAST(NULL AS BIGINT),\\r\\n        2\\r\\n\\r\\n    UNION ALL\\r\\n\\r\\n    SELECT \\r\\n        CONCAT('  ', ACAO),\\r\\n        COUNT(*),\\r\\n        COUNT(DISTINCT NUM_GRUPO),\\r\\n        COUNT(DISTINCT CNPJ_RAIZ),\\r\\n        COUNT(DISTINCT CPF),\\r\\n        3\\r\\n    FROM gessimples.bcadastro_output_final_acl\\r\\n    GROUP BY ACAO\\r\\n\\r\\n    UNION ALL\\r\\n\\r\\n    SELECT \\r\\n        'POR FLAG_PERIODO',\\r\\n        CAST(NULL AS BIGINT),\\r\\n        CAST(NULL AS BIGINT),\\r\\n        CAST(NULL AS BIGINT),\\r\\n        CAST(NULL AS BIGINT),\\r\\n        4\\r\\n\\r\\n    UNION ALL\\r\\n\\r\\n    SELECT \\r\\n        CONCAT('  ', FLAG_PERIODO),\\r\\n        COUNT(*),\\r\\n        COUNT(DISTINCT NUM_GRUPO),\\r\\n        COUNT(DISTINCT CNPJ_RAIZ),\\r\\n        COUNT(DISTINCT CPF),\\r\\n        5\\r\\n    FROM gessimples.bcadastro_output_final_acl\\r\\n    GROUP BY FLAG_PERIODO\\r\\n) resultado\\r\\nORDER BY ordem, total_registros DESC\"}, \"meta\": [], \"rows\": 21, \"hasMore\": false, \"statement_id\": 0, \"statement_range\": {\"start\": {\"row\": 0, \"column\": 0}, \"end\": {\"row\": 0, \"column\": 0}}, \"statements_count\": 1, \"previous_statement_hash\": null, \"metaFilter\": {\"query\": \"\", \"facets\": {}, \"text\": []}, \"isMetaFilterVisible\": false, \"filteredMetaChecked\": true, \"filteredColumnCount\": -1, \"filteredMeta\": [], \"fetchedOnce\": false, \"startTime\": \"2025-10-21T12:33:28.761Z\", \"endTime\": \"2025-10-21T12:33:30.134Z\", \"executionTime\": 1373, \"data\": [], \"explanation\": \"\", \"logs\": \"\", \"logLines\": 0, \"hasSomeResults\": false}, \"showGrid\": true, \"showChart\": false, \"showLogs\": true, \"progress\": 0, \"jobs\": [], \"executeNextTimeout\": -1, \"isLoading\": false, \"resultsKlass\": \"results impala\", \"errorsKlass\": \"results impala alert alert-error\", \"is_redacted\": false, \"chartType\": \"bars\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null, \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartLimits\": [5, 10, 25, 50, 100], \"chartLimit\": null, \"chartX\": \"categoria\", \"chartXPivot\": null, \"chartYSingle\": null, \"chartYMulti\": [\"total_grupos\"], \"chartData\": [], \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"hideStacked\": true, \"hasDataForChart\": true, \"previousChartOptions\": {\"chartLimit\": null, \"chartX\": \"categoria\", \"chartXPivot\": null, \"chartYSingle\": null, \"chartMapType\": \"marker\", \"chartMapLabel\": null, \"chartMapHeat\": null, \"chartYMulti\": [\"total_grupos\"], \"chartScope\": \"world\", \"chartTimelineType\": \"bar\", \"chartSorting\": \"none\", \"chartScatterGroup\": null, \"chartScatterSize\": null}, \"isResultSettingsVisible\": false, \"settingsVisible\": false, \"checkStatusTimeout\": null, \"getLogsTimeout\": null, \"topRisk\": null, \"suggestion\": \"\", \"hasSuggestion\": null, \"compatibilityCheckRunning\": false, \"compatibilitySourcePlatforms\": [{\"name\": \"Teradata\", \"value\": \"teradata\"}, {\"name\": \"Oracle\", \"value\": \"oracle\"}, {\"name\": \"Netezza\", \"value\": \"netezza\"}, {\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}, {\"name\": \"DB2\", \"value\": \"db2\"}, {\"name\": \"Greenplum\", \"value\": \"greenplum\"}, {\"name\": \"MySQL\", \"value\": \"mysql\"}, {\"name\": \"PostgreSQL\", \"value\": \"postgresql\"}, {\"name\": \"Informix\", \"value\": \"informix\"}, {\"name\": \"SQL Server\", \"value\": \"sqlserver\"}, {\"name\": \"Sybase\", \"value\": \"sybase\"}, {\"name\": \"Access\", \"value\": \"access\"}, {\"name\": \"Firebird\", \"value\": \"firebird\"}, {\"name\": \"ANSISQL\", \"value\": \"ansisql\"}, {\"name\": \"Generic\", \"value\": \"generic\"}], \"compatibilitySourcePlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"compatibilityTargetPlatforms\": [{\"name\": \"Impala\", \"value\": \"impala\"}, {\"name\": \"Hive\", \"value\": \"hive\"}], \"compatibilityTargetPlatform\": {\"name\": \"Impala\", \"value\": \"impala\"}, \"showSqlAnalyzer\": false, \"wasBatchExecuted\": false, \"isReady\": true, \"lastExecuted\": 1761050008474, \"lastAceSelectionRowOffset\": 390, \"executingBlockingOperation\": null, \"showLongOperationWarning\": false, \"formatEnabled\": true, \"isFetchingData\": false, \"isCanceling\": false, \"aceAutoExpand\": false}], \"selectedSnippet\": \"impala\", \"creatingSessionLocks\": [], \"sessions\": [], \"directoryUuid\": \"\", \"dependentsCoordinator\": [], \"historyFilter\": \"\", \"historyFilterVisible\": false, \"loadingHistory\": false, \"historyInitialHeight\": 78, \"forceHistoryInitialHeight\": false, \"historyCurrentPage\": 1, \"historyTotalPages\": 154, \"schedulerViewModel\": null, \"schedulerViewModelIsLoaded\": false, \"isBatchable\": true, \"isExecutingAll\": false, \"executingAllIndex\": 0, \"retryModalConfirm\": null, \"retryModalCancel\": null, \"canSave\": true, \"unloaded\": false, \"updateHistoryFailed\": false, \"viewSchedulerId\": \"\", \"loadingScheduler\": false}",
    "extra": "",
    "search": "-- ============================================================================\r\n-- SCRIPT 04: OUTPUT FINAL - 100% FORMATO ACL\r\n-- Tempo estimado: 15-20 minutos\r\n-- Baseado em: TAB_RESULTADO_FINAL_INC_TERC_SC do ACL\r\n-- Inclui cálculo de VL_CT (Crédito Tributário) com SELIC\r\n-- ============================================================================\r\n\r\n-- ----------------------------------------------------------------------------\r\n-- 4.1. IMPORTAR TABELA SELIC\r\n-- ----------------------------------------------------------------------------\r\nDROP TABLE IF EXISTS gessimples.bcadastro_selic;\r\nCREATE TABLE gessimples.bcadastro_selic STORED AS PARQUET AS\r\nSELECT \r\n    tis_referencia AS pa,\r\n    tis_vl_indice AS taxa_selic\r\nFROM usr_sat_ctacte.tab_indice\r\nWHERE tid_nom_indice = 'SELIC'\r\n  AND tis_referencia >= 202101\r\n  AND tis_referencia <= 202512;\r\n\r\n-- ----------------------------------------------------------------------------\r\n-- 4.2. CALCULAR ICMS ESTIMADO E VL_CT POR CNPJ+PA\r\n-- ACL: tVL_ICMS_ESTIMADO, VL_JUROS, VL_MULTA, VL_CT\r\n-- ----------------------------------------------------------------------------\r\nDROP TABLE IF EXISTS gessimples.bcadastro_icms_estimado_por_pa;\r\nCREATE TABLE gessimples.bcadastro_icms_estimado_por_pa STORED AS PARQUET AS\r\nSELECT \r\n    r.cnpj_raiz,\r\n    r.cpf,\r\n    r.pa,\r\n    r.num_grupo,\r\n    r.pa_resp,\r\n    r.pa_fato,\r\n    r.uf,\r\n    r.vl_ativ,\r\n    r.vl_icms,\r\n    r.pa_fin_sn,\r\n    \r\n    -- Qtde meses retroativos (placeholder - calcular depois)\r\n    0 AS qte_mes_retroativo,\r\n    \r\n    -- tVL_ICMS_ESTIMADO (ACL)\r\n    CASE \r\n        WHEN r.vl_icms > 0.00\r\n             AND r.pa_resp <= CAST(r.pa AS STRING)\r\n             AND r.pa_resp <= r.pa_fato\r\n             AND r.uf = 'SC'\r\n        THEN ((r.vl_ativ * 0.07) - r.vl_icms)\r\n        ELSE 0.00\r\n    END AS tvl_icms_estimado,\r\n    \r\n    s.taxa_selic,\r\n    \r\n    CURRENT_TIMESTAMP() AS dt_carga\r\n\r\nFROM gessimples.bcadastro_tab_periodo_rba r  -- <-- MUDANÇA AQUI\r\nLEFT JOIN gessimples.bcadastro",
    "last_modified": "2025-10-23T21:51:51.831",
    "version": 1,
    "is_history": false,
    "is_managed": false,
    "is_trashed": false,
    "parent_directory": [
      "38597e6c-aa1b-4e22-9133-e97cdfaf3585",
      1,
      false
    ],
    "dependencies": []
  }
}
]
